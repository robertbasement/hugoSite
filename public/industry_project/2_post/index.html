<!DOCTYPE html>



<html class="no-js" lang="en">


<head><script src="/hugoSite/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=hugoSite/livereload" data-no-instant defer></script>

    
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="author" content="">

    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/vendor.css">
    <link rel="stylesheet" href="../../css/main.css">


    
    

    <script src="../../js/modernizr.js"></script>
    <script src="../../js/pace.min.js"></script>
    
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

</head>

<body id="top">
        
    
    
    
    
     <header class="s-header">
        <div class="header-logo">
            <a class="site-logo" href="../../"><img src="../../images/logo.png" alt="Homepage"></a>
        </div>

        <nav class="header-nav-wrap">
            <ul class="header-nav">
                <li><a href="../../#home" title="home">Home</a></li>
                <li><a href="../../#about" title="about">About</a></li>
                <li><a href="../../#works" title="works">Works</a></li>
                <li><a href="../../#blog" title="works">Blog Section</a></li>
                <li class="current"><a href="../../blog/" title="blog">Blog</a></li>
                
            </ul>
        </nav>

        <a class="header-menu-toggle" href="#0"><span>Menu</span></a>
    </header>
    

    <main>
        

    <article class="blog-single">

        <div class="page-header page-header--single page-hero" style="background-image:url(/images/blog/blog-bg-02.jpg)">
            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                            
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">January 1, 0001</li>
                        <li class="author">
                            By <span></span>
                        </li>
                    </ul>
                </article>
            </div>
        </div>

        <div class="row blog-content">
            <div class="col-full blog-content__main">
                <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pd<span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>float_format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>SUB_TICKERS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;2059&#39;</span>, <span style="color:#e6db74">&#39;3529&#39;</span>, <span style="color:#e6db74">&#39;2383&#39;</span>, <span style="color:#e6db74">&#39;2330&#39;</span>, <span style="color:#e6db74">&#39;8069&#39;</span>, <span style="color:#e6db74">&#39;5274&#39;</span>, <span style="color:#e6db74">&#39;3008&#39;</span>, <span style="color:#e6db74">&#39;2454&#39;</span>, <span style="color:#e6db74">&#39;3533&#39;</span>]
</span></span></code></pre></div><h2 id="月營收">月營收</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mon_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/monthly/monthly_revenue.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mon_df <span style="color:#f92672">=</span> mon_df[mon_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span><span style="display:flex;"><span>mon_df <span style="color:#f92672">=</span> mon_df[<span style="color:#f92672">~</span>mon_df[<span style="color:#e6db74">&#39;公告日&#39;</span>]<span style="color:#f92672">.</span>isna()]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mon_df[<span style="color:#e6db74">&#39;公告日_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(mon_df[<span style="color:#e6db74">&#39;公告日&#39;</span>])
</span></span><span style="display:flex;"><span>mon_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;公告日_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>mon_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="收盤價">收盤價</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/org_price.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050 <span style="color:#f92672">=</span> price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;0050&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price0050[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>price0050<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price0050<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1320320034.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050['日期_dt'] = pd.to_datetime(price0050['日期'])
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1320320034.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050.sort_values('日期_dt', inplace=True, ascending=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price_df[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">holding_nDays</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span>n) <span style="color:#f92672">/</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#75715e"># 實際上隔日才能操作</span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;last_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>shift(n <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#75715e"># 實際上隔日才能操作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(holding_nDays)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/392270890.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050 <span style="color:#f92672">=</span> price0050<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(holding_nDays)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2395123834.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price0050 = price0050.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(price0050, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), suffixes<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;_0050&#39;</span>))
</span></span></code></pre></div><h2 id="融資">融資</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>margin_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/dayMarginTrading.ftr&#39;</span>, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;資餘&#39;</span>, <span style="color:#e6db74">&#39;券餘&#39;</span>, <span style="color:#e6db74">&#39;券資比&#39;</span>, <span style="color:#e6db74">&#39;當沖比率&#39;</span>, <span style="color:#e6db74">&#39;融資成本(推估)&#39;</span>, <span style="color:#e6db74">&#39;融券成本(推估)&#39;</span>, <span style="color:#e6db74">&#39;融資維持率(%)&#39;</span>, <span style="color:#e6db74">&#39;融券維持率(%)&#39;</span>,<span style="color:#e6db74">&#39;整體維持率(%)&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(margin_df, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>] <span style="color:#f92672">=</span> ((price_df[<span style="color:#e6db74">&#39;融資維持率(%)&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.6</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span><span style="color:#ae81ff">100</span>
</span></span></code></pre></div><h2 id="週集保">週集保</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/weeklyDepository.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie <span style="color:#f92672">=</span> weekly_depostie[weekly_depostie[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>weekly_depostie<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg <span style="color:#f92672">=</span> weekly_depostie[weekly_depostie[<span style="color:#e6db74">&#39;持股分級&#39;</span>]<span style="color:#f92672">.</span>isin([<span style="color:#e6db74">&#39;0400001-0600000&#39;</span>, <span style="color:#e6db74">&#39;0600001-0800000&#39;</span>, <span style="color:#e6db74">&#39;0800001-1000000&#39;</span>, <span style="color:#e6db74">&#39;1000001以上&#39;</span>])]<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>to_frame()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> company_event[company_event[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>date_pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;^\d</span><span style="color:#e6db74">{8}</span><span style="color:#e6db74">$&#39;</span>
</span></span><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> company_event[company_event[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(date_pattern)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(company_event[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;friday_of_week&#39;</span>] <span style="color:#f92672">=</span> company_event[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">+</span> pd<span style="color:#f92672">.</span>offsets<span style="color:#f92672">.</span>Week(weekday<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;adjust_week&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>company_event<span style="color:#f92672">.</span>loc[(company_event[<span style="color:#e6db74">&#39;新股上市&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#f92672">|</span> (company_event[<span style="color:#e6db74">&#39;減資前&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#39;adjust_week&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(agg[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;year&#39;</span>] <span style="color:#f92672">=</span> agg[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保月線&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保半年線&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保diff&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>diff()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>merge(company_event<span style="color:#f92672">.</span>loc[company_event[<span style="color:#e6db74">&#39;adjust_week&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, [<span style="color:#e6db74">&#39;friday_of_week&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;減資前&#39;</span>, <span style="color:#e6db74">&#39;新股上市&#39;</span>, <span style="color:#e6db74">&#39;adjust_week&#39;</span>]], how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;friday_of_week&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 有股數異動 當周週集保diff -&gt; 0</span>
</span></span><span style="display:flex;"><span>agg<span style="color:#f92672">.</span>loc[agg[<span style="color:#e6db74">&#39;adjust_week&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;週集保diff&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;週集保diff&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(agg, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;cut&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>qcut(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>], <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) 
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;signal_count&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>res
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>merge(price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>), how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;股票代號&#39;</span>), right_on<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;股票代號&#39;</span>), suffixes<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;_baseline&#39;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;diff_ret&#39;</span>] <span style="color:#f92672">=</span> res[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>] <span style="color:#f92672">-</span> res[<span style="color:#e6db74">&#39;hold_20Days_ret_baseline&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    print(res<span style="color:#f92672">.</span>loc[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker, [<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;diff_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_count&#39;</span>]])
</span></span></code></pre></div><pre><code>                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
0      (-7.381, -0.0403]  2059    0.0074               0.5253           297
9     (-0.0403, -0.0209]  2059   -0.0003               0.5539           612
18    (-0.0209, -0.0112]  2059   -0.0105               0.5278           612
27   (-0.0112, -0.00457]  2059    0.0055               0.6105           493
36  (-0.00457, 0.000588]  2059   -0.0055               0.5302           464
45    (0.000588, 0.0064]  2059   -0.0165               0.5211           474
54      (0.0064, 0.0132]  2059   -0.0066               0.5511           470
63      (0.0132, 0.0236]  2059    0.0048               0.5630           579
72      (0.0236, 0.0459]  2059    0.0154               0.4592           368
81       (0.0459, 6.477]  2059   -0.0042               0.4848           330
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
5      (-7.381, -0.0403]  3529    0.0076               0.5681           639
14    (-0.0403, -0.0209]  3529    0.0057               0.5977           430
23    (-0.0209, -0.0112]  3529    0.0197               0.6016           251
32   (-0.0112, -0.00457]  3529   -0.0115               0.4541           185
41  (-0.00457, 0.000588]  3529   -0.0182               0.4237           118
50    (0.000588, 0.0064]  3529    0.0286               0.5524           105
59      (0.0064, 0.0132]  3529    0.0080               0.5088           114
68      (0.0132, 0.0236]  3529    0.0233               0.6364           132
77      (0.0236, 0.0459]  3529   -0.0101               0.5516           368
86       (0.0459, 6.477]  3529   -0.0001               0.5152           924
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
2      (-7.381, -0.0403]  2383   -0.0163               0.5163           337
11    (-0.0403, -0.0209]  2383   -0.0155               0.6022           450
20    (-0.0209, -0.0112]  2383    0.0208               0.5992           509
29   (-0.0112, -0.00457]  2383    0.0109               0.6031           456
38  (-0.00457, 0.000588]  2383   -0.0056               0.5408           845
47    (0.000588, 0.0064]  2383    0.0085               0.5935           866
56      (0.0064, 0.0132]  2383    0.0112               0.5605           860
65      (0.0132, 0.0236]  2383   -0.0099               0.4559           601
74      (0.0236, 0.0459]  2383    0.0042               0.4363           314
83       (0.0459, 6.477]  2383    0.0311               0.5296           287
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
1      (-7.381, -0.0403]  2330   -0.0388               0.4315           788
10    (-0.0403, -0.0209]  2330    0.0045               0.5472           424
19    (-0.0209, -0.0112]  2330   -0.0026               0.5797           364
28   (-0.0112, -0.00457]  2330    0.0076               0.6842           741
37  (-0.00457, 0.000588]  2330   -0.0034               0.6103           839
46    (0.000588, 0.0064]  2330   -0.0058               0.5833           768
55      (0.0064, 0.0132]  2330   -0.0045               0.6129           824
64      (0.0132, 0.0236]  2330    0.0027               0.6062           617
73      (0.0236, 0.0459]  2330    0.0221               0.6621           441
82       (0.0459, 6.477]  2330   -0.0033               0.5289           484
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
8      (-7.381, -0.0403]  8069   -0.0083               0.4898           786
17    (-0.0403, -0.0209]  8069    0.0377               0.6390           313
26    (-0.0209, -0.0112]  8069    0.0130               0.5763           321
35   (-0.0112, -0.00457]  8069   -0.0059               0.5538           316
44  (-0.00457, 0.000588]  8069    0.0035               0.5430           256
53    (0.000588, 0.0064]  8069   -0.0044               0.5430           291
62      (0.0064, 0.0132]  8069    0.0173               0.6335           352
71      (0.0132, 0.0236]  8069    0.0035               0.5276           381
80      (0.0236, 0.0459]  8069   -0.0176               0.4596           594
89       (0.0459, 6.477]  8069   -0.0020               0.5591           744
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
7      (-7.381, -0.0403]  5274    0.0202               0.6256           438
16    (-0.0403, -0.0209]  5274   -0.0428               0.5028           179
25    (-0.0209, -0.0112]  5274   -0.0071               0.6331           169
34   (-0.0112, -0.00457]  5274    0.0072               0.6823           192
43  (-0.00457, 0.000588]  5274    0.0079               0.6508           126
52    (0.000588, 0.0064]  5274    0.0453               0.7287           129
61      (0.0064, 0.0132]  5274    0.0348               0.7063           160
70      (0.0132, 0.0236]  5274    0.0197               0.6702           188
79      (0.0236, 0.0459]  5274    0.0036               0.6394           416
88       (0.0459, 6.477]  5274   -0.0205               0.5478           712
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
4      (-7.381, -0.0403]  3008    0.0105               0.4967           449
13    (-0.0403, -0.0209]  3008    0.0191               0.6574           788
22    (-0.0209, -0.0112]  3008    0.0128               0.6181           720
31   (-0.0112, -0.00457]  3008    0.0030               0.5690           652
40  (-0.00457, 0.000588]  3008   -0.0275               0.4177           565
49    (0.000588, 0.0064]  3008   -0.0320               0.3731           453
58      (0.0064, 0.0132]  3008   -0.0063               0.4907           377
67      (0.0132, 0.0236]  3008    0.0032               0.5278           485
76      (0.0236, 0.0459]  3008   -0.0048               0.5455           627
85       (0.0459, 6.477]  3008    0.0236               0.5260           365
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
3      (-7.381, -0.0403]  2454   -0.0014               0.5589           433
12    (-0.0403, -0.0209]  2454   -0.0161               0.4977           663
21    (-0.0209, -0.0112]  2454    0.0020               0.6016           728
30   (-0.0112, -0.00457]  2454   -0.0285               0.4292           643
39  (-0.00457, 0.000588]  2454    0.0040               0.5687           466
48    (0.000588, 0.0064]  2454    0.0165               0.6183           503
57      (0.0064, 0.0132]  2454   -0.0053               0.5879           512
66      (0.0132, 0.0236]  2454    0.0106               0.6314           681
75      (0.0236, 0.0459]  2454   -0.0067               0.5551           726
84       (0.0459, 6.477]  2454   -0.0048               0.5616           276
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
6      (-7.381, -0.0403]  3533   -0.0589               0.2222            36
15    (-0.0403, -0.0209]  3533    0.0147               0.6366           344
24    (-0.0209, -0.0112]  3533    0.0306               0.6929           521
33   (-0.0112, -0.00457]  3533   -0.0040               0.5455           528
42  (-0.00457, 0.000588]  3533   -0.0483               0.3852           527
51    (0.000588, 0.0064]  3533   -0.0313               0.4356           606
60      (0.0064, 0.0132]  3533    0.0060               0.5898           529
69      (0.0132, 0.0236]  3533    0.0259               0.6311           534
78      (0.0236, 0.0459]  3533    0.0143               0.4725           345
87       (0.0459, 6.477]  3533    0.1118               0.8333            78
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample data</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;date&#39;</span>: pd<span style="color:#f92672">.</span>date_range(start<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2025-01-01&#39;</span>, periods<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>),  <span style="color:#75715e"># 20 consecutive dates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;value&#39;</span>: [i <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>)]  <span style="color:#75715e"># Example values (can be any time series data)</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert to a DataFrame</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert date to numeric (e.g., number of days since the first date)</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;date&#39;</span>] <span style="color:#f92672">-</span> df[<span style="color:#e6db74">&#39;date&#39;</span>]<span style="color:#f92672">.</span>min())<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>days
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to calculate slope for a window</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_slope</span>(window):
</span></span><span style="display:flex;"><span>    date_numeric <span style="color:#f92672">=</span> window[:, <span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Extract the first column (date_numeric)</span>
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> window[:, <span style="color:#ae81ff">1</span>]         <span style="color:#75715e"># Extract the second column (value)</span>
</span></span><span style="display:flex;"><span>    x_diff <span style="color:#f92672">=</span> date_numeric[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> date_numeric[<span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Time difference</span>
</span></span><span style="display:flex;"><span>    y_diff <span style="color:#f92672">=</span> value[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> value[<span style="color:#ae81ff">0</span>]                <span style="color:#75715e"># Value difference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y_diff <span style="color:#f92672">/</span> x_diff <span style="color:#66d9ef">if</span> x_diff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply rolling window calculation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_slope</span>(df, window_size):
</span></span><span style="display:flex;"><span>    slopes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(df) <span style="color:#f92672">-</span> window_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        window <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i:i <span style="color:#f92672">+</span> window_size][[<span style="color:#e6db74">&#39;date_numeric&#39;</span>, <span style="color:#e6db74">&#39;value&#39;</span>]]<span style="color:#f92672">.</span>to_numpy()
</span></span><span style="display:flex;"><span>        slopes<span style="color:#f92672">.</span>append(calculate_slope(window))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [<span style="color:#66d9ef">None</span>] <span style="color:#f92672">*</span> (window_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> slopes  <span style="color:#75715e"># Fill the start with NaNs for alignment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add slope to the DataFrame</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;slope&#39;</span>] <span style="color:#f92672">=</span> rolling_slope(df, window_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output the result</span>
</span></span><span style="display:flex;"><span>print(df)
</span></span></code></pre></div><pre><code>         date  value  date_numeric   slope
0  2025-01-01      0             0     NaN
1  2025-01-02      1             1     NaN
2  2025-01-03      4             2     NaN
3  2025-01-04      9             3     NaN
4  2025-01-05     16             4  4.0000
5  2025-01-06     25             5  6.0000
6  2025-01-07     36             6  8.0000
7  2025-01-08     49             7 10.0000
8  2025-01-09     64             8 12.0000
9  2025-01-10     81             9 14.0000
10 2025-01-11    100            10 16.0000
11 2025-01-12    121            11 18.0000
12 2025-01-13    144            12 20.0000
13 2025-01-14    169            13 22.0000
14 2025-01-15    196            14 24.0000
15 2025-01-16    225            15 26.0000
16 2025-01-17    256            16 28.0000
17 2025-01-18    289            17 30.0000
18 2025-01-19    324            18 32.0000
19 2025-01-20    361            19 34.0000
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample data</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;date&#39;</span>: pd<span style="color:#f92672">.</span>date_range(start<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2025-01-01&#39;</span>, periods<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>),  <span style="color:#75715e"># 20 consecutive dates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;value&#39;</span>: [i <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>)]  <span style="color:#75715e"># Example values (can be any time series data)</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert to a DataFrame</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert date to numeric (e.g., number of days since the first date)</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;date&#39;</span>] <span style="color:#f92672">-</span> df[<span style="color:#e6db74">&#39;date&#39;</span>]<span style="color:#f92672">.</span>min())<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>days
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to calculate slope for a window</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_slope</span>(window_df):
</span></span><span style="display:flex;"><span>    x_diff <span style="color:#f92672">=</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Time difference</span>
</span></span><span style="display:flex;"><span>    y_diff <span style="color:#f92672">=</span> window_df[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]               <span style="color:#75715e"># Value difference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y_diff <span style="color:#f92672">/</span> x_diff <span style="color:#66d9ef">if</span> x_diff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply rolling window calculation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_slope</span>(df, window_size):
</span></span><span style="display:flex;"><span>    slopes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(df) <span style="color:#f92672">-</span> window_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        window <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i:i <span style="color:#f92672">+</span> window_size]  <span style="color:#75715e"># Get the rolling window as a DataFrame</span>
</span></span><span style="display:flex;"><span>        slopes<span style="color:#f92672">.</span>append(calculate_slope(window))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [<span style="color:#66d9ef">None</span>] <span style="color:#f92672">*</span> (window_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> slopes  <span style="color:#75715e"># Fill the start with NaNs for alignment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add slope to the DataFrame</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;slope&#39;</span>] <span style="color:#f92672">=</span> rolling_slope(df, window_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output the result</span>
</span></span><span style="display:flex;"><span>print(df)
</span></span></code></pre></div><pre><code>         date  value  date_numeric   slope
0  2025-01-01      0             0     NaN
1  2025-01-02      1             1     NaN
2  2025-01-03      4             2     NaN
3  2025-01-04      9             3     NaN
4  2025-01-05     16             4  4.0000
5  2025-01-06     25             5  6.0000
6  2025-01-07     36             6  8.0000
7  2025-01-08     49             7 10.0000
8  2025-01-09     64             8 12.0000
9  2025-01-10     81             9 14.0000
10 2025-01-11    100            10 16.0000
11 2025-01-12    121            11 18.0000
12 2025-01-13    144            12 20.0000
13 2025-01-14    169            13 22.0000
14 2025-01-15    196            14 24.0000
15 2025-01-16    225            15 26.0000
16 2025-01-17    256            16 28.0000
17 2025-01-18    289            17 30.0000
18 2025-01-19    324            18 32.0000
19 2025-01-20    361            19 34.0000
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>] <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">-</span> price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>min())<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>days
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>columns
</span></span></code></pre></div><pre><code>Index(['日期', '股票代號', '股票名稱', '開盤價', '最高價', '最低價', '收盤價', '漲跌', '漲幅(%)',
       '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張', '成交量變動(%)', '均張變動(%)',
       '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比', '本益比(近四季)', '週轉率(%)',
       '成交值比重(%)', '漲跌停', 'RTIME', '日期_dt', 'hold_5Days_ret', 'last_5Days_ret',
       'hold_5Days_winrate', 'hold_10Days_ret', 'last_10Days_ret',
       'hold_10Days_winrate', 'hold_20Days_ret', 'last_20Days_ret',
       'hold_20Days_winrate', 'hold_60Days_ret', 'last_60Days_ret',
       'hold_60Days_winrate', 'hold_120Days_ret', 'last_120Days_ret',
       'hold_120Days_winrate', '日期_0050', '股票代號_0050', '股票名稱_0050', '開盤價_0050',
       '最高價_0050', '最低價_0050', '收盤價_0050', '漲跌_0050', '漲幅(%)_0050',
       '振幅(%)_0050', '成交量_0050', '成交筆數_0050', '成交金額(千)_0050', '均張_0050',
       '成交量變動(%)_0050', '均張變動(%)_0050', '股本(百萬)_0050', '總市值(億)_0050',
       '市值比重(%)_0050', '本益比_0050', '股價淨值比_0050', '本益比(近四季)_0050',
       '週轉率(%)_0050', '成交值比重(%)_0050', '漲跌停_0050', 'RTIME_0050',
       'hold_5Days_ret_0050', 'last_5Days_ret_0050', 'hold_5Days_winrate_0050',
       'hold_10Days_ret_0050', 'last_10Days_ret_0050',
       'hold_10Days_winrate_0050', 'hold_20Days_ret_0050',
       'last_20Days_ret_0050', 'hold_20Days_winrate_0050',
       'hold_60Days_ret_0050', 'last_60Days_ret_0050',
       'hold_60Days_winrate_0050', 'hold_120Days_ret_0050',
       'last_120Days_ret_0050', 'hold_120Days_winrate_0050', 'date_numeric'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 120日本益比的切線斜率</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to calculate slope for a window</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_slope</span>(window_df):
</span></span><span style="display:flex;"><span>    x_diff <span style="color:#f92672">=</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># Time difference</span>
</span></span><span style="display:flex;"><span>    y_diff <span style="color:#f92672">=</span> (window_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>] )<span style="color:#f92672">/</span> window_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]            <span style="color:#75715e"># Value difference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y_diff <span style="color:#f92672">/</span> x_diff <span style="color:#66d9ef">if</span> x_diff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply rolling window calculation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_slope</span>(df, window_size):
</span></span><span style="display:flex;"><span>    slopes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(df) <span style="color:#f92672">-</span> window_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        window <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i:i <span style="color:#f92672">+</span> window_size]  <span style="color:#75715e"># Get the rolling window as a DataFrame</span>
</span></span><span style="display:flex;"><span>        slopes<span style="color:#f92672">.</span>append(calculate_slope(window))
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>window_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> [<span style="color:#66d9ef">None</span>] <span style="color:#f92672">*</span> (window_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> slopes  <span style="color:#75715e"># Fill the start with NaNs for alignment</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>window_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>window_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># 本益比用今天的收盤價去計算 明天才知道result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add slope to the DataFrame</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># price_df[&#39;slope&#39;] = rolling_slope(price_df, window_size=5)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>    price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : rolling_slope(df, window_size<span style="color:#f92672">=</span>w))<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>, [<span style="color:#e6db74">&#39;日期&#39;</span>,<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>, <span style="color:#e6db74">&#39;slope_5&#39;</span>, <span style="color:#e6db74">&#39;date_numeric&#39;</span>]]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>::]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>((<span style="color:#ae81ff">25.6</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29.5</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">29.5</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">5</span>
</span></span></code></pre></div><pre><code>-0.026440677966101684
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>rolling(j)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>rolling(j)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ret_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span><span style="display:flex;"><span>winrate_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        print(price_df<span style="color:#f92672">.</span>loc[price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>, ret_cols]<span style="color:#f92672">.</span>mean())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># price_df.groupby(&#39;股票代號&#39;).apply(lambda df : rolling_slope(df, window_size=5))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>    tmp[<span style="color:#e6db74">&#39;本益比(近四季)_rolling5&#39;</span>] <span style="color:#f92672">=</span> tmp[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;本益比(近四季)_rolling5&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;PE&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>],color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;green&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;PE slope&#39;</span>)
</span></span><span style="display:flex;"><span>    ax3 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax3<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;收盤價&#39;</span>],color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>set_title(ticker)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> tmp<span style="color:#f92672">.</span>loc[(tmp[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.02</span>), <span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Plot vertical lines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> indices:
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>x, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;r&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.4</span>)
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># input: df, 需要有signa columns, output : [[trade_data1], [trade_data2], ...] (list中包含多個list)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyError</span>(<span style="color:#e6db74">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span style="display:flex;"><span>    change_indices <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">!=</span> df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>cumsum() 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 只想要group signal==1的事件</span>
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(change_indices[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    event_list_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _, group <span style="color:#f92672">in</span> groups:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        com_code <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        start_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        end_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        buy_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        sell_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> (sell_price<span style="color:#f92672">/</span>buy_price) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        holding_days <span style="color:#f92672">=</span> len(group)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        event_list <span style="color:#f92672">=</span> [com_code, start_date, end_date, buy_price, sell_price, ret, holding_days]
</span></span><span style="display:flex;"><span>        event_list_all<span style="color:#f92672">.</span>append(event_list)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> event_list_all
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>)
</span></span></code></pre></div><pre><code>slope_60_rolling_60_SUM
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;本益比_rolling5&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;本益比_rolling20&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="看起來本益比切線斜率-累積增加0-對捕捉上升趨勢還不錯">看起來本益比切線斜率 累積增加&gt;0 對捕捉上升趨勢還不錯</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  | (price_df[f&#39;slope_{w}&#39;] &lt; price_df[f&#39;slope_{w}_rolling_{j}&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/312944587.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>] <span style="color:#f92672">&gt;</span> price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>]), ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><pre><code>hold_5Days_ret     0.0080
hold_10Days_ret    0.0148
hold_20Days_ret    0.0310
hold_60Days_ret    0.0807
hold_120Days_ret   0.1454
dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>] <span style="color:#f92672">&gt;</span> price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3156983121.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.1</span>) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/95528996.py:5: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>columns[<span style="color:#f92672">-</span><span style="color:#ae81ff">140</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">120</span>]
</span></span></code></pre></div><pre><code>Index(['收盤價', '漲跌', '漲幅(%)', '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張',
       '成交量變動(%)', '均張變動(%)', '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比',
       '本益比(近四季)', '週轉率(%)', '成交值比重(%)', '漲跌停', 'RTIME'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">60</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;200MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">200</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="local-minima-maxima">Local Minima, maxima</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.signal <span style="color:#f92672">import</span> argrelextrema
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema</span>(df, col):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    max_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    max_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_maxima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_maxima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_max <span style="color:#f92672">&gt;</span> current_max:
</span></span><span style="display:flex;"><span>                max_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                max_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_smaller_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## 反向 股價跌破 local minima 又這個local minima &lt; 上一個 在谷底的感覺</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema_sup</span>(df, col):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># print(local_minima)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    min_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    min_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_minima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_minima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_min <span style="color:#f92672">&lt;</span> current_min:
</span></span><span style="display:flex;"><span>                min_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                min_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    print(min_comparisons_smaller_idx)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx, <span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_larger_idx, <span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx, <span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema(df, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2373799201.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema_sup(df, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>))
</span></span></code></pre></div><pre><code>[np.int64(647), np.int64(727), np.int64(916), np.int64(1198), np.int64(1314), np.int64(1388), np.int64(1801), np.int64(2151), np.int64(2358), np.int64(2549), np.int64(2999), np.int64(3101), np.int64(3290), np.int64(4081), np.int64(4249), np.int64(4392), np.int64(4752)]
[np.int64(388), np.int64(960), np.int64(1098), np.int64(1504), np.int64(1633), np.int64(1760), np.int64(2227), np.int64(2331), np.int64(2519), np.int64(2642), np.int64(2956), np.int64(3136), np.int64(3325), np.int64(3444), np.int64(3646), np.int64(3675), np.int64(3740), np.int64(4131), np.int64(4369), np.int64(4417), np.int64(4677), np.int64(4757), np.int64(4858), np.int64(4902), np.int64(5019), np.int64(5178), np.int64(5262), np.int64(5381), np.int64(5749), np.int64(6100), np.int64(6562), np.int64(6835), np.int64(6941), np.int64(7077), np.int64(7161)]
[np.int64(799), np.int64(1099), np.int64(2475), np.int64(2879), np.int64(2999), np.int64(3090), np.int64(3347), np.int64(3469), np.int64(3750), np.int64(4090), np.int64(4196), np.int64(4293), np.int64(4472), np.int64(4599), np.int64(4716), np.int64(4844), np.int64(5076), np.int64(5188), np.int64(5317), np.int64(5535), np.int64(5556), np.int64(5818), np.int64(5899), np.int64(6264), np.int64(6430), np.int64(6451), np.int64(6795), np.int64(6893)]
[np.int64(380), np.int64(624), np.int64(749), np.int64(1254), np.int64(1441), np.int64(1629), np.int64(1859), np.int64(2107), np.int64(2236), np.int64(2638), np.int64(2710), np.int64(2894), np.int64(2993), np.int64(3240), np.int64(3541), np.int64(3848), np.int64(4122), np.int64(4240), np.int64(4639), np.int64(4952), np.int64(5171), np.int64(5380), np.int64(5662), np.int64(5684), np.int64(5735)]
[np.int64(345), np.int64(628), np.int64(1091), np.int64(1513), np.int64(1715), np.int64(1910), np.int64(1946), np.int64(2023), np.int64(2086), np.int64(2190), np.int64(2438), np.int64(2813), np.int64(3199), np.int64(3389), np.int64(3426), np.int64(3459), np.int64(3681), np.int64(3819), np.int64(3965), np.int64(4515), np.int64(4766), np.int64(4890), np.int64(5135), np.int64(5230), np.int64(5349), np.int64(5502)]
[np.int64(374), np.int64(465), np.int64(598), np.int64(624), np.int64(1017), np.int64(1173), np.int64(1588), np.int64(1710), np.int64(1939), np.int64(2157), np.int64(2286), np.int64(2761), np.int64(2816), np.int64(3084), np.int64(3111), np.int64(3293)]
[np.int64(653), np.int64(953), np.int64(1046), np.int64(1150), np.int64(1469), np.int64(1596), np.int64(1628), np.int64(1706), np.int64(1826), np.int64(1922), np.int64(2362), np.int64(2518), np.int64(2731), np.int64(3190), np.int64(3637), np.int64(3741), np.int64(3757), np.int64(3873), np.int64(4145)]
[np.int64(318), np.int64(534), np.int64(796), np.int64(1031), np.int64(1068), np.int64(1110), np.int64(1153), np.int64(1328), np.int64(1394), np.int64(1716), np.int64(1835), np.int64(2269)]
[np.int64(765), np.int64(952), np.int64(1659), np.int64(1962), np.int64(2577), np.int64(3066), np.int64(3310), np.int64(3626), np.int64(3773), np.int64(3796), np.int64(3961), np.int64(4354), np.int64(4559), np.int64(4661), np.int64(4841)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3911248321.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema_sup(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema(df, <span style="color:#e6db74">&#39;收盤價&#39;</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2624941152.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, '收盤價'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema_sup(df, <span style="color:#e6db74">&#39;收盤價&#39;</span>))
</span></span></code></pre></div><pre><code>[np.int64(204), np.int64(287), np.int64(387), np.int64(690), np.int64(886), np.int64(1026), np.int64(1259), np.int64(1299), np.int64(1369), np.int64(1471), np.int64(1508), np.int64(1530), np.int64(1583), np.int64(1742), np.int64(2029), np.int64(2081), np.int64(2308), np.int64(2343), np.int64(2501), np.int64(2543), np.int64(2626), np.int64(2713), np.int64(2737), np.int64(2794), np.int64(3012), np.int64(3029), np.int64(3053), np.int64(3107), np.int64(3157), np.int64(3169), np.int64(3267), np.int64(3314), np.int64(3345), np.int64(3420), np.int64(3452), np.int64(3475), np.int64(3494), np.int64(3681), np.int64(3819), np.int64(4028), np.int64(4159), np.int64(4193), np.int64(4316), np.int64(4338), np.int64(4367), np.int64(4410), np.int64(4563), np.int64(4706), np.int64(4746), np.int64(4790)]
[np.int64(40), np.int64(133), np.int64(185), np.int64(258), np.int64(317), np.int64(343), np.int64(386), np.int64(431), np.int64(615), np.int64(904), np.int64(943), np.int64(1029), np.int64(1069), np.int64(1159), np.int64(1224), np.int64(1537), np.int64(1562), np.int64(1646), np.int64(1704), np.int64(1757), np.int64(1797), np.int64(1823), np.int64(1875), np.int64(1896), np.int64(1942), np.int64(2037), np.int64(2083), np.int64(2110), np.int64(2125), np.int64(2149), np.int64(2193), np.int64(2253), np.int64(2277), np.int64(2491), np.int64(2553), np.int64(2592), np.int64(2616), np.int64(2641), np.int64(2704), np.int64(2912), np.int64(2930), np.int64(2948), np.int64(3039), np.int64(3102), np.int64(3284), np.int64(3333), np.int64(3400), np.int64(3470), np.int64(3508), np.int64(3668), np.int64(3695), np.int64(3713), np.int64(3951), np.int64(4018), np.int64(4088), np.int64(4291), np.int64(4359), np.int64(4375), np.int64(4390), np.int64(4593), np.int64(4802), np.int64(4895), np.int64(4960), np.int64(5006), np.int64(5243), np.int64(5336), np.int64(5389), np.int64(5488), np.int64(5564), np.int64(5962), np.int64(6047), np.int64(6086), np.int64(6169), np.int64(6187), np.int64(6219), np.int64(6310), np.int64(6506), np.int64(6636), np.int64(6754), np.int64(6786), np.int64(6856), np.int64(6991), np.int64(7030), np.int64(7068), np.int64(7145), np.int64(7262), np.int64(7367), np.int64(7573)]
[np.int64(96), np.int64(147), np.int64(203), np.int64(240), np.int64(401), np.int64(468), np.int64(587), np.int64(715), np.int64(789), np.int64(1042), np.int64(1190), np.int64(1235), np.int64(1283), np.int64(1432), np.int64(1463), np.int64(1489), np.int64(1530), np.int64(1632), np.int64(1646), np.int64(1669), np.int64(1894), np.int64(1986), np.int64(2041), np.int64(2101), np.int64(2167), np.int64(2263), np.int64(2449), np.int64(2622), np.int64(2822), np.int64(2847), np.int64(2976), np.int64(3006), np.int64(3078), np.int64(3287), np.int64(3307), np.int64(3349), np.int64(3437), np.int64(3543), np.int64(3629), np.int64(3673), np.int64(3693), np.int64(3710), np.int64(3737), np.int64(3820), np.int64(3890), np.int64(4051), np.int64(4140), np.int64(4164), np.int64(4193), np.int64(4274), np.int64(4496), np.int64(4577), np.int64(4681), np.int64(4806), np.int64(4827), np.int64(5003), np.int64(5026), np.int64(5273), np.int64(5294), np.int64(5333), np.int64(5387), np.int64(5430), np.int64(5477), np.int64(5508), np.int64(5742), np.int64(5760), np.int64(5812), np.int64(5844), np.int64(5999), np.int64(6123), np.int64(6411), np.int64(6484), np.int64(6574), np.int64(6600), np.int64(6702), np.int64(6727), np.int64(6777), np.int64(6840), np.int64(6911)]
[np.int64(215), np.int64(229), np.int64(247), np.int64(390), np.int64(584), np.int64(692), np.int64(789), np.int64(833), np.int64(875), np.int64(1018), np.int64(1058), np.int64(1121), np.int64(1136), np.int64(1196), np.int64(1216), np.int64(1234), np.int64(1317), np.int64(1588), np.int64(1622), np.int64(1729), np.int64(1818), np.int64(1829), np.int64(2054), np.int64(2120), np.int64(2193), np.int64(2220), np.int64(2295), np.int64(2394), np.int64(2421), np.int64(2459), np.int64(2476), np.int64(2493), np.int64(2673), np.int64(2817), np.int64(2850), np.int64(2959), np.int64(3232), np.int64(3282), np.int64(3419), np.int64(3494), np.int64(3594), np.int64(3608), np.int64(3664), np.int64(3754), np.int64(3793), np.int64(3845), np.int64(4071), np.int64(4196), np.int64(4214), np.int64(4229), np.int64(4275), np.int64(4324), np.int64(4611), np.int64(4961), np.int64(4997), np.int64(5096), np.int64(5125), np.int64(5173), np.int64(5233), np.int64(5367), np.int64(5429), np.int64(5549), np.int64(5607)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)


[np.int64(86), np.int64(106), np.int64(213), np.int64(429), np.int64(450), np.int64(573), np.int64(592), np.int64(639), np.int64(718), np.int64(1006), np.int64(1066), np.int64(1146), np.int64(1188), np.int64(1217), np.int64(1241), np.int64(1277), np.int64(1472), np.int64(1580), np.int64(1650), np.int64(1679), np.int64(1775), np.int64(1854), np.int64(1965), np.int64(2041), np.int64(2244), np.int64(2354), np.int64(2387), np.int64(2428), np.int64(2507), np.int64(2524), np.int64(2648), np.int64(2708), np.int64(2769), np.int64(2828), np.int64(2868), np.int64(3122), np.int64(3142), np.int64(3332), np.int64(3355), np.int64(3370), np.int64(3423), np.int64(3438), np.int64(3644), np.int64(3742), np.int64(3858), np.int64(3932), np.int64(3950), np.int64(3985), np.int64(4114), np.int64(4136), np.int64(4154), np.int64(4174), np.int64(4271), np.int64(4461), np.int64(4573), np.int64(4602), np.int64(4671), np.int64(4805), np.int64(4847), np.int64(4963), np.int64(4982), np.int64(5085), np.int64(5457), np.int64(5559), np.int64(5594)]
[np.int64(63), np.int64(113), np.int64(163), np.int64(232), np.int64(292), np.int64(338), np.int64(349), np.int64(424), np.int64(436), np.int64(451), np.int64(520), np.int64(531), np.int64(640), np.int64(671), np.int64(1002), np.int64(1117), np.int64(1129), np.int64(1300), np.int64(1344), np.int64(1529), np.int64(1554), np.int64(1632), np.int64(1645), np.int64(1661), np.int64(1738), np.int64(1798), np.int64(1881), np.int64(1923), np.int64(2102), np.int64(2175), np.int64(2214), np.int64(2246), np.int64(2363), np.int64(2593), np.int64(2704), np.int64(2759), np.int64(2812), np.int64(3083), np.int64(3175), np.int64(3245), np.int64(3313)]
[np.int64(123), np.int64(149), np.int64(219), np.int64(260), np.int64(280), np.int64(608), np.int64(637), np.int64(727), np.int64(813), np.int64(894), np.int64(921), np.int64(997), np.int64(1090), np.int64(1115), np.int64(1235), np.int64(1275), np.int64(1370), np.int64(1384), np.int64(1482), np.int64(1502), np.int64(1654), np.int64(1826), np.int64(1838), np.int64(1865), np.int64(1896), np.int64(2014), np.int64(2086), np.int64(2190), np.int64(2208), np.int64(2302), np.int64(2471), np.int64(2513), np.int64(2569), np.int64(2583), np.int64(2681), np.int64(2821), np.int64(2838), np.int64(3028), np.int64(3096), np.int64(3264), np.int64(3308), np.int64(3377), np.int64(3513), np.int64(3590), np.int64(3668), np.int64(3728), np.int64(3814), np.int64(3853), np.int64(3908), np.int64(4095)]
[np.int64(38), np.int64(114), np.int64(255), np.int64(302), np.int64(314), np.int64(335), np.int64(674), np.int64(778), np.int64(922), np.int64(1079), np.int64(1276), np.int64(1310), np.int64(1342), np.int64(1486), np.int64(1781), np.int64(1968), np.int64(2036), np.int64(2161), np.int64(2174), np.int64(2223), np.int64(2255), np.int64(2276), np.int64(2310), np.int64(2328), np.int64(2444), np.int64(2476), np.int64(2498), np.int64(2520), np.int64(2659), np.int64(2826)]
[np.int64(59), np.int64(146), np.int64(176), np.int64(272), np.int64(395), np.int64(475), np.int64(553), np.int64(571), np.int64(659), np.int64(901), np.int64(960), np.int64(1056), np.int64(1080), np.int64(1112), np.int64(1139), np.int64(1491), np.int64(1530), np.int64(1555), np.int64(1733), np.int64(1809), np.int64(1925), np.int64(1940), np.int64(2024), np.int64(2035), np.int64(2156), np.int64(2201), np.int64(2304), np.int64(2334), np.int64(2395), np.int64(2528), np.int64(2578), np.int64(2629), np.int64(2651), np.int64(2763), np.int64(2811), np.int64(2831), np.int64(2908), np.int64(2930), np.int64(3133), np.int64(3285), np.int64(3345), np.int64(3451), np.int64(3500), np.int64(3582), np.int64(3611), np.int64(3837), np.int64(3914), np.int64(3948), np.int64(4087), np.int64(4230), np.int64(4327), np.int64(4414), np.int64(4433), np.int64(4510), np.int64(4587), np.int64(4607), np.int64(4700), np.int64(4783), np.int64(4799), np.int64(4828), np.int64(4944), np.int64(5083)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/785596803.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema_sup(df, '收盤價'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price_df[<span style="color:#e6db74">&#39;日期&#39;</span>] )
</span></span></code></pre></div><h2 id="strategy-logic">strategy Logic</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 近一個月 400張大戶 增加2%以上</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4079245513.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/857034293.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;收盤價&#39;]&gt;price_df[&#39;local_maxima&#39;])) | (price_df[&#39;維持率反推融資平均損益&#39;]&lt;-0.1)</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1700805250.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[((price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>])) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/168196673.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">&gt;=</span> price_df[<span style="color:#e6db74">&#39;200MA&#39;</span>]) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3380416550.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;min_comparisons_smaller&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/939178834.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4128040719.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/357474516.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<h2 id="組合上下行">組合上下行</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/950731482.py:5: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4128040719.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3623880085.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1110539843.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3456730543.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>] <span style="color:#f92672">&gt;=</span> price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>]) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1528418423.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>] <span style="color:#f92672">&lt;</span> price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>]) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/538384737.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># price_df[price_df[&#39;signal&#39;]==1]</span>
</span></span></code></pre></div><h2 id="now">NOW</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  (price_df[&#39;週集保diff4week&#39;]&gt;0.5)|  (price_df[&#39;維持率反推融資平均損益&#39;]&lt;-0.1)</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[((price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.02</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>])) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>) <span style="color:#f92672">|</span>  (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]) <span style="color:#f92672">|</span>  (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3722245375.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<h2 id="簡易pnl模擬">簡易PnL模擬</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> res_list:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;訊號開始日&#39;</span>, <span style="color:#e6db74">&#39;訊號結束日&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>])
</span></span><span style="display:flex;"><span>    res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([res_df, tmp], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;return_fee&#39;</span>] <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.00585</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    GOAL <span style="color:#f92672">=</span> (price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>] <span style="color:#f92672">=</span> GOAL
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>empty:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    strategy_pnl <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>values[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>] <span style="color:#f92672">=</span> strategy_pnl
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>] <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">/</span>len(price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)])
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;strategy_pnl&#39;</span>]<span style="color:#f92672">/</span>show_df[<span style="color:#e6db74">&#39;time_in_markets&#39;</span>]
</span></span><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0.8</span>
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(show_df[show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>]<span style="color:#f92672">&gt;</span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>]]<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><pre><code>Index(['2059', '3008'], dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest_ratio</span>(df, buyholddays):
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for backtest PnL ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index_count 算目前在該ticker 上累積bet的數量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;ratio&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    signal_idx <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    all_holding_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx <span style="color:#f92672">in</span> signal_idx:
</span></span><span style="display:flex;"><span>        adding_idx <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(idx, idx<span style="color:#f92672">+</span>buyholddays) <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(df)]
</span></span><span style="display:flex;"><span>        all_holding_idx <span style="color:#f92672">+=</span> adding_idx
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[all_holding_idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, <span style="color:#ae81ff">10</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/517245478.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 10))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, <span style="color:#ae81ff">20</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2754594864.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 20))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, <span style="color:#ae81ff">60</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3282921495.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 60))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> res_list:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;訊號開始日&#39;</span>, <span style="color:#e6db74">&#39;訊號結束日&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>])
</span></span><span style="display:flex;"><span>    res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([res_df, tmp], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;return_fee&#39;</span>] <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.00585</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/317971430.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    GOAL <span style="color:#f92672">=</span> (price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>] <span style="color:#f92672">=</span> GOAL
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>empty:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    strategy_pnl <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>values[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>] <span style="color:#f92672">=</span> strategy_pnl
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>] <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">/</span>len(price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)])
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;strategy_pnl&#39;</span>]<span style="color:#f92672">/</span>show_df[<span style="color:#e6db74">&#39;time_in_markets&#39;</span>]
</span></span><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0.8</span>
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(show_df[show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>]<span style="color:#f92672">&gt;</span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>]]<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><pre><code>Index(['2330', '8069', '3008'], dtype='object')
</code></pre>
<h2 id="如果是想要抄底的策略-holding-天數可能要拉長到可以等他漲回去">如果是想要抄底的策略 holding 天數可能要拉長到可以等他漲回去</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># price_df.loc[(price_df[&#39;股票代號&#39;]==&#39;2330&#39;) &amp; (price_df[&#39;signal&#39;]==1)].iloc[-20::]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;3529&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;5274&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ae81ff">1410</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2410</span>
</span></span></code></pre></div><pre><code>0.5850622406639004
</code></pre>
<h2 id="2454-2383-2059-3008-done">2454, 2383, 2059, 3008 done</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2383&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2373799201.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;cut&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>qcut(price_df[<span style="color:#e6db74">&#39;slope&#39;</span>], <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) 
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;signal_count&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>res
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>]<span style="color:#f92672">&lt;=-</span><span style="color:#ae81ff">0.05</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;slope&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0.1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ret_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span> <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span><span style="display:flex;"><span>winrate_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span> <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[winrate_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h2 id="pe">PE</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;cut&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>qcut(price_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>], <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) 
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;signal_count&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>res
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1178586764.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1178586764.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1178586764.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>columns
</span></span></code></pre></div><pre><code>Index(['日期', '股票代號', '股票名稱', '開盤價', '最高價', '最低價', '收盤價', '漲跌', '漲幅(%)',
       '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張', '成交量變動(%)', '均張變動(%)',
       '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比', '本益比(近四季)', '週轉率(%)',
       '成交值比重(%)', '漲跌停', 'RTIME', '日期_dt', 'hold_5Days_ret', 'last_5Days_ret',
       'hold_5Days_winrate', 'hold_10Days_ret', 'last_10Days_ret',
       'hold_10Days_winrate', 'hold_20Days_ret', 'last_20Days_ret',
       'hold_20Days_winrate', 'hold_60Days_ret', 'last_60Days_ret',
       'hold_60Days_winrate', 'hold_120Days_ret', 'last_120Days_ret',
       'hold_120Days_winrate', '日期_0050', '股票代號_0050', '股票名稱_0050', '開盤價_0050',
       '最高價_0050', '最低價_0050', '收盤價_0050', '漲跌_0050', '漲幅(%)_0050',
       '振幅(%)_0050', '成交量_0050', '成交筆數_0050', '成交金額(千)_0050', '均張_0050',
       '成交量變動(%)_0050', '均張變動(%)_0050', '股本(百萬)_0050', '總市值(億)_0050',
       '市值比重(%)_0050', '本益比_0050', '股價淨值比_0050', '本益比(近四季)_0050',
       '週轉率(%)_0050', '成交值比重(%)_0050', '漲跌停_0050', 'RTIME_0050',
       'hold_5Days_ret_0050', 'last_5Days_ret_0050', 'hold_5Days_winrate_0050',
       'hold_10Days_ret_0050', 'last_10Days_ret_0050',
       'hold_10Days_winrate_0050', 'hold_20Days_ret_0050',
       'last_20Days_ret_0050', 'hold_20Days_winrate_0050',
       'hold_60Days_ret_0050', 'last_60Days_ret_0050',
       'hold_60Days_winrate_0050', 'hold_120Days_ret_0050',
       'last_120Days_ret_0050', 'hold_120Days_winrate_0050', 'cut', 'signal'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[winrate_cols]<span style="color:#f92672">.</span>count()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/quarterly/quarterlyIncomeStatementSingal.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df <span style="color:#f92672">=</span> income_stat_df[income_stat_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df[<span style="color:#e6db74">&#39;公告日_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(income_stat_df[<span style="color:#e6db74">&#39;公告日期&#39;</span>])
</span></span><span style="display:flex;"><span>income_stat_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;年季&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>income_stat_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\s+&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> income_stat_df<span style="color:#f92672">.</span>columns]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">30</span>]
</span></span></code></pre></div><pre><code>Index(['年季', '股票代號', '股票名稱', '市場別', '財報類別', '銷貨收入淨額(千)', '銷貨收入(千)', '銷貨退回(千)',
       '銷貨折讓(千)', '營業收入淨額(千)', '營業成本(千)', '營業毛利(千)', '聯屬公司間未實現利益(千)',
       '聯屬公司間已實現利益(千)', '營業毛利淨額(千)', '營業費用(千)', '推銷費用(千)', '管理費用(千)',
       '研發費用(千)', '預期信用減損損益(千)', '其他營業費用(千)', '其他收益及費損(千)', '其他收益(千)',
       '其他費損(千)', '營業利益(千)', '營業外收入及支出(千)', '利息收入(千)', '銀行存款利息(千)',
       '按攤銷後成本衡量之金融資產利息收入(千)', '透過其他綜合損益按公允價值衡量之金融資產利息收入(千)'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df<span style="color:#f92672">.</span>columns[<span style="color:#f92672">-</span><span style="color:#ae81ff">30</span>::]
</span></span></code></pre></div><pre><code>Index(['國外營運機構淨投資避險中屬有效避險部分之避險工具損益(千)', '與待出售非流動資產直接相關之權益–可能重分類至損益(千)',
       '透過其他綜合損益按公允價值衡量之債務工具投資未實現評價損益(千)', '避險工具之損益–可能重分類至損益(千)',
       '採權益法認列關聯企業及合資其他綜合損益之份額–可能重分類至損益(千)', '可能重分類至損益之其他項目(千)',
       '與可能重分類至損益之項目相關之所得稅(千)', '綜合損益(千)', '稅後純益歸屬(千)', '母公司業主–稅後純益(千)',
       '非控制權益–稅後純益(千)', '共同控制下前手權益–稅後純益(千)', '綜合損益歸屬(千)', '母公司業主–綜合損益(千)',
       '非控制權益–綜合損益(千)', '共同控制下前手權益–綜合損益(千)', 'EBITDA(千)', '公告基本每股盈餘(元)',
       '公告稀釋每股盈餘(元)', '原始每股稅前盈餘(元)', '原始每股稅後盈餘(元)', '原始每股綜合盈餘(元)', '每股稅前盈餘(元)',
       '每股稅後盈餘(元)', '每股綜合盈餘(元)', '更新日期', '公告日期', '建立日期', 'RTIME', '公告日_dt'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>income_stat_df[<span style="color:#e6db74">&#39;母公司業主–稅後純益(千)&#39;</span>]
</span></span></code></pre></div><pre><code>0           &lt;NA&gt;
1           &lt;NA&gt;
2           &lt;NA&gt;
3           &lt;NA&gt;
4        1602873
         ...    
818      4498178
819     25715520
820      2435866
821    247845528
822      1456409
Name: 母公司業主–稅後純益(千), Length: 823, dtype: Int64
</code></pre>
<h2 id="不同時間段-適合看得指標也不盡相同-我能不能這個概念---用基本面的變化來作為時間段的區分">不同時間段 適合看得指標也不盡相同 我能不能這個概念 -&gt; 用基本面的變化來作為時間段的區分</h2>
<p>像是基本面改善期間 -&gt; 適合的策略<br>
基本面維持不變時的策略<br>
股價過度反應/過高過低PE對應的策略<br>
像是 基本面漲, 股價沒漲 -&gt; 可能已經反應過了, 也可能是還沒反應<br>
順勢 基本面漲 &amp; 股價也漲<br>
大盤逆風 基本面漲 但股價大跌 -&gt; 先不要進場 等大盤回穩 or PE到一定程度才進場</p>
<h2 id="貝氏定理">貝氏定理</h2>
<ol>
<li>先把營收, EPS, 對比股價的圖Plot出來</li>
<li>判斷大盤行情 上行, 糾結, 下行 在對比各個features在這些期間之下的表現 ex: 大盤下行的時候 全部訊號都沒用 除了PE跌倒歷史quantile多少時可以買入&hellip;, 上行的時候跟著持有也不用管基本面etc</li>
</ol>
<h2 id="reample--merge">reample + merge</h2>
<h2 id="eps-forward-knowing--cal--resample--merge">EPS forward knowing , cal + resample + merge</h2>
<h3 id="1-先把每一季的eps做加總4季-agg-再藉由shift去假設-能夠完美預測未來n季">1. 先把每一季的EPS做加總(4季 agg) 再藉由shift去假設 能夠完美預測未來N季</h3>
<h3 id="再resample-至daily">再resample 至daily</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">resample_q_forward</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># print(df[&#39;股票代號&#39;].iloc[-1])</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> df[<span style="color:#f92672">~</span>df[<span style="color:#e6db74">&#39;公告日期&#39;</span>]<span style="color:#f92672">.</span>isna()]
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> df[<span style="color:#f92672">~</span>df<span style="color:#f92672">.</span>duplicated(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;公告日期&#39;</span>])]
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;knowNext0Q&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;每股稅後盈餘(元)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;公告日_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;D&#39;</span>)<span style="color:#f92672">.</span>ffill()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><h3 id="2-與股價合併">2. 與股價合併</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>resample_q_df <span style="color:#f92672">=</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(resample_q_df, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;公告日_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;Y_M&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year<span style="color:#f92672">.</span>astype(str) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;_&#39;</span> <span style="color:#f92672">+</span>  combine_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>month<span style="color:#f92672">.</span>astype(str)<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> combine_df[combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;PEG_0Q&#39;</span>]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><pre><code>count   5167.0000
mean       1.5405
std        2.4577
min       -1.0632
25%        0.3917
50%        0.7254
75%        1.6816
max       20.2743
Name: PEG_0Q, dtype: float64
</code></pre>
<h3 id="3-有股價-有完美預測一段時間的eps---就有完美預估的pe">3. 有股價 有完美預測一段時間的EPS -&gt; 就有完美預估的PE</h3>
<h3 id="找出該期間的max-min值-主要是用來繪制河流圖">找出該期間的MAX, MIN值 主要是用來繪制河流圖</h3>
<h3 id="並shift">並shift</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_PE_range</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    groupby 年季, ticker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    假設知道未來N季的EPS 對應期間股價的P/E 區間的max, min
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    應該要用於未來畫本益比河流圖所用
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>    YM <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Y_M&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    Q <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;年季&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>        tmp<span style="color:#f92672">.</span>loc[Q, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_max_PE&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span>        tmp<span style="color:#f92672">.</span>loc[Q, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_mean_PE&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>        tmp<span style="color:#f92672">.</span>loc[Q, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>min()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># tmp.loc[Q, f&#39;{i}_max_PEG&#39;] = df[f&#39;PEG_{i}Q&#39;].max()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># tmp.loc[Q, f&#39;{i}_mean_PEG&#39;] = df[f&#39;PEG_{i}Q&#39;].mean()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># tmp.loc[Q, f&#39;{i}_min_PEG&#39;] = df[f&#39;PEG_{i}Q&#39;].min()</span>
</span></span><span style="display:flex;"><span>    tmp[<span style="color:#e6db74">&#39;Q&#39;</span>] <span style="color:#f92672">=</span> Q
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tmp
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pe_res <span style="color:#f92672">=</span> combine_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;年季&#39;</span>])<span style="color:#f92672">.</span>apply(find_PE_range)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/3018702681.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  pe_res = combine_df.groupby(['股票代號', '年季']).apply(find_PE_range).reset_index(drop=False)
</code></pre>
<h3 id="用前一季之前的all-data-來計算-分位數">用前一季之前的All data 來計算 分位數</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Convert the &#39;quarter&#39; column to a Period with quarterly frequency</span>
</span></span><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;year&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">&#39;年季&#39;</span>]<span style="color:#f92672">.</span>str[:<span style="color:#ae81ff">4</span>]  <span style="color:#75715e"># Extract the year (first 4 digits)</span>
</span></span><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;qtr&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">&#39;年季&#39;</span>]<span style="color:#f92672">.</span>str[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]  <span style="color:#75715e"># Extract the quarter (last 2 digits)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create a new column with period as &#39;YYYYQ#&#39; format (like 2000Q4, 2001Q1, etc.)</span>
</span></span><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;period&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">&#39;year&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;Q&#39;</span> <span style="color:#f92672">+</span> combine_df[<span style="color:#e6db74">&#39;qtr&#39;</span>]<span style="color:#f92672">.</span>replace({<span style="color:#e6db74">&#39;01&#39;</span>: <span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">&#39;02&#39;</span>: <span style="color:#e6db74">&#39;2&#39;</span>, <span style="color:#e6db74">&#39;03&#39;</span>: <span style="color:#e6db74">&#39;3&#39;</span>, <span style="color:#e6db74">&#39;04&#39;</span>: <span style="color:#e6db74">&#39;4&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert to Pandas Period with quarterly frequency</span>
</span></span><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;period&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>PeriodIndex(combine_df[<span style="color:#e6db74">&#39;period&#39;</span>], freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Q&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">quantile_q</span>(df):
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    q_list <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;period&#39;</span>]<span style="color:#f92672">.</span>unique()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>    sub_df_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> q <span style="color:#f92672">in</span> q_list:
</span></span><span style="display:flex;"><span>        thisQ <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;period&#39;</span>]<span style="color:#f92672">==</span>q]
</span></span><span style="display:flex;"><span>        lastQ <span style="color:#f92672">=</span> df[(df[<span style="color:#e6db74">&#39;period&#39;</span>]<span style="color:#f92672">&gt;</span>(q <span style="color:#f92672">-</span> <span style="color:#ae81ff">40</span>)) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;period&#39;</span>]<span style="color:#f92672">&lt;</span>q)] <span style="color:#75715e"># 20 -&gt; 5y,  12 -&gt; 3y</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>            thisQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> lastQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>quantile(<span style="color:#ae81ff">0.2</span>)
</span></span><span style="display:flex;"><span>            thisQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> lastQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>quantile(<span style="color:#ae81ff">0.4</span>)
</span></span><span style="display:flex;"><span>            thisQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> lastQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>quantile(<span style="color:#ae81ff">0.6</span>)
</span></span><span style="display:flex;"><span>            thisQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> lastQ[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">.</span>quantile(<span style="color:#ae81ff">0.8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># thisQ[f&#39;q20_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.2)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># thisQ[f&#39;q40_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.4)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># thisQ[f&#39;q60_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.6)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># thisQ[f&#39;q80_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.8)</span>
</span></span><span style="display:flex;"><span>        sub_df_list<span style="color:#f92672">.</span>append(thisQ)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    new_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(sub_df_list)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> new_df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res <span style="color:#f92672">=</span> combine_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(quantile_q)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/348048885.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res = combine_df.groupby('股票代號').apply(quantile_q).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">look back 20Q = 5y 區間
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[(res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;3533&#39;</span>) <span style="color:#f92672">&amp;</span> (res[<span style="color:#e6db74">&#39;period&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;2008Q1&#39;</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">_PE_knowNext</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">Q&#39;</span><span style="color:#f92672">.</span>format(sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], i))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ax1.plot(sub[&#39;日期_dt&#39;], sub[&#39;PE_1Q&#39;],  label=&#39;PE_1Q&#39;)</span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q20&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q40&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q60&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q80&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>])
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>legend()
</span></span></code></pre></div><pre><code>&lt;matplotlib.legend.Legend at 0x1283cb400&gt;
</code></pre>
<p><img src="../../images/industry_project/2_post.md/Final_test_163_1.png" alt="png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">look back 20Q = 5y 區間
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[(res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;8069&#39;</span>) <span style="color:#f92672">&amp;</span> (res[<span style="color:#e6db74">&#39;period&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;2018Q1&#39;</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">_PE_knowNext</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">Q&#39;</span><span style="color:#f92672">.</span>format(sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], i))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ax1.plot(sub[&#39;日期_dt&#39;], sub[&#39;PE_1Q&#39;],  label=&#39;PE_1Q&#39;)</span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q20&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q40&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q60&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;q80&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>])
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>legend()
</span></span></code></pre></div><pre><code>&lt;matplotlib.legend.Legend at 0x124c216d0&gt;
</code></pre>
<p><img src="../../images/industry_project/2_post.md/Final_test_164_1.png" alt="png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> res<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]:
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;0~20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]) <span style="color:#f92672">&amp;</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]):
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;20~40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]) <span style="color:#f92672">&amp;</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]):
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;40~60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]) <span style="color:#f92672">&amp;</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]):
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;60~80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PEG_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>]:
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;80~100_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_G&#39;</span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> res<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]:
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;0~20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q20_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]) <span style="color:#f92672">&amp;</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]):
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;20~40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q40_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]) <span style="color:#f92672">&amp;</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]):
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;40~60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q60_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]) <span style="color:#f92672">&amp;</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]):
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;60~80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q80_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]:
</span></span><span style="display:flex;"><span>            res<span style="color:#f92672">.</span>loc[idx, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;80~100_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res[res[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;0~20_0Q&#39;</span>]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>preview_res <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;cata_4Q&#39;</span>])[[<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>preview_res <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;cata_0Q&#39;</span>])[[<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>preview_res[<span style="color:#e6db74">&#39;day_ratio&#39;</span>] <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;cata_4Q&#39;</span>])[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>count()<span style="color:#f92672">/</span><span style="color:#ae81ff">6275</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>preview_res
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">look back 20Q = 5y 區間
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;20~40_0Q&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> quantile <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;0~20&#39;</span>, <span style="color:#e6db74">&#39;20~40&#39;</span>, <span style="color:#e6db74">&#39;40~60&#39;</span>, <span style="color:#e6db74">&#39;60~80&#39;</span>, <span style="color:#e6db74">&#39;80~100&#39;</span>]:
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q holding 120 ret&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># for i in range(0, 5):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ax1.plot(sub[&#39;日期_dt&#39;], sub[&#39;PE_1Q&#39;],  label=&#39;PE_1Q&#39;)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        hist_obj <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>hist(sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]<span style="color:#f92672">.</span>values,  label<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, bins<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>,   alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>                            )
</span></span><span style="display:flex;"><span>        color <span style="color:#f92672">=</span> hist_obj[<span style="color:#ae81ff">2</span>][<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get_facecolor()
</span></span><span style="display:flex;"><span>        ax1<span style="color:#f92672">.</span>axvline(sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean(), ymin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, ymax<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>,  label<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>,  color<span style="color:#f92672">=</span>color)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ax1<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>        
</span></span></code></pre></div><p><img src="../../images/industry_project/2_post.md/Final_test_172_0.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_172_1.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_172_2.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_172_3.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_172_4.png" alt="png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy <span style="color:#f92672">import</span> stats
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate some sample data with different lengths</span>
</span></span><span style="display:flex;"><span>data1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">100</span>)  <span style="color:#75715e"># Dataset 1</span>
</span></span><span style="display:flex;"><span>data2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">150</span>)  <span style="color:#75715e"># Dataset 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform a two-sample t-test assuming equal variances (Student&#39;s t-test)</span>
</span></span><span style="display:flex;"><span>t_stat, p_value <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>ttest_ind(data1, data2, equal_var<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Student&#39;s t-test: t-statistic = </span><span style="color:#e6db74">{</span>t_stat<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, p-value = </span><span style="color:#e6db74">{</span>p_value<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Perform Welch&#39;s t-test (does not assume equal variances)</span>
</span></span><span style="display:flex;"><span>t_stat_welch, p_value_welch <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>ttest_ind(data1, data2, equal_var<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Welch&#39;s t-test: t-statistic = </span><span style="color:#e6db74">{</span>t_stat_welch<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, p-value = </span><span style="color:#e6db74">{</span>p_value_welch<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">look back 20Q = 5y 區間
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> quantile <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;0~20&#39;</span>, <span style="color:#e6db74">&#39;20~40&#39;</span>, <span style="color:#e6db74">&#39;40~60&#39;</span>, <span style="color:#e6db74">&#39;60~80&#39;</span>, <span style="color:#e6db74">&#39;80~100&#39;</span>]:
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> days <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        data1 <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>days<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>        data2 <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;cata_</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>days<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        t_stat, p_value <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>ttest_ind(data1, data2, equal_var<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Student&#39;s t-test: t-statistic = </span><span style="color:#e6db74">{</span>t_stat<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, p-value = </span><span style="color:#e6db74">{</span>p_value<span style="color:#e6db74">:</span><span style="color:#e6db74">.4f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">Q, &#39;hold_</span><span style="color:#e6db74">{</span>days<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>        tmp<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q vs </span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold </span><span style="color:#e6db74">{</span>days<span style="color:#e6db74">}</span><span style="color:#e6db74"> mean return p-value&#39;</span>] <span style="color:#f92672">=</span> p_value
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tmp
</span></span></code></pre></div><p>有多少 forward 0 在低本益比 但其實用forward 4Q是高本益比<br>
反之亦然<br>
這類股價其實是由未來營收所帶動的 也許就是我們想要抓的?<br>
forward 的優勢就在於 用歷史推估 跟由研調預測得出來的結論有明顯差異 材值得做</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0~20_0Q&#39;</span>)
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;60~80_4Q&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[mask1 <span style="color:#f92672">&amp;</span> mask2, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;80~100_0Q&#39;</span>)
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;40~60_4Q&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask1 <span style="color:#f92672">&amp;</span> mask2, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span><span style="display:flex;"><span>show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;precision&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask1 <span style="color:#f92672">&amp;</span> mask2, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;80~100_0Q&#39;</span>)
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;80~100_4Q&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span><span style="display:flex;"><span>show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;precision&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask1, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mask1 = (sub[&#39;cata_0Q_G&#39;] == &#39;80~100_0Q_G&#39;)</span>
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;40~60_4Q&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span><span style="display:flex;"><span>show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;precision&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q_G&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;80~100_0Q_G&#39;</span>)
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;PEG_4Q&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;PEG_4Q&#39;</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mask2 =  (sub[&#39;PEG_4Q&#39;] &gt; 0) </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span><span style="display:flex;"><span>show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;precision&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q_G&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;80~100_0Q_G&#39;</span>)
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;PEG_4Q&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;PEG_4Q&#39;</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.1</span>):
</span></span><span style="display:flex;"><span>    mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;PEG_0Q&#39;</span>] <span style="color:#f92672">&gt;=</span> i) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;PEG_0Q&#39;</span>] <span style="color:#f92672">&lt;</span> (i <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.1</span>))
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">:</span><span style="color:#e6db74">.1f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">0.1</span><span style="color:#e6db74">:</span><span style="color:#e6db74">.1f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">_mean return&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">:</span><span style="color:#e6db74">.1f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">0.1</span><span style="color:#e6db74">:</span><span style="color:#e6db74">.1f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">_precision&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask2, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">:</span><span style="color:#e6db74">.1f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">0.1</span><span style="color:#e6db74">:</span><span style="color:#e6db74">.1f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">_mean return&#39;</span>, <span style="color:#e6db74">&#39;count&#39;</span>] <span style="color:#f92672">=</span> len(sub<span style="color:#f92672">.</span>loc[mask2])
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> quantile <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;0~20&#39;</span>, <span style="color:#e6db74">&#39;20~40&#39;</span>, <span style="color:#e6db74">&#39;40~60&#39;</span>, <span style="color:#e6db74">&#39;60~80&#39;</span>, <span style="color:#e6db74">&#39;80~100&#39;</span>]:
</span></span><span style="display:flex;"><span>    mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_4Q&#39;</span>)
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;mean_</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask1, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;precision_</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]] <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[mask1, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>tolist()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res<span style="color:#f92672">.</span>columns
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example data with 8 categories</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Date&#39;</span>: pd<span style="color:#f92672">.</span>date_range(start<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2024-01-01&#39;</span>, periods<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Signal&#39;</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Category&#39;</span>: [<span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;C&#39;</span>, <span style="color:#e6db74">&#39;D&#39;</span>, <span style="color:#e6db74">&#39;E&#39;</span>, <span style="color:#e6db74">&#39;F&#39;</span>, <span style="color:#e6db74">&#39;G&#39;</span>, <span style="color:#e6db74">&#39;H&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>]}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get unique categories (suppose you have exactly 8 categories)</span>
</span></span><span style="display:flex;"><span>categories <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Category&#39;</span>]<span style="color:#f92672">.</span>unique()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Define the number of rows and columns for the subplots</span>
</span></span><span style="display:flex;"><span>n_rows, n_cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create subplots for each category in a 2x4 grid</span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(n_rows, n_cols, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">8</span>), sharex<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flatten the axes array for easier indexing</span>
</span></span><span style="display:flex;"><span>axes <span style="color:#f92672">=</span> axes<span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Loop through each category and plot</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, category <span style="color:#f92672">in</span> enumerate(categories):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Filter DataFrame by category</span>
</span></span><span style="display:flex;"><span>    category_df <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Category&#39;</span>] <span style="color:#f92672">==</span> category]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Get dates where Signal == 1 for that category</span>
</span></span><span style="display:flex;"><span>    signal_dates <span style="color:#f92672">=</span> category_df<span style="color:#f92672">.</span>loc[category_df[<span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;Date&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Plot vertical lines on the respective subplot</span>
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>vlines(x<span style="color:#f92672">=</span>signal_dates, ymin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, ymax<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;b&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Signal </span><span style="color:#e6db74">{</span>category<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Category </span><span style="color:#e6db74">{</span>category<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#39;Signal&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Format the x-axis for dates (shared x-axis)</span>
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>xaxis<span style="color:#f92672">.</span>set_major_formatter(plt<span style="color:#f92672">.</span>matplotlib<span style="color:#f92672">.</span>dates<span style="color:#f92672">.</span>DateFormatter(<span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>tick_params(axis<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;x&#39;</span>, rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Hide empty subplots if any (for cases when the grid is larger than needed)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, n_rows <span style="color:#f92672">*</span> n_cols):
</span></span><span style="display:flex;"><span>    fig<span style="color:#f92672">.</span>delaxes(axes[j])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set the xlabel for the subplots in the last row</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ax <span style="color:#f92672">in</span> axes[<span style="color:#f92672">-</span>n_cols:]:
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adjust layout</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>len(res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Plot 不同組合的signal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>n_rows, n_cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create subplots for each category in a 2x4 grid</span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(n_rows, n_cols, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">8</span>), sharex<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flatten the axes array for easier indexing</span>
</span></span><span style="display:flex;"><span>axes <span style="color:#f92672">=</span> axes<span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, ticker <span style="color:#f92672">in</span> enumerate(res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()):
</span></span><span style="display:flex;"><span>    sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker]
</span></span><span style="display:flex;"><span>    mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0~20_0Q&#39;</span>)
</span></span><span style="display:flex;"><span>    mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0~20_4Q&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>    sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sub.loc[mask1 &amp; mask2, &#39;signal&#39;] = 1</span>
</span></span><span style="display:flex;"><span>    sub<span style="color:#f92672">.</span>loc[mask2, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">331</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># axes[i].set_title(f&#39;{ticker}_0Q 80~100, 4Q 0~20&#39;)</span>
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>ticker<span style="color:#e6db74">}</span><span style="color:#e6db74">_4Q 0~20&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2 <span style="color:#f92672">=</span> axes[i]<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>vlines(sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;日期_dt&#39;</span>], ymin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, ymax<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;signal&#39;</span>, colors<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
</code></pre>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_1.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_2.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_3.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_4.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_5.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_6.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_7.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_8.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_9.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_188_10.png" alt="png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Plot 不同組合的signal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PEG ver.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>n_rows, n_cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create subplots for each category in a 2x4 grid</span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(n_rows, n_cols, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">8</span>), sharex<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flatten the axes array for easier indexing</span>
</span></span><span style="display:flex;"><span>axes <span style="color:#f92672">=</span> axes<span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, ticker <span style="color:#f92672">in</span> enumerate(res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()):
</span></span><span style="display:flex;"><span>    sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;PEG_4Q&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;PEG_4Q&#39;</span>] <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0.9</span>) 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>    sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sub.loc[mask1 &amp; mask2, &#39;signal&#39;] = 1</span>
</span></span><span style="display:flex;"><span>    sub<span style="color:#f92672">.</span>loc[mask2, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">331</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># axes[i].set_title(f&#39;{ticker}_0Q 80~100, 4Q 0~20&#39;)</span>
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>ticker<span style="color:#e6db74">}</span><span style="color:#e6db74">_4Q, PEG 0.7~0.9&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2 <span style="color:#f92672">=</span> axes[i]<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>vlines(sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;日期_dt&#39;</span>], ymin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, ymax<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;signal&#39;</span>, colors<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
</code></pre>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_1.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_2.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_3.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_4.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_5.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_6.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_7.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_8.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_9.png" alt="png"></p>
<p><img src="../../images/industry_project/2_post.md/Final_test_189_10.png" alt="png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;80~100_0Q&#39;</span>)
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span>  (sub[<span style="color:#e6db74">&#39;cata_4Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0~20_4Q&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[mask1 <span style="color:#f92672">&amp;</span> mask2, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q holding 120 ret&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>ax2 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>ax2<span style="color:#f92672">.</span>vlines(sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;日期_dt&#39;</span>], ymin<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, ymax<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;signal&#39;</span>, colors<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>legend()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>signal_dates <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>values
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>vlines(x<span style="color:#f92672">=</span>signal_dates,  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;signal&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[mask1, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;cata_0Q&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0~20_0Q&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]<span style="color:#f92672">.</span>values
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>preview_res<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_indexPE <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>merge(IndexPE_res, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>IndexPE_res<span style="color:#f92672">.</span>columns
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_indexPE[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> IndexPE_res<span style="color:#f92672">.</span>loc[(IndexPE_res[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;20030701&#39;</span>) <span style="color:#f92672">&amp;</span> (IndexPE_res[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#39;20101231&#39;</span>), [<span style="color:#e6db74">&#39;日期_dt&#39;</span>,<span style="color:#e6db74">&#39;agg_PE_0Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_1Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_2Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_3Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_4Q&#39;</span>]]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> IndexPE_res<span style="color:#f92672">.</span>loc[(IndexPE_res[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;20101231&#39;</span>) <span style="color:#f92672">&amp;</span> (IndexPE_res[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#39;20191231&#39;</span>), [<span style="color:#e6db74">&#39;日期_dt&#39;</span>,<span style="color:#e6db74">&#39;agg_PE_0Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_1Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_2Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_3Q&#39;</span>, <span style="color:#e6db74">&#39;agg_PE_4Q&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res_indexPE<span style="color:#f92672">.</span>loc[(res_indexPE[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;20121231&#39;</span>) <span style="color:#f92672">&amp;</span> (res_indexPE[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#39;20240509&#39;</span>) <span style="color:#f92672">&amp;</span> (res_indexPE[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>), [<span style="color:#e6db74">&#39;日期_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;agg_PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> res_indexPE<span style="color:#f92672">.</span>loc[(res_indexPE[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;20161231&#39;</span>) <span style="color:#f92672">&amp;</span> (res_indexPE[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#39;20231109&#39;</span>) <span style="color:#f92672">&amp;</span> (res_indexPE[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;8069&#39;</span>), [<span style="color:#e6db74">&#39;日期_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>,<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;agg_PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>ticker <span style="color:#f92672">=</span> sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Index PE vs </span><span style="color:#e6db74">{</span>ticker<span style="color:#e6db74">}</span><span style="color:#e6db74">_forward</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>ticker<span style="color:#e6db74">}</span><span style="color:#e6db74">_PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;agg_PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;index_PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>legend()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ticker <span style="color:#f92672">=</span> (res_indexPE[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>)
</span></span><span style="display:flex;"><span>q <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">8</span>]:
</span></span><span style="display:flex;"><span>    signal <span style="color:#f92672">=</span> (res_indexPE[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>q<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">&gt;</span>res_indexPE[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;agg_PE_</span><span style="color:#e6db74">{</span>q<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]) <span style="color:#f92672">&amp;</span> (res_indexPE[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>q<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>]<span style="color:#f92672">&lt;</span>res_indexPE[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;q</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">0&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># tmp.loc[f&#39;&lt;q{i}0&#39;, [&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]] = res_indexPE.loc[signal, [&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].mean()</span>
</span></span><span style="display:flex;"><span>    tmp<span style="color:#f92672">.</span>loc[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;q</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">0&#39;</span>, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]] <span style="color:#f92672">=</span> res_indexPE<span style="color:#f92672">.</span>loc[signal, [<span style="color:#e6db74">&#39;hold_5Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_10Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_winrate&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># res_indexPE.loc[signal, [&#39;hold_5Days_winrate&#39;, &#39;hold_10Days_winrate&#39;, &#39;hold_20Days_winrate&#39;, &#39;hold_60Days_winrate&#39;, &#39;hold_120Days_winrate&#39;]].describe()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tmp
</span></span></code></pre></div><p>cumsum or rolling min/max + shift 就可以了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_max</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    groupby ticker
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_cummax_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_max_PE&#39;</span>]<span style="color:#f92672">.</span>cummax()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_cummin_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>cummin()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_cummean_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>expanding()<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_max_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymin_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling3ymax_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_max_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">12</span>)<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling3ymin_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">12</span>)<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling3ymean_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">12</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling10ymax_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_max_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">40</span>)<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling10ymin_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">40</span>)<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling10ymean_PE&#39;</span>] <span style="color:#f92672">=</span> pe_res[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_min_PE&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">40</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span>        
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pe_res <span style="color:#f92672">=</span> pe_res<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(rolling_max)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># cumsum 至上一季 PE最高值, cumsum 至上一季 PE最低值, rolling 5y 至上一季 PE最高值,  rolling 5y 至上一季 PE最低值</span>
</span></span><span style="display:flex;"><span>pe_res<span style="color:#f92672">.</span>loc[(pe_res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) , [<span style="color:#e6db74">&#39;年季&#39;</span>, <span style="color:#e6db74">&#39;1_cummax_PE&#39;</span>, <span style="color:#e6db74">&#39;1_cummin_PE&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymax_PE&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymin_PE&#39;</span>]]
</span></span></code></pre></div><h3 id="把-截至上一季-pe的高低點-算出來後-與股價merge">把 截至上一季 PE的高低點 算出來後 與股價merge</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df <span style="color:#f92672">=</span> combine_df<span style="color:#f92672">.</span>merge(pe_res, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;年季&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;年季&#39;</span>]), suffixes<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;_MINMAX&#39;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>loc[(combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) <span style="color:#f92672">&amp;</span> (combine_df[<span style="color:#e6db74">&#39;年季&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;202301&#39;</span>) , [<span style="color:#e6db74">&#39;日期&#39;</span>,<span style="color:#e6db74">&#39;PE_1Q&#39;</span> ,<span style="color:#e6db74">&#39;1_cummax_PE&#39;</span>, <span style="color:#e6db74">&#39;1_cummin_PE&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymax_PE&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymin_PE&#39;</span>]]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>loc[(combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2454&#39;</span>), [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;PE_1Q&#39;</span>, <span style="color:#e6db74">&#39;knowNext1Q&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymax_PE&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymin_PE&#39;</span>, <span style="color:#e6db74">&#39;1_rolling5ymean_PE&#39;</span>]]<span style="color:#f92672">.</span>dropna()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_5y最高價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_5y最低價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymin_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_5y平均價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_3y最高價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling3ymax_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_3y最低價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling3ymin_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_3y平均價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling3ymean_PE&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_10y最高價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling10ymax_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_10y最低價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling10ymin_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_10y平均價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling10ymean_PE&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_cumsum最高價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_cummax_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_cumsum最低價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_cummin_PE&#39;</span>]
</span></span><span style="display:flex;"><span>    combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q_cumsum平均價&#39;</span>] <span style="color:#f92672">=</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;knowNext</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">*</span> combine_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_cummean_PE&#39;</span>]    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#  在知曉下一季EPS後 利用過往3季 + 未來1季 去算年度EPS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  在用該EPS 與當下股價計算 預知PE</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 期間預知PE的min, max 將獨立出來</span>
</span></span><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>loc[(combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;8069&#39;</span>) <span style="color:#f92672">&amp;</span> (combine_df[<span style="color:#e6db74">&#39;年季&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;202301&#39;</span>), [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;PE_1Q&#39;</span>, <span style="color:#e6db74">&#39;1_max_PE&#39;</span>, <span style="color:#e6db74">&#39;1_min_PE&#39;</span>, <span style="color:#e6db74">&#39;1_mean_PE&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_60Days_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_120Days_ret&#39;</span>]]
</span></span></code></pre></div><h3 id="繪製本益比河流圖時-河流應為過去一段時間的min-max">繪製本益比河流圖時 河流應為過去一段時間的min, max</h3>
<p>ex : under 知曉下一Q EPS的情況下<br>
過去10年 所有在知曉下一Q對應的EPS<br>
min, max 作為河流 對照如今的 預知PE</p>
<p>可以try 的財務指標</p>
<ol>
<li>存貨(千)</li>
<li>研發費用(千)</li>
<li>PPE (不動產相關的變化)</li>
</ol>
<p>先做圖 在想要怎麼辦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">30</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">30</span>:<span style="color:#ae81ff">60</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">60</span>:<span style="color:#ae81ff">90</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">90</span>:<span style="color:#ae81ff">120</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">120</span>:<span style="color:#ae81ff">150</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">150</span>:<span style="color:#ae81ff">180</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">180</span>:<span style="color:#ae81ff">210</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> combine_df[combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_signal</span>(data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialize the signal and state</span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    data[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">.</span>loc[(data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal period</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># After hitting the lower bound, waiting for rebound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Rebounding, waiting for upper bound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_signal</span>(data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialize the signal and state</span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>    data[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">.</span>loc[(data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymin_PE&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal period</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymin_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># After hitting the lower bound, waiting for rebound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymin_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Rebounding, waiting for upper bound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 反向</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_signal_reverse</span>(data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialize the signal and state</span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    data[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">.</span>loc[(data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> (data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.7</span>)), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal period</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.7</span>):
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># After hitting the lower bound, waiting for rebound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Rebounding, waiting for upper bound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>]:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 反向</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_signal_reverse</span>(data):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialize the signal and state</span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    data[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">.</span>loc[(data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> (data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">1.2</span>)) <span style="color:#f92672">*</span> (data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&lt;=</span> (data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>)), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> data<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normal period</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">1.2</span>):
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># After hitting the lower bound, waiting for rebound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymax_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.9</span>):
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Rebounding, waiting for upper bound</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;PE_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Q&#39;</span>] <span style="color:#f92672">&gt;=</span> (row[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling5ymean_PE&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">1.2</span>):
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                data<span style="color:#f92672">.</span>at[idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>signal_df <span style="color:#f92672">=</span> combine_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(set_signal)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>signal_df <span style="color:#f92672">=</span> combine_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(set_signal_reverse)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest_delay_entering</span>(df, delay_days):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># prodction ver.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># input: df, 需要有signal columns, output : [{trade_data1}, {trade_data2}, ...] (list中包含多個dict)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4](cumsum)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## 想要include 最新持有的狀態 -&gt; 若是最後一個row 的連續持有日期 &gt;=4 (3個訊號 隔日才會買進 目前沒有持有)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## return的計算 要改</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyError</span>(<span style="color:#e6db74">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 用來確認退場reaso</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span style="display:flex;"><span>    change_indices <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">!=</span> df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>cumsum() 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 只想要group signal==1的事件</span>
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(change_indices[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    event_list_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _, group <span style="color:#f92672">in</span> groups:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(group) <span style="color:#f92672">&lt;=</span> delay_days:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 訊號數不足 不會進場</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            group<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            group <span style="color:#f92672">=</span> group<span style="color:#f92672">.</span>iloc[delay_days::]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># extract info from group</span>
</span></span><span style="display:flex;"><span>        trading_dict <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;股票代號&#39;</span>: group[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;買入日期&#39;</span>: group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;賣出日期&#39;</span>: group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;買入價&#39;</span> : group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;賣出價&#39;</span> : group[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;期間最高價&#39;</span> : group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>max(),
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;持有天數&#39;</span> : len(group),
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;持有狀態&#39;</span> : <span style="color:#e6db74">&#39;history&#39;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#e6db74">&#39;return&#39;</span> :  (group[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span>group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        event_list_all<span style="color:#f92672">.</span>append(trading_dict)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># production情況下 每日最新一個group的狀況不一定</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    原本是收盤後跑 下午3點跑
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    改為開盤前 早上8點跑 這樣昨天的data一定更新好了 故 持有狀態的用詞修改
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    從buy_tomorrow -&gt; buy_today
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> event_list_all
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>vector_backtest_delay_entering(sub, <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res <span style="color:#f92672">=</span> signal_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_delay_entering(df, <span style="color:#ae81ff">0</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Simulated data with multiple cycles</span>
</span></span><span style="display:flex;"><span>dates <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime([
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;2024-01-01&#39;</span>, <span style="color:#e6db74">&#39;2024-01-02&#39;</span>, <span style="color:#e6db74">&#39;2024-01-03&#39;</span>, <span style="color:#e6db74">&#39;2024-01-04&#39;</span>, <span style="color:#e6db74">&#39;2024-01-05&#39;</span>,  
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;2024-01-06&#39;</span>, <span style="color:#e6db74">&#39;2024-01-07&#39;</span>, <span style="color:#e6db74">&#39;2024-01-08&#39;</span>,  
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;2024-01-09&#39;</span>, <span style="color:#e6db74">&#39;2024-01-10&#39;</span>, <span style="color:#e6db74">&#39;2024-01-11&#39;</span>, <span style="color:#e6db74">&#39;2024-01-12&#39;</span>,  
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;2024-01-13&#39;</span>, <span style="color:#e6db74">&#39;2024-01-14&#39;</span>,  
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;2024-01-15&#39;</span>, <span style="color:#e6db74">&#39;2024-01-16&#39;</span>, <span style="color:#e6db74">&#39;2024-01-17&#39;</span>,  
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;2024-01-18&#39;</span>, <span style="color:#e6db74">&#39;2024-01-19&#39;</span>, <span style="color:#e6db74">&#39;2024-01-20&#39;</span>
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Simulated P/E ratios</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;PE_ratio&#39;</span>: [<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">23</span>,  
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">11</span>,  
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">20</span>,  
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">36</span>,  
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">12</span>,  
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">20</span>],  
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Adj Close&#39;</span>: np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randn(len(dates)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>  
</span></span><span style="display:flex;"><span>}, index<span style="color:#f92672">=</span>dates)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Parameters</span>
</span></span><span style="display:flex;"><span>lower_bound <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>upper_bound <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Initialize the signal and state</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">.</span>loc[(data[<span style="color:#e6db74">&#39;PE_ratio&#39;</span>] <span style="color:#f92672">&lt;=</span> lower_bound), <span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>  <span style="color:#75715e"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(data)):
</span></span><span style="display:flex;"><span>    pe_ratio <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>iloc[i][<span style="color:#e6db74">&#39;PE_ratio&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Normal period</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pe_ratio <span style="color:#f92672">&lt;=</span> lower_bound:
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>at[data<span style="color:#f92672">.</span>index[i], <span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># After hitting the lower bound, waiting for rebound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pe_ratio <span style="color:#f92672">&gt;</span> lower_bound:
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>at[data<span style="color:#f92672">.</span>index[i], <span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> state <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Rebounding, waiting for upper bound</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> pe_ratio <span style="color:#f92672">&gt;=</span> upper_bound:
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>at[data<span style="color:#f92672">.</span>index[i], <span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>at[data<span style="color:#f92672">.</span>index[i], <span style="color:#e6db74">&#39;Signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Filtered Data with Signals:&#34;</span>)
</span></span><span style="display:flex;"><span>print(data)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>trading_dict <span style="color:#f92672">=</span> signal_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_delay_entering(df, <span style="color:#ae81ff">0</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span> <span style="color:#75715e"># 整理backtest result</span>
</span></span><span style="display:flex;"><span>code <span style="color:#f92672">=</span> signal_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> code:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> trading_dict[c]
</span></span><span style="display:flex;"><span>    tmp_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(tmp)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tmp_df<span style="color:#f92672">.</span>empty:
</span></span><span style="display:flex;"><span>        res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([res_df, tmp_df], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>code
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;precision&#39;</span>] <span style="color:#f92672">=</span> res_df[<span style="color:#e6db74">&#39;return&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[[<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;precision&#39;</span>,<span style="color:#e6db74">&#39;持有天數&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2383&#39;</span>, [<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;持有天數&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> code:
</span></span><span style="display:flex;"><span>    print(i)
</span></span><span style="display:flex;"><span>    print(res_df<span style="color:#f92672">.</span>loc[res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>i, [<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;持有天數&#39;</span>]]<span style="color:#f92672">.</span>describe())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>trading_dict[<span style="color:#e6db74">&#39;2059&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;forwardPE&#39;</span>]<span style="color:#f92672">.</span>expanding()<span style="color:#f92672">.</span>std()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># combine_df = price_df.merge(resample_mon_df, how=&#39;left&#39;, left_on=([&#39;日期_dt&#39;, &#39;股票代號&#39;]), right_on=([&#39;公告日_dt&#39;, &#39;股票代號&#39;]))</span>
</span></span></code></pre></div><h2 id="columns-展示">columns 展示</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">30</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">30</span>:<span style="color:#ae81ff">60</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">60</span>:<span style="color:#ae81ff">90</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">90</span>:<span style="color:#ae81ff">120</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">120</span>:<span style="color:#ae81ff">150</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">150</span>:<span style="color:#ae81ff">180</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create subplots without shared axes</span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flatten the axes array for easy iteration</span>
</span></span><span style="display:flex;"><span>axes <span style="color:#f92672">=</span> axes<span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Group by &#39;Stock&#39; and plot each group in a separate subplot</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ax, (name, group) <span style="color:#f92672">in</span> zip(axes, combine_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)):
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>plot(group[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], group[<span style="color:#e6db74">&#39;收盤價&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Price&#39;</span>)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_title(name)
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ax.set_ylabel(&#39;Price&#39;, color=&#39;blue&#39;)</span>
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create a secondary y-axis and plot &#39;Volume&#39;</span>
</span></span><span style="display:flex;"><span>    ax2 <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>plot(group[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], group[<span style="color:#e6db74">&#39;稅後純益率(%)&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;net profit ratio&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ax2.set_ylabel(&#39;monthly rev&#39;, color=&#39;green&#39;)</span>
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Set axis colors to match the data they represent</span>
</span></span><span style="display:flex;"><span>    ax<span style="color:#f92672">.</span>tick_params(axis<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;y&#39;</span>, labelcolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>tick_params(axis<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;y&#39;</span>, labelcolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;green&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adjust layout to prevent overlap</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Show the plot</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>loc[combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;8069&#39;</span>, <span style="color:#e6db74">&#39;近三月合併營收(千)&#39;</span>]<span style="color:#f92672">.</span>plot()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> combine_df<span style="color:#f92672">.</span>loc[combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;3529&#39;</span>]
</span></span></code></pre></div><p><img src="../../images/industry_project/2_post.md/image_2024-08-15_11-38-01.png" alt="image_2024-08-15_11-38-01.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;2317&#39;</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;公告日_dt&#39;</span>], sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>],  label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>ax2 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>ax2<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;公告日_dt&#39;</span>], sub[<span style="color:#e6db74">&#39;近12月累計合併營收(千)&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;12m_rev_agg&#39;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p>指標相關聯 我覺得應該不只是財務數據 也有其他的東西但我們無法access<br>
籌碼相關, 分析師估值等<br>
但以我目前的情況 應該是做估值 並建立買賣點<br>
-&gt; 存貨</p>
<p>大概看了一下 營收的趨勢整體多為向上，股價也是 但若將週期縮小至2-3個月 營收與股價背離的情況很常發生<br>
判斷營收成長 or 衰退的趨勢 其time frame也要抓好<br>
畢竟營收整個趨勢變化較慢 但方向較穩定 但股價有更多雜訊因素</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> combine_df[combine_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> sub[(<span style="color:#f92672">~</span>sub[<span style="color:#e6db74">&#39;3m_diff&#39;</span>]<span style="color:#f92672">.</span>isna()) <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">~</span>sub[<span style="color:#e6db74">&#39;12m_diff&#39;</span>]<span style="color:#f92672">.</span>isna())]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>sum()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>combine_df<span style="color:#f92672">.</span>columns[<span style="color:#f92672">-</span><span style="color:#ae81ff">60</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">30</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;optimize&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;3m_diff&#39;</span>] <span style="color:#f92672">&gt;</span> sub[<span style="color:#e6db74">&#39;12m_diff&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;近三月合併營收(千)&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;3m_diff&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ae81ff">694442123</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">673510177</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div>
                

                
            </div>
        </div>

    </article>


    </main>

     
    <footer>
        <div class="row">
            <div class="col-full">

                <div class="footer-logo">
                    <a class="footer-site-logo" href="../../"><img src="../../images/logo.png" alt="Homepage"></a>
                </div>

                <ul class="footer-social">
                    <li><a href="#0">
                        <i class="im im-facebook" aria-hidden="true"></i>
                        <span>Facebook</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-instagram" aria-hidden="true"></i>
                        <span>Instagram</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-behance" aria-hidden="true"></i>
                        <span>Behance</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-pinterest" aria-hidden="true"></i>
                        <span>Pinterest</span>
                    </a></li>
                </ul>
                    
            </div>
        </div>

        <div class="row footer-bottom">

            <div class="col-twelve">
                <div class="copyright">
                    <span>© Copyright Hola 2017</span> 
                    <span>Design by <a href="https://www.styleshout.com/">styleshout</a></span>	
                </div>

                <div class="go-top">
                <a class="smoothscroll" title="Back to Top" href="#top"><i class="im im-arrow-up" aria-hidden="true"></i></a>
                </div>
            </div>

        </div> 

    </footer> 
   


    
    <div aria-hidden="true" class="pswp" role="dialog" tabindex="-1">

        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">

            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>

            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title=
                    "Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title=
                    "Zoom in/out"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                            <div class="pswp__preloader__cut">
                                <div class="pswp__preloader__donut"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div>
                </div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title=
                "Next (arrow right)"></button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>

        </div>

    </div>

    <div id="preloader">
        <div id="loader"></div>
    </div>


    
    

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/plugins.js"></script>
    <script src="../../js/main.js"></script>


</body>

</html>