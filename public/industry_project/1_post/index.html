<!DOCTYPE html>



<html class="no-js" lang="en">


<head><script src="/hugoSite/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=hugoSite/livereload" data-no-instant defer></script>

    
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="author" content="">

    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/vendor.css">
    <link rel="stylesheet" href="../../css/main.css">


    
    

    <script src="../../js/modernizr.js"></script>
    <script src="../../js/pace.min.js"></script>
    
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

</head>

<body id="top">
        
    
    
    
    
     <header class="s-header">
        <div class="header-logo">
            <a class="site-logo" href="../../"><img src="../../images/logo.png" alt="Homepage"></a>
        </div>

        <nav class="header-nav-wrap">
            <ul class="header-nav">
                <li><a href="../../#home" title="home">Home</a></li>
                <li><a href="../../#about" title="about">About</a></li>
                <li><a href="../../#works" title="works">Works</a></li>
                <li><a href="../../#blog" title="works">Blog Section</a></li>
                <li class="current"><a href="../../blog/" title="blog">Blog</a></li>
                
            </ul>
        </nav>

        <a class="header-menu-toggle" href="#0"><span>Menu</span></a>
    </header>
    

    <main>
        

    <article class="blog-single">

        <div class="page-header page-header--single page-hero" style="background-image:url(/images/blog/blog-bg-02.jpg)">
            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                            <a href="../../categories">Branding</a><a href="../../categories">Design</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        9 tickers dive in
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">February 16, 2025</li>
                        <li class="author">
                            By <span>Robert Hsu</span>
                        </li>
                    </ul>
                </article>
            </div>
        </div>

        <div class="row blog-content">
            <div class="col-full blog-content__main">
                <h2 id="9-tickers-轉折">9 tickers 轉折</h2>
<p>first look 如何定義轉折</p>
<ol>
<li>趨勢拆分 -&gt; 上漲/盤整/下跌 可以用一條趨勢線(均線)來判斷</li>
<li>轉折建立在趨勢之上 轉折就是趨勢的改變 上漲-&gt;盤整/下跌, 下跌-&gt; 盤整/上漲, 盤整-&gt;上漲/下跌<br>
技術類分析最重要的是 訊號統計的時間長短 就像長天期均線的長期趨勢, 短天期的短期趨勢 也可能會有背離的情況</li>
</ol>
<h2 id="default-setting---keep-holding">Default setting -&gt; keep holding</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/org_price.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050 <span style="color:#f92672">=</span> price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;0050&#39;</span>]
</span></span><span style="display:flex;"><span>price0050[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price0050[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>price0050<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price0050<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_6936/2447510086.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050['日期_dt'] = pd.to_datetime(price0050['日期'])
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_6936/2447510086.py:3: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050.sort_values('日期_dt', inplace=True, ascending=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>SUB_TICKERS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;2059&#39;</span>, <span style="color:#e6db74">&#39;3529&#39;</span>, <span style="color:#e6db74">&#39;2383&#39;</span>, <span style="color:#e6db74">&#39;2330&#39;</span>, <span style="color:#e6db74">&#39;8069&#39;</span>, <span style="color:#e6db74">&#39;5274&#39;</span>, <span style="color:#e6db74">&#39;3008&#39;</span>, <span style="color:#e6db74">&#39;2454&#39;</span>, <span style="color:#e6db74">&#39;3533&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price_df[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">holding_nDays</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span>n) <span style="color:#f92672">/</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#75715e"># 實際上隔日才能操作</span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;last_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>shift(n <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#75715e"># 實際上隔日才能操作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(holding_nDays)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_6936/392270890.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050 <span style="color:#f92672">=</span> price0050<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(holding_nDays)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_6936/2395123834.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price0050 = price0050.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<h3 id="可不可以-給一個策略當作input-df-w-signal-columns---output-buyhold-signal-based-trading-result--pkl-for-backtesting">可不可以 給一個策略當作input df (w/ signal columns) -&gt; output buy&amp;hold/ signal based trading result &amp; pkl for backtesting</h3>
<p>即使buy&amp;hold 的勝率多次贏過本身 但是考慮手續費之後 PnL仍是輸<br>
若是使用betting的方式 需要開槓桿 但槓桿太大前期爆掉 最終仍是輸<br>
也許勝率不是那麼重要 期望報酬要高過一般日子才行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(price0050, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), suffixes<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;_0050&#39;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin([<span style="color:#e6db74">&#39;2330&#39;</span>, <span style="color:#e6db74">&#39;8069&#39;</span>])), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;5MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;10MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">10</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">60</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;400MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span><span style="color:#f92672">*</span><span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;1200MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;400MA&#39;</span>]) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>]) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;5MA&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tmp <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;PE&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;收盤價&#39;</span>],color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>set_title(ticker)
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><p><img src="../../images/industry_project/9tickers_trend_19_0.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_1.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_2.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_3.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_4.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_5.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_6.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_7.png" alt="png"></p>
<p><img src="../../images/industry_project/9tickers_trend_19_8.png" alt="png"></p>
<h2 id="想法1">想法1.</h2>
<p>我們就做長期 依據財報, PE等方式去做一個長期策略 -&gt; 一次bet 一季 只要能避開大跌的期間 以60~70 time in markets 去beat buy&amp;hold挺有機會的<br>
至少我們交易的很不頻繁</p>
<h2 id="想法2">想法2.</h2>
<p>短期的策略 就以輔助的方式搭配 不要求訊號數量, 次數, 集中度 單純以buy&amp;hold勝率為依歸 這樣一定可以增加組合策略的勝率</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tmp[<span style="color:#e6db74">&#39;&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>, [<span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;hold_5Days_ret&#39;</span>, <span style="color:#e6db74">&#39;last_5Days_ret&#39;</span>]]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>::]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>margin_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/dayMarginTrading.ftr&#39;</span>, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;資餘&#39;</span>, <span style="color:#e6db74">&#39;券餘&#39;</span>, <span style="color:#e6db74">&#39;券資比&#39;</span>, <span style="color:#e6db74">&#39;當沖比率&#39;</span>, <span style="color:#e6db74">&#39;融資成本(推估)&#39;</span>, <span style="color:#e6db74">&#39;融券成本(推估)&#39;</span>, <span style="color:#e6db74">&#39;融資維持率(%)&#39;</span>, <span style="color:#e6db74">&#39;融券維持率(%)&#39;</span>,<span style="color:#e6db74">&#39;整體維持率(%)&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(margin_df, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>] <span style="color:#f92672">=</span> ((price_df[<span style="color:#e6db74">&#39;融資維持率(%)&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.6</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span><span style="color:#ae81ff">100</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ae81ff">1085</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1040</span>
</span></span></code></pre></div><pre><code>1.0432692307692308
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;10MA&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;5MA&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;10MA&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_5Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;last_5Days_ret_0050&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_60Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>]) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;last_60Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;last_5Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;last_5Days_ret_0050&#39;</span>])
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;last_10Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;last_10Days_ret_0050&#39;</span>])
</span></span><span style="display:flex;"><span>mask3 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;last_20Days_ret&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>])
</span></span><span style="display:flex;"><span>mask4 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>])
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask1 <span style="color:#f92672">&amp;</span> mask2 <span style="color:#f92672">&amp;</span> mask3 <span style="color:#f92672">&amp;</span> mask4 , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;last_5Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;last_5Days_ret_0050&#39;</span>])
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;last_10Days_ret&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;last_10Days_ret_0050&#39;</span>])
</span></span><span style="display:flex;"><span>mask3 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;last_20Days_ret&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>])
</span></span><span style="display:flex;"><span>mask4 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>])
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask4 , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ret_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span> <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span><span style="display:flex;"><span>winrate_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span> <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;y-m&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">_</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year, price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>month)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;y-m&#39;</span>] 
</span></span></code></pre></div><pre><code>0        0        2005\n1        2005\n2        2005\n3...
1        0        2005\n1        2005\n2        2005\n3...
2        0        2005\n1        2005\n2        2005\n3...
3        0        2005\n1        2005\n2        2005\n3...
4        0        2005\n1        2005\n2        2005\n3...
                               ...                        
46258    0        2005\n1        2005\n2        2005\n3...
46259    0        2005\n1        2005\n2        2005\n3...
46260    0        2005\n1        2005\n2        2005\n3...
46261    0        2005\n1        2005\n2        2005\n3...
46262    0        2005\n1        2005\n2        2005\n3...
Name: y-m, Length: 46263, dtype: object
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">/</span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.15</span>, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.ftr&#39;</span>)
</span></span></code></pre></div><p>python3 src/backtest.py /Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test_3533.pkl /Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/ticker_pnl/3533 &ndash;capital 1000000000 &ndash;start_date 20150101 &ndash;end_date 20241014 &ndash;commission 0.000855 &ndash;rebalance 0</p>
<h2 id="週集保">週集保</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/weeklyDepository.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie <span style="color:#f92672">=</span> weekly_depostie[weekly_depostie[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>weekly_depostie<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg <span style="color:#f92672">=</span> weekly_depostie[weekly_depostie[<span style="color:#e6db74">&#39;持股分級&#39;</span>]<span style="color:#f92672">.</span>isin([<span style="color:#e6db74">&#39;0400001-0600000&#39;</span>, <span style="color:#e6db74">&#39;0600001-0800000&#39;</span>, <span style="color:#e6db74">&#39;0800001-1000000&#39;</span>, <span style="color:#e6db74">&#39;1000001以上&#39;</span>])]<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>to_frame()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> company_event[company_event[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>date_pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;^\d</span><span style="color:#e6db74">{8}</span><span style="color:#e6db74">$&#39;</span>
</span></span><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> company_event[company_event[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(date_pattern)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(company_event[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;friday_of_week&#39;</span>] <span style="color:#f92672">=</span> company_event[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">+</span> pd<span style="color:#f92672">.</span>offsets<span style="color:#f92672">.</span>Week(weekday<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;adjust_week&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>company_event<span style="color:#f92672">.</span>loc[(company_event[<span style="color:#e6db74">&#39;新股上市&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#f92672">|</span> (company_event[<span style="color:#e6db74">&#39;減資前&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#39;adjust_week&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(agg[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;year&#39;</span>] <span style="color:#f92672">=</span> agg[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保月線&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保半年線&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保diff&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>diff()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>merge(company_event<span style="color:#f92672">.</span>loc[company_event[<span style="color:#e6db74">&#39;adjust_week&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, [<span style="color:#e6db74">&#39;friday_of_week&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;減資前&#39;</span>, <span style="color:#e6db74">&#39;新股上市&#39;</span>, <span style="color:#e6db74">&#39;adjust_week&#39;</span>]], how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;friday_of_week&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 有股數異動 當周週集保diff -&gt; 0</span>
</span></span><span style="display:flex;"><span>agg<span style="color:#f92672">.</span>loc[agg[<span style="color:#e6db74">&#39;adjust_week&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;週集保diff&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;週集保diff&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(agg, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>columns
</span></span></code></pre></div><pre><code>Index(['日期', '股票代號', '股票名稱', '開盤價', '最高價', '最低價', '收盤價', '漲跌', '漲幅(%)',
       '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張', '成交量變動(%)', '均張變動(%)',
       '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比', '本益比(近四季)', '週轉率(%)',
       '成交值比重(%)', '漲跌停', 'RTIME', '日期_dt_x', 'hold_5Days_ret',
       'last_5Days_ret', 'hold_5Days_winrate', 'hold_10Days_ret',
       'last_10Days_ret', 'hold_10Days_winrate', 'hold_20Days_ret',
       'last_20Days_ret', 'hold_20Days_winrate', 'hold_60Days_ret',
       'last_60Days_ret', 'hold_60Days_winrate', 'hold_120Days_ret',
       'last_120Days_ret', 'hold_120Days_winrate', '日期_0050', '股票代號_0050',
       '股票名稱_0050', '開盤價_0050', '最高價_0050', '最低價_0050', '收盤價_0050', '漲跌_0050',
       '漲幅(%)_0050', '振幅(%)_0050', '成交量_0050', '成交筆數_0050', '成交金額(千)_0050',
       '均張_0050', '成交量變動(%)_0050', '均張變動(%)_0050', '股本(百萬)_0050',
       '總市值(億)_0050', '市值比重(%)_0050', '本益比_0050', '股價淨值比_0050',
       '本益比(近四季)_0050', '週轉率(%)_0050', '成交值比重(%)_0050', '漲跌停_0050',
       'RTIME_0050', 'hold_5Days_ret_0050', 'last_5Days_ret_0050',
       'hold_5Days_winrate_0050', 'hold_10Days_ret_0050',
       'last_10Days_ret_0050', 'hold_10Days_winrate_0050',
       'hold_20Days_ret_0050', 'last_20Days_ret_0050',
       'hold_20Days_winrate_0050', 'hold_60Days_ret_0050',
       'last_60Days_ret_0050', 'hold_60Days_winrate_0050',
       'hold_120Days_ret_0050', 'last_120Days_ret_0050',
       'hold_120Days_winrate_0050', '佔集保庫存數比例(%)', '日期_dt_y', 'year', '週集保月線',
       '週集保半年線', '週集保diff', 'friday_of_week', '減資前', '新股上市', 'adjust_week',
       '週集保diff4week'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]
</span></span></code></pre></div><pre><code>0             NaN
1             NaN
2             NaN
3             NaN
4             NaN
           ...   
46258         NaN
46259         NaN
46260   -0.490007
46261         NaN
46262         NaN
Name: 週集保diff4week, Length: 46263, dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 近一個月 400張大戶 增加2%以上</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price_df[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h2 id="hold_10days_ret--2-可以beat-大盤-但不代表能beat-自己">hold_10Days_ret &gt; 2% 可以beat 大盤 但不代表能beat 自己&hellip;</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>print(price_df[price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean())
</span></span></code></pre></div><pre><code>      hold_5Days_ret  hold_10Days_ret  hold_20Days_ret  hold_60Days_ret  \
股票代號                                                                      
2059        0.005010         0.009969         0.020130         0.059021   
2330        0.005216         0.010177         0.020035         0.061843   
2383        0.005636         0.011274         0.022439         0.071093   
2454        0.004865         0.009519         0.019327         0.061709   
3008        0.004938         0.009546         0.019329         0.061985   
3529        0.007856         0.015724         0.032443         0.101927   
3533        0.007224         0.014696         0.030170         0.094578   
5274        0.009307         0.018046         0.035860         0.108759   
8069        0.005403         0.010970         0.022678         0.073954   

      hold_120Days_ret  
股票代號                    
2059          0.111671  
2330          0.133989  
2383          0.142366  
2454          0.121948  
3008          0.131951  
3529          0.228197  
3533          0.216573  
5274          0.222019  
8069          0.163949  
      hold_5Days_ret  hold_10Days_ret  hold_20Days_ret  hold_60Days_ret  \
股票代號                                                                      
2059        0.006141         0.011580         0.021498         0.061662   
2330        0.003288         0.007023         0.013864         0.040244   
2383        0.001164         0.003849         0.014555         0.079123   
2454        0.004328         0.008477         0.018784         0.056963   
3008        0.002090         0.005535         0.017011         0.060006   
3529        0.010187         0.019267         0.038427         0.094904   
3533        0.005359         0.013237         0.031580         0.086461   
5274        0.013677         0.022356         0.043726         0.127794   
8069        0.005168         0.010064         0.021985         0.065210   

      hold_120Days_ret  
股票代號                    
2059          0.136334  
2330          0.113531  
2383          0.154729  
2454          0.107311  
3008          0.088257  
3529          0.209398  
3533          0.189905  
5274          0.267122  
8069          0.121988  
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(price_df[price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean())
</span></span></code></pre></div><pre><code>      hold_5Days_ret  hold_10Days_ret  hold_20Days_ret  hold_60Days_ret  \
股票代號                                                                      
2059        0.001131         0.001611         0.001367         0.002641   
2330       -0.001929        -0.003154        -0.006171        -0.021600   
2383       -0.004471        -0.007425        -0.007884         0.008030   
2454       -0.000537        -0.001042        -0.000543        -0.004746   
3008       -0.002848        -0.004011        -0.002317        -0.001979   
3529        0.002331         0.003543         0.005984        -0.007023   
3533       -0.001865        -0.001459         0.001410        -0.008117   
5274        0.004370         0.004310         0.007865         0.019035   
8069       -0.000235        -0.000906        -0.000693        -0.008743   

      hold_120Days_ret  
股票代號                    
2059          0.024663  
2330         -0.020458  
2383          0.012362  
2454         -0.014637  
3008         -0.043694  
3529         -0.018799  
3533         -0.026669  
5274          0.045103  
8069         -0.041961  
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.df&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># input: df, 需要有signa columns, output : [[trade_data1], [trade_data2], ...] (list中包含多個list)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyError</span>(<span style="color:#e6db74">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span style="display:flex;"><span>    change_indices <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">!=</span> df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>cumsum() 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 只想要group signal==1的事件</span>
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(change_indices[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    event_list_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _, group <span style="color:#f92672">in</span> groups:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        com_code <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        start_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        end_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        buy_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        sell_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> (sell_price<span style="color:#f92672">/</span>buy_price) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        holding_days <span style="color:#f92672">=</span> len(group)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        event_list <span style="color:#f92672">=</span> [com_code, start_date, end_date, buy_price, sell_price, ret, holding_days]
</span></span><span style="display:flex;"><span>        event_list_all<span style="color:#f92672">.</span>append(event_list)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> event_list_all
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/406165768.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df.groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> res_list:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;訊號開始日&#39;</span>, <span style="color:#e6db74">&#39;訊號結束日&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>])
</span></span><span style="display:flex;"><span>    res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([res_df, tmp], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.1</span>, <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><pre><code>count    121.000000
mean     124.033058
std       53.726457
min       52.000000
25%       88.000000
50%      112.000000
75%      154.000000
max      373.000000
Name: 訊號持續天數, dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;5274&#39;</span>) <span style="color:#f92672">&amp;</span> (res_df[<span style="color:#e6db74">&#39;訊號開始日&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>::]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;adjust_return&#39;</span>] <span style="color:#f92672">=</span> res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.00585</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;winrate&#39;</span>] <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.00585</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2383&#39;</span>) <span style="color:#f92672">&amp;</span> mask, <span style="color:#e6db74">&#39;winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><pre><code>np.float64(0.45454545454545453)
</code></pre>
<h2 id="我覺得目前的goal-應該是-用50的time-in-market-去複製100的-buyhold-return">我覺得目前的goal 應該是 用50%的time in market 去複製100%的 buy&amp;hold return</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2383&#39;</span>), <span style="color:#e6db74">&#39;adjust_return&#39;</span>]<span style="color:#f92672">.</span>cumprod()
</span></span></code></pre></div><pre><code>117      1.810718
118      1.665188
119      1.443913
120      1.407983
121      1.391848
          ...    
173    109.515373
174    204.122405
175    180.569503
176    187.847619
177    181.006643
Name: adjust_return, Length: 61, dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;訊號開始日&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    print(ticker, <span style="color:#e6db74">&#39;-&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> mask, <span style="color:#e6db74">&#39;winrate&#39;</span>]<span style="color:#f92672">.</span>mean())
</span></span></code></pre></div><pre><code>2059 --------------------------------------------------
0.4
3529 --------------------------------------------------
0.55
2383 --------------------------------------------------
0.47619047619047616
2330 --------------------------------------------------
0.3888888888888889
8069 --------------------------------------------------
0.34782608695652173
5274 --------------------------------------------------
0.48
3008 --------------------------------------------------
0.36363636363636365
2454 --------------------------------------------------
0.375
3533 --------------------------------------------------
0.56
</code></pre>
<h2 id="這些訊號給出來的metric-像是勝率-return-持有天數等-跟-他最後會不會beat-自己buyhold-幾乎沒有關係啊">這些訊號給出來的metric, 像是勝率, return, 持有天數等 跟 他最後會不會beat 自己buy&amp;hold 幾乎沒有關係啊</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;訊號開始日&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    print(ticker, <span style="color:#e6db74">&#39;-&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> mask, <span style="color:#e6db74">&#39;adjust_return&#39;</span>]<span style="color:#f92672">.</span>cumprod())
</span></span></code></pre></div><pre><code>2059 --------------------------------------------------
24    1.073704
25    1.018269
26    0.945617
27    0.845300
28    0.842448
29    0.910435
30    0.898349
31    0.855847
32    0.859924
33    0.801080
34    0.877663
35    0.833737
36    0.858505
37    1.056661
38    1.195902
39    1.073666
40    0.940826
41    0.824905
42    1.851978
43    1.812821
44    2.450083
45    2.413792
46    1.736088
47    1.803436
48         NaN
Name: adjust_return, dtype: float64
3529 --------------------------------------------------
290    1.076862
291    1.167435
292    1.126389
293    1.205862
294    1.234166
295    1.300546
296    1.197866
297    1.587103
298    1.434322
299    1.238858
300    2.135981
301    6.921280
302    5.858060
303    7.066384
304    5.178796
305    6.127953
306    5.022745
307    5.493311
308    5.414622
309         NaN
Name: adjust_return, dtype: float64
2383 --------------------------------------------------
157    1.112279
158    1.625003
159    2.777402
160    2.411179
161    2.159258
162    2.034499
163    1.706952
164    1.923004
165    2.544269
166    2.371492
167    3.023427
168    2.996076
169    2.868855
170    3.427143
171    3.302461
172    2.672966
173    2.702668
174    5.037422
175    4.456173
176    4.635785
177    4.466961
Name: adjust_return, dtype: float64
2330 --------------------------------------------------
99     1.001018
100    0.951451
101    0.914398
102    1.073984
103    1.359107
104    1.228982
105    1.201381
106    1.191747
107    1.494818
108    3.089858
109    3.087672
110    2.853159
111    2.624442
112    2.417448
113    2.496526
114    2.387259
115    4.267665
116         NaN
Name: adjust_return, dtype: float64
8069 --------------------------------------------------
406    0.932812
407    0.862994
408    0.731373
409    0.709861
410    0.675080
411    0.868220
412    0.987306
413    1.468501
414    1.378200
415    1.281044
416    1.176988
417    1.093618
418    0.938823
419    0.915257
420    1.304457
421    2.408282
422    3.418989
423    3.124307
424    2.933280
425    2.596925
426    2.436734
427    2.860606
428    3.534959
Name: adjust_return, dtype: float64
5274 --------------------------------------------------
356    0.904797
357    0.973301
358    0.850189
359    0.709661
360    1.012892
361    1.373308
362    1.357244
363    1.285224
364    1.465160
365    1.145891
366    1.364235
367    1.299606
368    1.883455
369    2.176361
370    1.947718
371    2.622040
372    2.722958
373    4.100028
374    3.303204
375    2.813203
376    2.285256
377    2.561143
378    2.513802
379    3.184337
380    2.797540
Name: adjust_return, dtype: float64
3008 --------------------------------------------------
258    0.841805
259    1.122336
260    1.459913
261    1.414091
262    1.437946
263    1.217818
264    1.412450
265    1.504805
266    1.385123
267    1.499093
268    1.486417
269    1.344414
270    1.223020
271    1.147694
272    0.994990
273    1.185986
274    1.176260
275    1.089812
276    1.004914
277    0.980553
278    1.132073
279    1.130728
Name: adjust_return, dtype: float64
2454 --------------------------------------------------
209    0.786954
210    0.796381
211    0.642395
212    0.707082
213    0.693239
214    0.839686
215    0.827908
216    0.830901
217    0.763173
218    1.229403
219    1.876080
220    2.592754
221    2.548452
222    2.304537
223    2.232255
224    2.184971
225    1.650349
226    1.561482
227    1.355056
228    1.315666
229    1.829784
230    1.889384
231    1.710543
232         NaN
Name: adjust_return, dtype: float64
3533 --------------------------------------------------
325    0.942288
326    1.023214
327    0.957079
328    0.856791
329    0.797596
330    0.798283
331    1.285934
332    1.172076
333    1.177846
334    1.184177
335    1.352032
336    1.760839
337    2.377330
338    2.208059
339    2.452912
340    2.617768
341    3.336348
342    2.708993
343    2.840251
344    2.765888
345    2.598835
346    2.516225
347    2.636359
348    3.972125
349         NaN
Name: adjust_return, dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>::]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;return&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><pre><code>股票代號
2059    0.004077
2330    0.002834
2383    0.004765
2454    0.001114
3008    0.001128
3529    0.002985
3533    0.008237
5274    0.001990
8069    0.003285
Name: return, dtype: float64
</code></pre>
<h2 id="benchmark-buyhold-all-return---start-2016">benchmark buy&amp;hold all return -&gt; start 2016</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20030101&#39;</span>)]
</span></span></code></pre></div><h2 id="年化26---100-1000的股票in-10y">年化26% -&gt; 100-&gt;1000的股票in 10y</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>(<span style="color:#ae81ff">1.26</span>)<span style="color:#f92672">**</span><span style="color:#ae81ff">10</span>
</span></span></code></pre></div><h2 id="在做複雜的test-之前-我們來簡單搞一個">在做複雜的test 之前 我們來簡單搞一個</h2>
<p>如果20日線 &gt; 60日線 持有反之賣出<br>
我們來看這樣的持有時間長短, 最終return 並用quntstats present</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;20030101&#39;</span>)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.signal <span style="color:#f92672">import</span> argrelextrema
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example stock price data</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series([np<span style="color:#f92672">.</span>nan, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">102</span>, <span style="color:#ae81ff">105</span>, <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">103</span>, <span style="color:#ae81ff">95</span>, <span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">98</span>, np<span style="color:#f92672">.</span>nan])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 1: Identify local maxima and minima (avoid future data)</span>
</span></span><span style="display:flex;"><span>window <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>local_max_indices <span style="color:#f92672">=</span> argrelextrema(data<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>local_min_indices <span style="color:#f92672">=</span> argrelextrema(data<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(data<span style="color:#f92672">.</span>iloc[local_max_indices]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>index[local_max_indices])
</span></span><span style="display:flex;"><span>local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(data<span style="color:#f92672">.</span>iloc[local_min_indices]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>data<span style="color:#f92672">.</span>index[local_min_indices])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>max_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>max_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(local_maxima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_maxima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        current_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>        next_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> next_max <span style="color:#f92672">&gt;</span> current_max:
</span></span><span style="display:flex;"><span>            max_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            max_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 3: Compare successive minima</span>
</span></span><span style="display:flex;"><span>min_comparisons <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(local_minima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_minima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        current_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>        next_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> next_min <span style="color:#f92672">&gt;</span> current_min:
</span></span><span style="display:flex;"><span>            min_comparisons<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Min at index </span><span style="color:#e6db74">{</span>local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> is larger.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            min_comparisons<span style="color:#f92672">.</span>append(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Min at index </span><span style="color:#e6db74">{</span>local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> is smaller.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 4: Display results</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Maxima Comparisons:&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(max_comparisons))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Minima Comparisons:&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(min_comparisons))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 5: Visualize results</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(data, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Stock Prices&#39;</span>, marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;o&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>scatter(local_maxima<span style="color:#f92672">.</span>index, local_maxima, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Local Maxima&#39;</span>, zorder<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>scatter(local_minima<span style="color:#f92672">.</span>index, local_minima, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;green&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Local Minima&#39;</span>, zorder<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Stock Prices with Local Extrema&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><pre><code>Maxima Comparisons:



---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

Cell In[285], line 43
     41 # Step 4: Display results
     42 print(&quot;Maxima Comparisons:&quot;)
---&gt; 43 print(&quot;\n&quot;.join(max_comparisons))
     45 print(&quot;\nMinima Comparisons:&quot;)
     46 print(&quot;\n&quot;.join(min_comparisons))


NameError: name 'max_comparisons' is not defined
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>max_comparisons_smaller_idx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>local_max_indices
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>local_maxima
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.signal <span style="color:#f92672">import</span> argrelextrema
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local_max_indices <span style="color:#f92672">=</span> argrelextrema(sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>local_min_indices <span style="color:#f92672">=</span> argrelextrema(sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(sub<span style="color:#f92672">.</span>loc[local_max_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(sub<span style="color:#f92672">.</span>loc[local_min_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>max_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>max_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(local_maxima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_maxima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        current_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>        next_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> next_max <span style="color:#f92672">&gt;</span> current_max:
</span></span><span style="display:flex;"><span>            max_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            max_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema</span>(df):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    max_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    max_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_maxima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_maxima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_max <span style="color:#f92672">&gt;</span> current_max:
</span></span><span style="display:flex;"><span>                max_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                max_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_smaller_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> local_maxima
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> groupby_extrema(sub)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:25: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df['max_comparisons_larger'] = None
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:29: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df['max_comparisons_larger'] = df['max_comparisons_larger'].shift(window)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:31: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df.loc[max_comparisons_larger_idx, 'local_maxima'] = local_maxima
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:33: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df['local_maxima'] = df['local_maxima'].shift(window)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>local_maxima
</span></span></code></pre></div><pre><code>31        15.45
48        16.57
124       22.98
174       26.50
187       26.31
         ...   
5129     545.98
5151     574.46
5242     813.21
5305    1075.19
5384    1090.00
Length: 133, dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[max_comparisons_smaller_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2369469126.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['max_comparisons_larger'] = None
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2369469126.py:4: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  sub['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2369469126.py:4: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  sub['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2369469126.py:4: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2369469126.py:5: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['max_comparisons_larger'] = sub['max_comparisons_larger'].shift(window)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> local_maxima
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/3881827340.py:2: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  sub['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/3881827340.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['local_maxima'].ffill(inplace=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(groupby_extrema)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:28: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/2416033270.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/3881079495.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(groupby_extrema)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;8069&#39;</span>]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() 
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean())
</span></span></code></pre></div><pre><code>      hold_5Days_ret  hold_10Days_ret  hold_20Days_ret  hold_60Days_ret  \
股票代號                                                                      
2059        0.013785         0.031944         0.054659         0.029903   
2330        0.003559         0.006922         0.008594         0.011781   
2383        0.000973         0.002176         0.001889        -0.022385   
2454       -0.005250        -0.007598        -0.008038         0.037411   
3008        0.004929         0.010483         0.016240        -0.038964   
3529       -0.001352        -0.008921        -0.010620         0.015845   
3533       -0.006262        -0.013777        -0.041594        -0.033368   
5274       -0.008266        -0.005330        -0.020771        -0.070566   
8069        0.001683         0.003531        -0.000550        -0.000319   

      hold_120Days_ret  
股票代號                    
2059         -0.023299  
2330          0.006901  
2383         -0.001887  
2454          0.045153  
3008         -0.041388  
3529          0.008041  
3533         -0.011141  
5274         -0.109092  
8069          0.167833  
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.df&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[(sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>sub[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_by_timeframe</span>(data, date_col, n_splits):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Splits time series data into equal time-based chunks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        data (pd.DataFrame): Time series data.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        date_col (str): Column name containing datetime values.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        n_splits (int): Number of splits.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        list: A list of dataframes, each corresponding to a split.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Ensure datetime format</span>
</span></span><span style="display:flex;"><span>    data[date_col] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(data[date_col])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Sort by date</span>
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span>date_col)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Compute timeframe boundaries</span>
</span></span><span style="display:flex;"><span>    start_date <span style="color:#f92672">=</span> data[date_col]<span style="color:#f92672">.</span>min()
</span></span><span style="display:flex;"><span>    end_date <span style="color:#f92672">=</span> data[date_col]<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span>    timeframe <span style="color:#f92672">=</span> (end_date <span style="color:#f92672">-</span> start_date) <span style="color:#f92672">/</span> n_splits
</span></span><span style="display:flex;"><span>    timeframes <span style="color:#f92672">=</span> [start_date <span style="color:#f92672">+</span> i <span style="color:#f92672">*</span> timeframe <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n_splits <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Split data by timeframes</span>
</span></span><span style="display:flex;"><span>    splits <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        data[(data[date_col] <span style="color:#f92672">&gt;=</span> timeframes[i]) <span style="color:#f92672">&amp;</span> (data[date_col] <span style="color:#f92672">&lt;</span> timeframes[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>])]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n_splits)
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> splits
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>splits <span style="color:#f92672">=</span> split_by_timeframe(sub, date_col<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;日期&#39;</span>, n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Print the results</span>
</span></span><span style="display:flex;"><span>split_res <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>, <span style="color:#e6db74">&#39;signal_ret&#39;</span>, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, split <span style="color:#f92672">in</span> enumerate(splits):
</span></span><span style="display:flex;"><span>    date_period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>), split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_ret&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>split_res
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># print(f&#34;Split {i+1}: {len(split)} rows, from {split[&#39;日期&#39;].min()} to {split[&#39;日期&#39;].max()}&#34;)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[sub[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;20030101&#39;</span>)]
</span></span></code></pre></div><h2 id="support">support</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema</span>(df):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    max_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    max_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_maxima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_maxima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_max <span style="color:#f92672">&gt;</span> current_max:
</span></span><span style="display:flex;"><span>                max_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                max_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_smaller_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> local_maxima
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## 反向 股價跌破 local minima 又這個local minima &lt; 上一個 在谷底的感覺</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema_sup</span>(df):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    min_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    min_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_minima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_minima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_min <span style="color:#f92672">&lt;</span> current_min:
</span></span><span style="display:flex;"><span>                min_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                min_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx, <span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_larger_idx, <span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx, <span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> local_minima
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(groupby_extrema)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[(sub[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>sub[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(groupby_extrema_sup)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:31: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/672798835.py:35: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1703/3042435934.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(groupby_extrema_sup).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h2 id="統整組合訊號">統整組合訊號</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>])
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>])
</span></span><span style="display:flex;"><span>mask3 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>mask4 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask1 <span style="color:#f92672">|</span> mask2 <span style="color:#f92672">|</span> mask3 <span style="color:#f92672">|</span> mask4, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask1 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>])
</span></span><span style="display:flex;"><span>mask2 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>])
</span></span><span style="display:flex;"><span>mask3 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>mask4 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>mask5 <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;3529&#39;</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask2 <span style="color:#f92672">|</span> mask3  , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[(price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean() <span style="color:#f92672">-</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.df&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[price_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>loc[(sub[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>sub[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>splits <span style="color:#f92672">=</span> split_by_timeframe(sub, date_col<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;日期&#39;</span>, n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Print the results</span>
</span></span><span style="display:flex;"><span>split_res <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>, <span style="color:#e6db74">&#39;signal_ret&#39;</span>, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, split <span style="color:#f92672">in</span> enumerate(splits):
</span></span><span style="display:flex;"><span>    date_period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>), split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_ret&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>split_res
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()<span style="color:#f92672">.</span>tolist():
</span></span><span style="display:flex;"><span>    splits <span style="color:#f92672">=</span> split_by_timeframe(sub[sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker], date_col<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;日期&#39;</span>, n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Print the results</span>
</span></span><span style="display:flex;"><span>    split_res <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>, <span style="color:#e6db74">&#39;signal_ret&#39;</span>, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, split <span style="color:#f92672">in</span> enumerate(splits):
</span></span><span style="display:flex;"><span>        date_period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>), split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>        split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>        split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>        split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>        split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_ret&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>        split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    print(ticker, <span style="color:#e6db74">&#39;-&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    print(split_res)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># print(f&#34;Split {i+1}: {len(split)} rows, from {split[&#39;日期&#39;].min()} to {split[&#39;日期&#39;].max()}&#34;)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>splits <span style="color:#f92672">=</span> split_by_timeframe(sub[sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>], date_col<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;日期&#39;</span>, n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Print the results</span>
</span></span><span style="display:flex;"><span>split_res <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>, <span style="color:#e6db74">&#39;signal_ret&#39;</span>, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, split <span style="color:#f92672">in</span> enumerate(splits):
</span></span><span style="display:flex;"><span>    date_period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>), split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_ret&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>split_res
</span></span></code></pre></div><h2 id="ma">MA</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">MA</span>(df):
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>, min_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;60MA&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">60</span>, min_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;120MA&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">120</span>, min_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(MA)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">=</span> sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>, min_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;60MA&#39;</span>] <span style="color:#f92672">=</span> sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">60</span>, min_periods<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>)<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><h2 id="直觀的趨勢有抓到-但要避開盤整區間-均線糾結-how">直觀的趨勢有抓到 但要避開盤整區間 均線糾結 how&hellip;</h2>
<p>用rolling 統計過去一段時間 均線交錯的次數<br>
ex: 過去20日均線 均線20MA向上突破 但又跌回60MA以下  -&gt; 或簡單一點講 突破連續一段時間後再進場
避開假突破之類的情況</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">&gt;</span>sub[<span style="color:#e6db74">&#39;60MA&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>sub[<span style="color:#e6db74">&#39;120MA&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>splits <span style="color:#f92672">=</span> split_by_timeframe(sub, date_col<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;日期&#39;</span>, n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Print the results</span>
</span></span><span style="display:flex;"><span>split_res <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>, <span style="color:#e6db74">&#39;signal_ret&#39;</span>, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, split <span style="color:#f92672">in</span> enumerate(splits):
</span></span><span style="display:flex;"><span>    date_period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">~</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>min()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>), split[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>max()<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_datapoints&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_ret&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;benchmark_winrate&#39;</span>] <span style="color:#f92672">=</span> split[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_datapoints&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_ret&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    split_res<span style="color:#f92672">.</span>loc[date_period, <span style="color:#e6db74">&#39;signal_winrate&#39;</span>] <span style="color:#f92672">=</span> split<span style="color:#f92672">.</span>loc[split[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>split_res
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 單ticker</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_series</span>(window):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> (window <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>all() <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;inital_signal&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">&gt;</span>sub[<span style="color:#e6db74">&#39;60MA&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub[&#39;inital_signal2&#39;] = (sub[&#39;收盤價&#39;]&gt;sub[&#39;20MA&#39;]).apply(lambda x : 1 if x else 0)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sub[&#39;signal&#39;] = sub[&#39;inital_signal&#39;] * sub[&#39;inital_signal2&#39;]</span>
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> sub[<span style="color:#e6db74">&#39;inital_signal&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>apply(check_series)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_series</span>(window):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> (window <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>all() <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_series_df</span>(df):
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;combine_signal&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>apply(check_series)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;inital_signal&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">&gt;</span>sub[<span style="color:#e6db74">&#39;60MA&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;inital_signal2&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>sub[<span style="color:#e6db74">&#39;20MA&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;combine_signal&#39;</span>] <span style="color:#f92672">=</span> sub[<span style="color:#e6db74">&#39;inital_signal&#39;</span>] <span style="color:#f92672">*</span> sub[<span style="color:#e6db74">&#39;inital_signal2&#39;</span>]
</span></span><span style="display:flex;"><span>sub <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(check_series_df)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub[(sub[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (sub[<span style="color:#e6db74">&#39;inital_signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) ]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 讓訊號嚴格一些</span>
</span></span><span style="display:flex;"><span>sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> (sub[<span style="color:#e6db74">&#39;20MA&#39;</span>]<span style="color:#f92672">/</span>sub[<span style="color:#e6db74">&#39;60MA&#39;</span>])<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><h2 id="set-signal-後">Set Signal 後&hellip;</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>delay_signal_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># input: df, 需要有signa columns, output : [[trade_data1], [trade_data2], ...] (list中包含多個list)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyError</span>(<span style="color:#e6db74">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span style="display:flex;"><span>    change_indices <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">!=</span> df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>cumsum() 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 只想要group signal==1的事件</span>
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(change_indices[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    com_code <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    delay_signal_dict[com_code] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    delay_days <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    event_list_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    print(com_code, <span style="color:#e6db74">&#39;-&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _, group <span style="color:#f92672">in</span> groups:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        org_signal <span style="color:#f92672">=</span> group<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(org_signal) <span style="color:#f92672">&lt;=</span> delay_days:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 訊號數不足 不會進場</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            print(org_signal[delay_days::])
</span></span><span style="display:flex;"><span>            df<span style="color:#f92672">.</span>loc[com_code] <span style="color:#f92672">+=</span> org_signal[delay_days::]
</span></span><span style="display:flex;"><span>            group<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            group <span style="color:#f92672">=</span> group<span style="color:#f92672">.</span>iloc[delay_days::]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        start_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        end_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        buy_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        sell_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> (sell_price<span style="color:#f92672">/</span>buy_price) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        holding_days <span style="color:#f92672">=</span> len(group)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        event_list <span style="color:#f92672">=</span> [com_code, start_date, end_date, buy_price, sell_price, ret, holding_days]
</span></span><span style="display:flex;"><span>        event_list_all<span style="color:#f92672">.</span>append(event_list)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pd<span style="color:#f92672">.</span>DataFrame(event_list_all)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;買入日期&#39;</span>, <span style="color:#e6db74">&#39;賣出日期&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;持有日期&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_dict <span style="color:#f92672">=</span> vector_backtest(sub)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>delay_signal_dict<span style="color:#f92672">.</span>keys()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_dict
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(res_dict, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;買入日期&#39;</span>, <span style="color:#e6db74">&#39;賣出日期&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;持有日期&#39;</span>] )
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;precision&#39;</span>] <span style="color:#f92672">=</span> res_df[<span style="color:#e6db74">&#39;return&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.00585</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[[<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;precision&#39;</span>,<span style="color:#e6db74">&#39;持有日期&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[[<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;precision&#39;</span>,<span style="color:#e6db74">&#39;持有日期&#39;</span>]]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Plot 不同組合的signal
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>n_rows, n_cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create subplots for each category in a 2x4 grid</span>
</span></span><span style="display:flex;"><span>fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(n_rows, n_cols, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">8</span>), sharex<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Flatten the axes array for easier indexing</span>
</span></span><span style="display:flex;"><span>axes <span style="color:#f92672">=</span> axes<span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, ticker <span style="color:#f92672">in</span> enumerate(SUB_TICKERS):
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> sub[sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker]       
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">331</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># axes[i].set_title(f&#39;{ticker}_0Q 80~100, 4Q 0~20&#39;)</span>
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>ticker<span style="color:#e6db74">}</span><span style="color:#e6db74"> vs price support signal&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;收盤價&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;close price&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> tmp<span style="color:#f92672">.</span>loc[tmp[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Plot vertical lines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> indices:
</span></span><span style="display:flex;"><span>        axes[i]<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>x, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;r&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    axes[i]<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ax2 = axes[i].twinx()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ax2.vlines(sub.loc[sub[&#39;signal&#39;] == 1, &#39;日期_dt&#39;], ymin=0, ymax=1,  label=&#39;signal&#39;, colors=&#39;orange&#39;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ax2.legend()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[res_df[<span style="color:#e6db74">&#39;持有日期&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span>, [<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;precision&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[[<span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;precision&#39;</span>,<span style="color:#e6db74">&#39;持有日期&#39;</span>]]<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> P &gt; support &amp; support &gt; last support&#39;</span><span style="color:#f92672">.</span>format(sub[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>plot(sub[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], sub[<span style="color:#e6db74">&#39;收盤價&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>indices <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>loc[sub[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Plot vertical lines</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> indices:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>x, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;r&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax1<span style="color:#f92672">.</span>legend()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest_ratio</span>(df, trading_record_dict, buyholddays):
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for backtest PnL ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index_count 算目前在該ticker 上累積bet的數量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;ratio&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    signal_idx <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    all_holding_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx <span style="color:#f92672">in</span> signal_idx:
</span></span><span style="display:flex;"><span>        adding_idx <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(idx, idx<span style="color:#f92672">+</span>buyholddays) <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(df)]
</span></span><span style="display:flex;"><span>        all_holding_idx <span style="color:#f92672">+=</span> adding_idx
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    item_counts <span style="color:#f92672">=</span> Counter(all_holding_idx) <span style="color:#75715e"># 計算每個idx 出現的次數 return dict</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;index_count&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>index<span style="color:#f92672">.</span>map(item_counts)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _, row <span style="color:#f92672">in</span> df[df[<span style="color:#e6db74">&#39;index_count&#39;</span>]<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        date <span style="color:#f92672">=</span> row[<span style="color:#e6db74">&#39;日期&#39;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> date <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> trading_record_dict<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        trading_record_dict[date][row[<span style="color:#e6db74">&#39;股票代號&#39;</span>]] <span style="color:#f92672">=</span> row[<span style="color:#e6db74">&#39;index_count&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">final_pnL_ratio</span>(trading_record_dict, actual_signal_dict, buyholddays):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    perfect_ratio_dict <span style="color:#f92672">=</span> {} <span style="color:#75715e"># -&gt; 進backtest </span>
</span></span><span style="display:flex;"><span>    yesterday_sub_dict <span style="color:#f92672">=</span> {} <span style="color:#75715e"># trading_record_dict[上一個交易日]</span>
</span></span><span style="display:flex;"><span>    daily_actual_ratio <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    daily_add_tickers <span style="color:#f92672">=</span> {} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># sub_list = sorted_key[0:300]</span>
</span></span><span style="display:flex;"><span>    sorted_key <span style="color:#f92672">=</span> sorted(trading_record_dict<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, k <span style="color:#f92672">in</span> enumerate(sorted_key):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            yesterday <span style="color:#f92672">=</span> sorted_key[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            yesterday <span style="color:#f92672">=</span> min(sorted_key)
</span></span><span style="display:flex;"><span>        today <span style="color:#f92672">=</span> k
</span></span><span style="display:flex;"><span>        perfect_ratio_dict[today] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len(trading_record_dict[yesterday]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">|</span> len(trading_record_dict[today]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            today_add_ticker <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            today_subtract_ticker <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            today_unchange_ticker <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            today_adjust_ticker <span style="color:#f92672">=</span> [] <span style="color:#75715e"># 連續signal出現次數 &gt; buy&amp;hold 天數 故在today_add_ticker 要增加 同時也要減少 10天前的買入權重</span>
</span></span><span style="display:flex;"><span>            today_del_ticker <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            today_sub_dict <span style="color:#f92672">=</span> trading_record_dict[today]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 1. 今天第一次出現ticker count ++</span>
</span></span><span style="display:flex;"><span>            keys_only_in_today <span style="color:#f92672">=</span> set(today_sub_dict<span style="color:#f92672">.</span>keys()) <span style="color:#f92672">-</span> set(yesterday_sub_dict<span style="color:#f92672">.</span>keys()) <span style="color:#75715e"># return set</span>
</span></span><span style="display:flex;"><span>            today_add_ticker <span style="color:#f92672">+=</span> list(keys_only_in_today)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2. 皆存在 但今天數量 &gt; 昨天</span>
</span></span><span style="display:flex;"><span>            series_today <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(today_sub_dict)
</span></span><span style="display:flex;"><span>            series_yesterday <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(yesterday_sub_dict)
</span></span><span style="display:flex;"><span>            subtraction_result <span style="color:#f92672">=</span> series_today <span style="color:#f92672">-</span> series_yesterday
</span></span><span style="display:flex;"><span>            today_add_ticker <span style="color:#f92672">+=</span> list(subtraction_result[subtraction_result <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2. 皆存在 但今天數量 &lt; 昨天(第一天的buy&amp;hold結束了 但第二天沒有ticker), 減少的比例就要看</span>
</span></span><span style="display:flex;"><span>            today_subtract_ticker <span style="color:#f92672">+=</span> list(subtraction_result[subtraction_result <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 3. unchange 沒有新signal 但舊signal 仍在buy&amp;hold 中  But 如果value = 10 還是要調整 代表第一天signal到期了 但地11天又有</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 錯 ! 在沒經過filter以前是對的 但經過filter以後 訊號會間斷</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            today_unchange_tickers <span style="color:#f92672">=</span> list(subtraction_result[subtraction_result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>index)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> today_unchange_tickers:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (today <span style="color:#f92672">in</span> actual_signal_dict<span style="color:#f92672">.</span>keys()):
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> t <span style="color:#f92672">in</span> actual_signal_dict[today]:
</span></span><span style="display:flex;"><span>                        today_add_ticker <span style="color:#f92672">+=</span> [t]
</span></span><span style="display:flex;"><span>                        today_adjust_ticker <span style="color:#f92672">+=</span> [t]
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        today_unchange_ticker <span style="color:#f92672">+=</span> [t]
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    today_unchange_ticker <span style="color:#f92672">+=</span> [t]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 昨天存在 今天不存在</span>
</span></span><span style="display:flex;"><span>            keys_only_in_yesterday <span style="color:#f92672">=</span> set(yesterday_sub_dict<span style="color:#f92672">.</span>keys()) <span style="color:#f92672">-</span> set(today_sub_dict<span style="color:#f92672">.</span>keys()) <span style="color:#75715e"># return set</span>
</span></span><span style="display:flex;"><span>            today_del_ticker <span style="color:#f92672">+=</span> list(keys_only_in_yesterday)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 權重調整</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (len(today_subtract_ticker) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">|</span> (len(today_adjust_ticker) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) :
</span></span><span style="display:flex;"><span>                before_date <span style="color:#f92672">=</span> sorted_key[i <span style="color:#f92672">-</span> buyholddays] <span style="color:#75715e"># 10 : buy&amp;hold 10 days # using list 是對的</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> before_date <span style="color:#f92672">in</span> daily_actual_ratio<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>                    today_subtract_ratio <span style="color:#f92672">=</span> daily_actual_ratio[before_date]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    today_subtract_ratio <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                today_subtract_ratio <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(today_add_ticker) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                today_add_ratio <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>buyholddays) <span style="color:#f92672">*</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>len(today_add_ticker))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                today_add_ratio <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            daily_actual_ratio[today] <span style="color:#f92672">=</span> today_add_ratio
</span></span><span style="display:flex;"><span>            print(today, today_add_ticker)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> today_add_ticker:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> t <span style="color:#f92672">in</span> yesterday_sub_dict<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>                    perfect_ratio_dict[today][t] <span style="color:#f92672">=</span> perfect_ratio_dict[yesterday][t] <span style="color:#f92672">+</span> today_add_ratio
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    perfect_ratio_dict[today][t] <span style="color:#f92672">=</span> today_add_ratio
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> today_subtract_ticker:
</span></span><span style="display:flex;"><span>                perfect_ratio_dict[today][t] <span style="color:#f92672">=</span> perfect_ratio_dict[yesterday][t] <span style="color:#f92672">-</span> today_subtract_ratio
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> today_adjust_ticker:
</span></span><span style="display:flex;"><span>                perfect_ratio_dict[today][t] <span style="color:#f92672">-=</span> today_subtract_ratio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> today_del_ticker:
</span></span><span style="display:flex;"><span>                perfect_ratio_dict[today][t] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> today_unchange_ticker:
</span></span><span style="display:flex;"><span>                perfect_ratio_dict[today][t] <span style="color:#f92672">=</span> perfect_ratio_dict[yesterday][t]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># # 處理被減過頭</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> perfect_ratio_dict[today]:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> perfect_ratio_dict[today][ticker] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                    perfect_ratio_dict[today][ticker] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            yesterday_sub_dict <span style="color:#f92672">=</span> today_sub_dict
</span></span><span style="display:flex;"><span>            daily_add_tickers[today] <span style="color:#f92672">=</span> today_add_ticker
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> perfect_ratio_dict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>trading_record_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> d <span style="color:#f92672">in</span> price_df[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>unique()<span style="color:#f92672">.</span>tolist():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> d <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;20030101&#39;</span>:
</span></span><span style="display:flex;"><span>        trading_record_dict[d] <span style="color:#f92672">=</span> {}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sub<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># buy&amp;hold til 下週訊號出來</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 週 -&gt; 轉日 故想要buy&amp;hold 20日 只要填15</span>
</span></span><span style="display:flex;"><span>modify_signal_df <span style="color:#f92672">=</span> sub<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, trading_record_dict, <span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>modify_signal_df[(modify_signal_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>trading_record_dict
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tmp_df <span style="color:#f92672">=</span> modify_signal_df<span style="color:#f92672">.</span>loc[modify_signal_df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;日期&#39;</span>)[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>unique()<span style="color:#f92672">.</span>to_frame()
</span></span><span style="display:flex;"><span>actual_signal_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx, row <span style="color:#f92672">in</span> tmp_df<span style="color:#f92672">.</span>iterrows():
</span></span><span style="display:flex;"><span>    actual_signal_dict[idx] <span style="color:#f92672">=</span> row[<span style="color:#e6db74">&#39;股票代號&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trading_dates <span style="color:#f92672">=</span> modify_signal_df[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>unique()<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>keys <span style="color:#f92672">=</span> list(trading_record_dict<span style="color:#f92672">.</span>keys())
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> keys:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> k <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> trading_dates:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">del</span> trading_record_dict[k]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>actual_signal_dict
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>perfect_ratio_dict <span style="color:#f92672">=</span> final_pnL_ratio(trading_record_dict, actual_signal_dict, <span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 全部都延遲一天 &amp; 限制單筆上限20%投組</span>
</span></span><span style="display:flex;"><span>sorted_key <span style="color:#f92672">=</span> sorted(perfect_ratio_dict<span style="color:#f92672">.</span>keys()) 
</span></span><span style="display:flex;"><span>max_date <span style="color:#f92672">=</span> sorted_key[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>final_ratio_dict <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i, date <span style="color:#f92672">in</span> enumerate(sorted_key):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> date <span style="color:#f92672">==</span> max_date:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    tomorrow <span style="color:#f92672">=</span> sorted_key[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    sub <span style="color:#f92672">=</span> perfect_ratio_dict[date]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> sub: <span style="color:#75715e"># dict not empty</span>
</span></span><span style="display:flex;"><span>        final_ratio_dict[tomorrow] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> sub<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if sub[s] &gt; 0.2:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#     sub[s] = 0.2</span>
</span></span><span style="display:flex;"><span>            final_ratio_dict[tomorrow]<span style="color:#f92672">.</span>append(tuple([s, sub[s]]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trading_record_dict_server_version <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> final_ratio_dict<span style="color:#f92672">.</span>items(): 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 修改日期format -&gt; 在server上 因為用ch的cmoney module 日期為datetime dtype</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(k, str):
</span></span><span style="display:flex;"><span>        key_parse <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(\d</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">)(\d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">)(\d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">)&#39;</span>, k)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        key_parse <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(\d</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">)(\d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">)(\d</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">)&#39;</span>, k<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>    modify_keys <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>key_parse[<span style="color:#ae81ff">1</span>]<span style="color:#e6db74">}{</span>key_parse[<span style="color:#ae81ff">2</span>]<span style="color:#e6db74">}{</span>key_parse[<span style="color:#ae81ff">3</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    trading_record_dict_server_version[modify_keys] <span style="color:#f92672">=</span> v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/intermid/test_9t.pkl&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> handle:
</span></span><span style="display:flex;"><span>    pickle<span style="color:#f92672">.</span>dump(trading_record_dict_server_version, handle, protocol<span style="color:#f92672">=</span>pickle<span style="color:#f92672">.</span>DEFAULT_PROTOCOL)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div>
                

                
            </div>
        </div>

    </article>


    </main>

     
    <footer>
        <div class="row">
            <div class="col-full">

                <div class="footer-logo">
                    <a class="footer-site-logo" href="../../"><img src="../../images/logo.png" alt="Homepage"></a>
                </div>

                <ul class="footer-social">
                    <li><a href="#0">
                        <i class="im im-facebook" aria-hidden="true"></i>
                        <span>Facebook</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-twitter" aria-hidden="true"></i>
                        <span>Twitter</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-instagram" aria-hidden="true"></i>
                        <span>Instagram</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-behance" aria-hidden="true"></i>
                        <span>Behance</span>
                    </a></li>
                    <li><a href="#0">
                        <i class="im im-pinterest" aria-hidden="true"></i>
                        <span>Pinterest</span>
                    </a></li>
                </ul>
                    
            </div>
        </div>

        <div class="row footer-bottom">

            <div class="col-twelve">
                <div class="copyright">
                    <span>© Copyright Hola 2017</span> 
                    <span>Design by <a href="https://www.styleshout.com/">styleshout</a></span>	
                </div>

                <div class="go-top">
                <a class="smoothscroll" title="Back to Top" href="#top"><i class="im im-arrow-up" aria-hidden="true"></i></a>
                </div>
            </div>

        </div> 

    </footer> 
   


    
    <div aria-hidden="true" class="pswp" role="dialog" tabindex="-1">

        <div class="pswp__bg"></div>
        <div class="pswp__scroll-wrap">

            <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
            </div>

            <div class="pswp__ui pswp__ui--hidden">
                <div class="pswp__top-bar">
                    <div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button> <button class="pswp__button pswp__button--share" title=
                    "Share"></button> <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button> <button class="pswp__button pswp__button--zoom" title=
                    "Zoom in/out"></button>
                    <div class="pswp__preloader">
                        <div class="pswp__preloader__icn">
                            <div class="pswp__preloader__cut">
                                <div class="pswp__preloader__donut"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                    <div class="pswp__share-tooltip"></div>
                </div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button> <button class="pswp__button pswp__button--arrow--right" title=
                "Next (arrow right)"></button>
                <div class="pswp__caption">
                    <div class="pswp__caption__center"></div>
                </div>
            </div>

        </div>

    </div>

    <div id="preloader">
        <div id="loader"></div>
    </div>


    
    

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/plugins.js"></script>
    <script src="../../js/main.js"></script>


</body>

</html>