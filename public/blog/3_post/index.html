<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>3.The 10 Golden Rules of Clean Simple Design - Hola</title>
    <meta name="description" content="Vestibulum ac diam sit amet quam vehicula elementum sed sit amet dui. Pellentesque in ipsum id orci porta dapibus.">
    <meta name="author" content="">

    <link rel="stylesheet" href="../../hugoSite/css/base.css">
    <link rel="stylesheet" href="../../hugoSite/css/vendor.css">
    <link rel="stylesheet" href="../../hugoSite/css/main.css">

    <script src="../../hugoSite/js/modernizr.js"></script>
    <script src="../../hugoSite/js/pace.min.js"></script>
    <link rel="shortcut icon" href="../../hugoSite/favicon.ico" type="image/x-icon">
    <link rel="icon" href="../../hugoSite/favicon.ico" type="image/x-icon">
</head>

<body id="top">

    <header class="s-header">
        <div class="header-logo">
            <a class="site-logo" href="../../"><img src="../../hugoSite/images/logo.png" alt="Homepage"></a>
        </div>

        <nav class="header-nav-wrap">
            <ul class="header-nav">
                <li><a href="../../" title="Home">Home</a></li>
                <li><a href="../../about" title="About">About</a></li>
                <li><a href="../../works" title="Works">Works</a></li>
                <li class="current"><a href="../../blog" title="Blog">Blog</a></li>
                <li><a href="../../contact" title="Contact">Contact</a></li>	
            </ul>
        </nav>

        <a class="header-menu-toggle" href="#0"><span>Menu</span></a>
    </header>

    <article class="blog-single">

        <div class="page-header page-header--single page-hero" style="background-image:url(images/blog/blog-bg-02.jpg)">
            <div class="row page-header__content narrow">
                <article class="col-full">
                    <div class="page-header__info">
                        <div class="page-header__cat">
                            <a href="../../categories">Branding</a><a href="../../categories">Design</a>
                        </div>
                    </div>
                    <h1 class="page-header__title">
                        3.The 10 Golden Rules of Clean Simple Design
                    </h1>
                    <ul class="page-header__meta">
                        <li class="date">September 16, 2017</li>
                        <li class="author">
                            By <span></span>
                        </li>
                    </ul>
                </article>
            </div>
        </div>

        <div class="row blog-content">
            <div class="col-full blog-content__main">
                <p>Your post content here&hellip;</p>
<blockquote>
<h2 id="筆記">筆記</h2></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pd<span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>display<span style="color:#f92672">.</span>float_format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>SUB_TICKERS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;2059&#39;</span>, <span style="color:#e6db74">&#39;3529&#39;</span>, <span style="color:#e6db74">&#39;2383&#39;</span>, <span style="color:#e6db74">&#39;2330&#39;</span>, <span style="color:#e6db74">&#39;8069&#39;</span>, <span style="color:#e6db74">&#39;5274&#39;</span>, <span style="color:#e6db74">&#39;3008&#39;</span>, <span style="color:#e6db74">&#39;2454&#39;</span>, <span style="color:#e6db74">&#39;3533&#39;</span>]
</span></span></code></pre></div><h2 id="月營收">月營收</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mon_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/monthly/monthly_revenue.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mon_df <span style="color:#f92672">=</span> mon_df[mon_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span><span style="display:flex;"><span>mon_df <span style="color:#f92672">=</span> mon_df[<span style="color:#f92672">~</span>mon_df[<span style="color:#e6db74">&#39;公告日&#39;</span>]<span style="color:#f92672">.</span>isna()]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mon_df[<span style="color:#e6db74">&#39;公告日_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(mon_df[<span style="color:#e6db74">&#39;公告日&#39;</span>])
</span></span><span style="display:flex;"><span>mon_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;公告日_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>mon_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="收盤價">收盤價</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/org_price.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050 <span style="color:#f92672">=</span> price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;0050&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price0050[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>price0050<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price0050<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1320320034.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050['日期_dt'] = pd.to_datetime(price0050['日期'])
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1320320034.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050.sort_values('日期_dt', inplace=True, ascending=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price_df[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期_dt&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">holding_nDays</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span>n) <span style="color:#f92672">/</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#75715e"># 實際上隔日才能操作</span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;last_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>shift(n <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>) <span style="color:#75715e"># 實際上隔日才能操作</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>n<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(holding_nDays)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/392270890.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price0050 <span style="color:#f92672">=</span> price0050<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(holding_nDays)<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2395123834.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price0050 = price0050.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(price0050, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>]), suffixes<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;_0050&#39;</span>))
</span></span></code></pre></div><h2 id="融資">融資</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>margin_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/dayMarginTrading.ftr&#39;</span>, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;資餘&#39;</span>, <span style="color:#e6db74">&#39;券餘&#39;</span>, <span style="color:#e6db74">&#39;券資比&#39;</span>, <span style="color:#e6db74">&#39;當沖比率&#39;</span>, <span style="color:#e6db74">&#39;融資成本(推估)&#39;</span>, <span style="color:#e6db74">&#39;融券成本(推估)&#39;</span>, <span style="color:#e6db74">&#39;融資維持率(%)&#39;</span>, <span style="color:#e6db74">&#39;融券維持率(%)&#39;</span>,<span style="color:#e6db74">&#39;整體維持率(%)&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(margin_df, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>] <span style="color:#f92672">=</span> ((price_df[<span style="color:#e6db74">&#39;融資維持率(%)&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.6</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">100</span>) <span style="color:#f92672">/</span><span style="color:#ae81ff">100</span>
</span></span></code></pre></div><h2 id="週集保">週集保</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/weeklyDepository.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie <span style="color:#f92672">=</span> weekly_depostie[weekly_depostie[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>weekly_depostie<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;日期&#39;</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>weekly_depostie<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg <span style="color:#f92672">=</span> weekly_depostie[weekly_depostie[<span style="color:#e6db74">&#39;持股分級&#39;</span>]<span style="color:#f92672">.</span>isin([<span style="color:#e6db74">&#39;0400001-0600000&#39;</span>, <span style="color:#e6db74">&#39;0600001-0800000&#39;</span>, <span style="color:#e6db74">&#39;0800001-1000000&#39;</span>, <span style="color:#e6db74">&#39;1000001以上&#39;</span>])]<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>to_frame()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> company_event[company_event[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>isin(SUB_TICKERS)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>date_pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;^\d</span><span style="color:#e6db74">{8}</span><span style="color:#e6db74">$&#39;</span>
</span></span><span style="display:flex;"><span>company_event <span style="color:#f92672">=</span> company_event[company_event[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(date_pattern)]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(company_event[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;friday_of_week&#39;</span>] <span style="color:#f92672">=</span> company_event[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">+</span> pd<span style="color:#f92672">.</span>offsets<span style="color:#f92672">.</span>Week(weekday<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>company_event[<span style="color:#e6db74">&#39;adjust_week&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>company_event<span style="color:#f92672">.</span>loc[(company_event[<span style="color:#e6db74">&#39;新股上市&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) <span style="color:#f92672">|</span> (company_event[<span style="color:#e6db74">&#39;減資前&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#39;adjust_week&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(agg[<span style="color:#e6db74">&#39;日期&#39;</span>])
</span></span><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;year&#39;</span>] <span style="color:#f92672">=</span> agg[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保月線&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保半年線&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保diff&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;佔集保庫存數比例(%)&#39;</span>]<span style="color:#f92672">.</span>diff()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>merge(company_event<span style="color:#f92672">.</span>loc[company_event[<span style="color:#e6db74">&#39;adjust_week&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, [<span style="color:#e6db74">&#39;friday_of_week&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;減資前&#39;</span>, <span style="color:#e6db74">&#39;新股上市&#39;</span>, <span style="color:#e6db74">&#39;adjust_week&#39;</span>]], how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期_dt&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;friday_of_week&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 有股數異動 當周週集保diff -&gt; 0</span>
</span></span><span style="display:flex;"><span>agg<span style="color:#f92672">.</span>loc[agg[<span style="color:#e6db74">&#39;adjust_week&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;週集保diff&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>agg[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>] <span style="color:#f92672">=</span> agg<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;週集保diff&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>merge(agg, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]), right_on<span style="color:#f92672">=</span>([<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>]))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;cut&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>qcut(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>], <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) 
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;signal_count&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>res
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>merge(price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>), how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, left_on<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;股票代號&#39;</span>), right_on<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;股票代號&#39;</span>), suffixes<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;_baseline&#39;</span>))
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;diff_ret&#39;</span>] <span style="color:#f92672">=</span> res[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>] <span style="color:#f92672">-</span> res[<span style="color:#e6db74">&#39;hold_20Days_ret_baseline&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    print(res<span style="color:#f92672">.</span>loc[res[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker, [<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;diff_ret&#39;</span>, <span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>, <span style="color:#e6db74">&#39;signal_count&#39;</span>]])
</span></span></code></pre></div><pre><code>                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
0      (-7.381, -0.0403]  2059    0.0074               0.5253           297
9     (-0.0403, -0.0209]  2059   -0.0003               0.5539           612
18    (-0.0209, -0.0112]  2059   -0.0105               0.5278           612
27   (-0.0112, -0.00457]  2059    0.0055               0.6105           493
36  (-0.00457, 0.000588]  2059   -0.0055               0.5302           464
45    (0.000588, 0.0064]  2059   -0.0165               0.5211           474
54      (0.0064, 0.0132]  2059   -0.0066               0.5511           470
63      (0.0132, 0.0236]  2059    0.0048               0.5630           579
72      (0.0236, 0.0459]  2059    0.0154               0.4592           368
81       (0.0459, 6.477]  2059   -0.0042               0.4848           330
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
5      (-7.381, -0.0403]  3529    0.0076               0.5681           639
14    (-0.0403, -0.0209]  3529    0.0057               0.5977           430
23    (-0.0209, -0.0112]  3529    0.0197               0.6016           251
32   (-0.0112, -0.00457]  3529   -0.0115               0.4541           185
41  (-0.00457, 0.000588]  3529   -0.0182               0.4237           118
50    (0.000588, 0.0064]  3529    0.0286               0.5524           105
59      (0.0064, 0.0132]  3529    0.0080               0.5088           114
68      (0.0132, 0.0236]  3529    0.0233               0.6364           132
77      (0.0236, 0.0459]  3529   -0.0101               0.5516           368
86       (0.0459, 6.477]  3529   -0.0001               0.5152           924
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
2      (-7.381, -0.0403]  2383   -0.0163               0.5163           337
11    (-0.0403, -0.0209]  2383   -0.0155               0.6022           450
20    (-0.0209, -0.0112]  2383    0.0208               0.5992           509
29   (-0.0112, -0.00457]  2383    0.0109               0.6031           456
38  (-0.00457, 0.000588]  2383   -0.0056               0.5408           845
47    (0.000588, 0.0064]  2383    0.0085               0.5935           866
56      (0.0064, 0.0132]  2383    0.0112               0.5605           860
65      (0.0132, 0.0236]  2383   -0.0099               0.4559           601
74      (0.0236, 0.0459]  2383    0.0042               0.4363           314
83       (0.0459, 6.477]  2383    0.0311               0.5296           287
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
1      (-7.381, -0.0403]  2330   -0.0388               0.4315           788
10    (-0.0403, -0.0209]  2330    0.0045               0.5472           424
19    (-0.0209, -0.0112]  2330   -0.0026               0.5797           364
28   (-0.0112, -0.00457]  2330    0.0076               0.6842           741
37  (-0.00457, 0.000588]  2330   -0.0034               0.6103           839
46    (0.000588, 0.0064]  2330   -0.0058               0.5833           768
55      (0.0064, 0.0132]  2330   -0.0045               0.6129           824
64      (0.0132, 0.0236]  2330    0.0027               0.6062           617
73      (0.0236, 0.0459]  2330    0.0221               0.6621           441
82       (0.0459, 6.477]  2330   -0.0033               0.5289           484
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
8      (-7.381, -0.0403]  8069   -0.0083               0.4898           786
17    (-0.0403, -0.0209]  8069    0.0377               0.6390           313
26    (-0.0209, -0.0112]  8069    0.0130               0.5763           321
35   (-0.0112, -0.00457]  8069   -0.0059               0.5538           316
44  (-0.00457, 0.000588]  8069    0.0035               0.5430           256
53    (0.000588, 0.0064]  8069   -0.0044               0.5430           291
62      (0.0064, 0.0132]  8069    0.0173               0.6335           352
71      (0.0132, 0.0236]  8069    0.0035               0.5276           381
80      (0.0236, 0.0459]  8069   -0.0176               0.4596           594
89       (0.0459, 6.477]  8069   -0.0020               0.5591           744
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
7      (-7.381, -0.0403]  5274    0.0202               0.6256           438
16    (-0.0403, -0.0209]  5274   -0.0428               0.5028           179
25    (-0.0209, -0.0112]  5274   -0.0071               0.6331           169
34   (-0.0112, -0.00457]  5274    0.0072               0.6823           192
43  (-0.00457, 0.000588]  5274    0.0079               0.6508           126
52    (0.000588, 0.0064]  5274    0.0453               0.7287           129
61      (0.0064, 0.0132]  5274    0.0348               0.7063           160
70      (0.0132, 0.0236]  5274    0.0197               0.6702           188
79      (0.0236, 0.0459]  5274    0.0036               0.6394           416
88       (0.0459, 6.477]  5274   -0.0205               0.5478           712
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
4      (-7.381, -0.0403]  3008    0.0105               0.4967           449
13    (-0.0403, -0.0209]  3008    0.0191               0.6574           788
22    (-0.0209, -0.0112]  3008    0.0128               0.6181           720
31   (-0.0112, -0.00457]  3008    0.0030               0.5690           652
40  (-0.00457, 0.000588]  3008   -0.0275               0.4177           565
49    (0.000588, 0.0064]  3008   -0.0320               0.3731           453
58      (0.0064, 0.0132]  3008   -0.0063               0.4907           377
67      (0.0132, 0.0236]  3008    0.0032               0.5278           485
76      (0.0236, 0.0459]  3008   -0.0048               0.5455           627
85       (0.0459, 6.477]  3008    0.0236               0.5260           365
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
3      (-7.381, -0.0403]  2454   -0.0014               0.5589           433
12    (-0.0403, -0.0209]  2454   -0.0161               0.4977           663
21    (-0.0209, -0.0112]  2454    0.0020               0.6016           728
30   (-0.0112, -0.00457]  2454   -0.0285               0.4292           643
39  (-0.00457, 0.000588]  2454    0.0040               0.5687           466
48    (0.000588, 0.0064]  2454    0.0165               0.6183           503
57      (0.0064, 0.0132]  2454   -0.0053               0.5879           512
66      (0.0132, 0.0236]  2454    0.0106               0.6314           681
75      (0.0236, 0.0459]  2454   -0.0067               0.5551           726
84       (0.0459, 6.477]  2454   -0.0048               0.5616           276
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
6      (-7.381, -0.0403]  3533   -0.0589               0.2222            36
15    (-0.0403, -0.0209]  3533    0.0147               0.6366           344
24    (-0.0209, -0.0112]  3533    0.0306               0.6929           521
33   (-0.0112, -0.00457]  3533   -0.0040               0.5455           528
42  (-0.00457, 0.000588]  3533   -0.0483               0.3852           527
51    (0.000588, 0.0064]  3533   -0.0313               0.4356           606
60      (0.0064, 0.0132]  3533    0.0060               0.5898           529
69      (0.0132, 0.0236]  3533    0.0259               0.6311           534
78      (0.0236, 0.0459]  3533    0.0143               0.4725           345
87       (0.0459, 6.477]  3533    0.1118               0.8333            78
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample data</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;date&#39;</span>: pd<span style="color:#f92672">.</span>date_range(start<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2025-01-01&#39;</span>, periods<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>),  <span style="color:#75715e"># 20 consecutive dates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;value&#39;</span>: [i <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>)]  <span style="color:#75715e"># Example values (can be any time series data)</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert to a DataFrame</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert date to numeric (e.g., number of days since the first date)</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;date&#39;</span>] <span style="color:#f92672">-</span> df[<span style="color:#e6db74">&#39;date&#39;</span>]<span style="color:#f92672">.</span>min())<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>days
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to calculate slope for a window</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_slope</span>(window):
</span></span><span style="display:flex;"><span>    date_numeric <span style="color:#f92672">=</span> window[:, <span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Extract the first column (date_numeric)</span>
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> window[:, <span style="color:#ae81ff">1</span>]         <span style="color:#75715e"># Extract the second column (value)</span>
</span></span><span style="display:flex;"><span>    x_diff <span style="color:#f92672">=</span> date_numeric[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> date_numeric[<span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Time difference</span>
</span></span><span style="display:flex;"><span>    y_diff <span style="color:#f92672">=</span> value[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> value[<span style="color:#ae81ff">0</span>]                <span style="color:#75715e"># Value difference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y_diff <span style="color:#f92672">/</span> x_diff <span style="color:#66d9ef">if</span> x_diff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply rolling window calculation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_slope</span>(df, window_size):
</span></span><span style="display:flex;"><span>    slopes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(df) <span style="color:#f92672">-</span> window_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        window <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i:i <span style="color:#f92672">+</span> window_size][[<span style="color:#e6db74">&#39;date_numeric&#39;</span>, <span style="color:#e6db74">&#39;value&#39;</span>]]<span style="color:#f92672">.</span>to_numpy()
</span></span><span style="display:flex;"><span>        slopes<span style="color:#f92672">.</span>append(calculate_slope(window))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [<span style="color:#66d9ef">None</span>] <span style="color:#f92672">*</span> (window_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> slopes  <span style="color:#75715e"># Fill the start with NaNs for alignment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add slope to the DataFrame</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;slope&#39;</span>] <span style="color:#f92672">=</span> rolling_slope(df, window_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output the result</span>
</span></span><span style="display:flex;"><span>print(df)
</span></span></code></pre></div><pre><code>         date  value  date_numeric   slope
0  2025-01-01      0             0     NaN
1  2025-01-02      1             1     NaN
2  2025-01-03      4             2     NaN
3  2025-01-04      9             3     NaN
4  2025-01-05     16             4  4.0000
5  2025-01-06     25             5  6.0000
6  2025-01-07     36             6  8.0000
7  2025-01-08     49             7 10.0000
8  2025-01-09     64             8 12.0000
9  2025-01-10     81             9 14.0000
10 2025-01-11    100            10 16.0000
11 2025-01-12    121            11 18.0000
12 2025-01-13    144            12 20.0000
13 2025-01-14    169            13 22.0000
14 2025-01-15    196            14 24.0000
15 2025-01-16    225            15 26.0000
16 2025-01-17    256            16 28.0000
17 2025-01-18    289            17 30.0000
18 2025-01-19    324            18 32.0000
19 2025-01-20    361            19 34.0000
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample data</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;date&#39;</span>: pd<span style="color:#f92672">.</span>date_range(start<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2025-01-01&#39;</span>, periods<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>),  <span style="color:#75715e"># 20 consecutive dates</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;value&#39;</span>: [i <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>)]  <span style="color:#75715e"># Example values (can be any time series data)</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert to a DataFrame</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Convert date to numeric (e.g., number of days since the first date)</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;date&#39;</span>] <span style="color:#f92672">-</span> df[<span style="color:#e6db74">&#39;date&#39;</span>]<span style="color:#f92672">.</span>min())<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>days
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to calculate slope for a window</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_slope</span>(window_df):
</span></span><span style="display:flex;"><span>    x_diff <span style="color:#f92672">=</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># Time difference</span>
</span></span><span style="display:flex;"><span>    y_diff <span style="color:#f92672">=</span> window_df[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]               <span style="color:#75715e"># Value difference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y_diff <span style="color:#f92672">/</span> x_diff <span style="color:#66d9ef">if</span> x_diff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply rolling window calculation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_slope</span>(df, window_size):
</span></span><span style="display:flex;"><span>    slopes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(df) <span style="color:#f92672">-</span> window_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        window <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i:i <span style="color:#f92672">+</span> window_size]  <span style="color:#75715e"># Get the rolling window as a DataFrame</span>
</span></span><span style="display:flex;"><span>        slopes<span style="color:#f92672">.</span>append(calculate_slope(window))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [<span style="color:#66d9ef">None</span>] <span style="color:#f92672">*</span> (window_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> slopes  <span style="color:#75715e"># Fill the start with NaNs for alignment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add slope to the DataFrame</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;slope&#39;</span>] <span style="color:#f92672">=</span> rolling_slope(df, window_size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output the result</span>
</span></span><span style="display:flex;"><span>print(df)
</span></span></code></pre></div><pre><code>         date  value  date_numeric   slope
0  2025-01-01      0             0     NaN
1  2025-01-02      1             1     NaN
2  2025-01-03      4             2     NaN
3  2025-01-04      9             3     NaN
4  2025-01-05     16             4  4.0000
5  2025-01-06     25             5  6.0000
6  2025-01-07     36             6  8.0000
7  2025-01-08     49             7 10.0000
8  2025-01-09     64             8 12.0000
9  2025-01-10     81             9 14.0000
10 2025-01-11    100            10 16.0000
11 2025-01-12    121            11 18.0000
12 2025-01-13    144            12 20.0000
13 2025-01-14    169            13 22.0000
14 2025-01-15    196            14 24.0000
15 2025-01-16    225            15 26.0000
16 2025-01-17    256            16 28.0000
17 2025-01-18    289            17 30.0000
18 2025-01-19    324            18 32.0000
19 2025-01-20    361            19 34.0000
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>] <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">-</span> price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>min())<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>days
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>columns
</span></span></code></pre></div><pre><code>Index(['日期', '股票代號', '股票名稱', '開盤價', '最高價', '最低價', '收盤價', '漲跌', '漲幅(%)',
       '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張', '成交量變動(%)', '均張變動(%)',
       '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比', '本益比(近四季)', '週轉率(%)',
       '成交值比重(%)', '漲跌停', 'RTIME', '日期_dt', 'hold_5Days_ret', 'last_5Days_ret',
       'hold_5Days_winrate', 'hold_10Days_ret', 'last_10Days_ret',
       'hold_10Days_winrate', 'hold_20Days_ret', 'last_20Days_ret',
       'hold_20Days_winrate', 'hold_60Days_ret', 'last_60Days_ret',
       'hold_60Days_winrate', 'hold_120Days_ret', 'last_120Days_ret',
       'hold_120Days_winrate', '日期_0050', '股票代號_0050', '股票名稱_0050', '開盤價_0050',
       '最高價_0050', '最低價_0050', '收盤價_0050', '漲跌_0050', '漲幅(%)_0050',
       '振幅(%)_0050', '成交量_0050', '成交筆數_0050', '成交金額(千)_0050', '均張_0050',
       '成交量變動(%)_0050', '均張變動(%)_0050', '股本(百萬)_0050', '總市值(億)_0050',
       '市值比重(%)_0050', '本益比_0050', '股價淨值比_0050', '本益比(近四季)_0050',
       '週轉率(%)_0050', '成交值比重(%)_0050', '漲跌停_0050', 'RTIME_0050',
       'hold_5Days_ret_0050', 'last_5Days_ret_0050', 'hold_5Days_winrate_0050',
       'hold_10Days_ret_0050', 'last_10Days_ret_0050',
       'hold_10Days_winrate_0050', 'hold_20Days_ret_0050',
       'last_20Days_ret_0050', 'hold_20Days_winrate_0050',
       'hold_60Days_ret_0050', 'last_60Days_ret_0050',
       'hold_60Days_winrate_0050', 'hold_120Days_ret_0050',
       'last_120Days_ret_0050', 'hold_120Days_winrate_0050', 'date_numeric'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 120日本益比的切線斜率</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Function to calculate slope for a window</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calculate_slope</span>(window_df):
</span></span><span style="display:flex;"><span>    x_diff <span style="color:#f92672">=</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;date_numeric&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># Time difference</span>
</span></span><span style="display:flex;"><span>    y_diff <span style="color:#f92672">=</span> (window_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> window_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>] )<span style="color:#f92672">/</span> window_df[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]            <span style="color:#75715e"># Value difference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y_diff <span style="color:#f92672">/</span> x_diff <span style="color:#66d9ef">if</span> x_diff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Apply rolling window calculation</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rolling_slope</span>(df, window_size):
</span></span><span style="display:flex;"><span>    slopes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(df) <span style="color:#f92672">-</span> window_size <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        window <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i:i <span style="color:#f92672">+</span> window_size]  <span style="color:#75715e"># Get the rolling window as a DataFrame</span>
</span></span><span style="display:flex;"><span>        slopes<span style="color:#f92672">.</span>append(calculate_slope(window))
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>window_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> [<span style="color:#66d9ef">None</span>] <span style="color:#f92672">*</span> (window_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> slopes  <span style="color:#75715e"># Fill the start with NaNs for alignment</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>window_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>window_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># 本益比用今天的收盤價去計算 明天才知道result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add slope to the DataFrame</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># price_df[&#39;slope&#39;] = rolling_slope(price_df, window_size=5)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>    price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : rolling_slope(df, window_size<span style="color:#f92672">=</span>w))<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>, [<span style="color:#e6db74">&#39;日期&#39;</span>,<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>, <span style="color:#e6db74">&#39;slope_5&#39;</span>, <span style="color:#e6db74">&#39;date_numeric&#39;</span>]]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>::]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>((<span style="color:#ae81ff">25.6</span><span style="color:#f92672">-</span><span style="color:#ae81ff">29.5</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">29.5</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">5</span>
</span></span></code></pre></div><pre><code>-0.026440677966101684
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>rolling(j)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>rolling(j)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ret_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_ret&#39;</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span><span style="display:flex;"><span>winrate_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;hold_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">Days_winrate&#39;</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">120</span>]:
</span></span><span style="display:flex;"><span>        print(price_df<span style="color:#f92672">.</span>loc[price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>, ret_cols]<span style="color:#f92672">.</span>mean())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># price_df.groupby(&#39;股票代號&#39;).apply(lambda df : rolling_slope(df, window_size=5))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]
</span></span><span style="display:flex;"><span>    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>    ax1 <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>    tmp[<span style="color:#e6db74">&#39;本益比(近四季)_rolling5&#39;</span>] <span style="color:#f92672">=</span> tmp[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;本益比(近四季)_rolling5&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;PE&#39;</span>)
</span></span><span style="display:flex;"><span>    ax2 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>],color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;green&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;PE slope&#39;</span>)
</span></span><span style="display:flex;"><span>    ax3 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
</span></span><span style="display:flex;"><span>    ax3<span style="color:#f92672">.</span>plot(tmp[<span style="color:#e6db74">&#39;日期_dt&#39;</span>], tmp[<span style="color:#e6db74">&#39;收盤價&#39;</span>],color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;orange&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;price&#39;</span>)
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>set_title(ticker)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> tmp<span style="color:#f92672">.</span>loc[(tmp[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.02</span>), <span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Plot vertical lines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> indices:
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>axvline(x<span style="color:#f92672">=</span>x, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;r&#39;</span>, linestyle<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--&#39;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.4</span>)
</span></span><span style="display:flex;"><span>    ax1<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    ax2<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest</span>(df):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># input: df, 需要有signa columns, output : [[trade_data1], [trade_data2], ...] (list中包含多個list)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> all(col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;收盤價&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">KeyError</span>(<span style="color:#e6db74">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span style="display:flex;"><span>    change_indices <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">!=</span> df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>cumsum() 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 只想要group signal==1的事件</span>
</span></span><span style="display:flex;"><span>    groups <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>groupby(change_indices[df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    event_list_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _, group <span style="color:#f92672">in</span> groups:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        com_code <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        start_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        end_date <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;日期&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        buy_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        sell_price <span style="color:#f92672">=</span> group[<span style="color:#e6db74">&#39;次二日收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">=</span> (sell_price<span style="color:#f92672">/</span>buy_price) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        holding_days <span style="color:#f92672">=</span> len(group)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        event_list <span style="color:#f92672">=</span> [com_code, start_date, end_date, buy_price, sell_price, ret, holding_days]
</span></span><span style="display:flex;"><span>        event_list_all<span style="color:#f92672">.</span>append(event_list)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> event_list_all
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>)
</span></span></code></pre></div><pre><code>slope_60_rolling_60_SUM
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;本益比_rolling5&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">5</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;本益比_rolling20&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;本益比(近四季)&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="看起來本益比切線斜率-累積增加0-對捕捉上升趨勢還不錯">看起來本益比切線斜率 累積增加&gt;0 對捕捉上升趨勢還不錯</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  | (price_df[f&#39;slope_{w}&#39;] &lt; price_df[f&#39;slope_{w}_rolling_{j}&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/312944587.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>] <span style="color:#f92672">&gt;</span> price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>]), ret_cols]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><pre><code>hold_5Days_ret     0.0080
hold_10Days_ret    0.0148
hold_20Days_ret    0.0310
hold_60Days_ret    0.0807
hold_120Days_ret   0.1454
dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;last_20Days_ret_0050&#39;</span>] <span style="color:#f92672">&gt;</span> price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3156983121.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;last_60Days_ret_0050&#39;</span>] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.1</span>) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/95528996.py:5: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>columns[<span style="color:#f92672">-</span><span style="color:#ae81ff">140</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">120</span>]
</span></span></code></pre></div><pre><code>Index(['收盤價', '漲跌', '漲幅(%)', '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張',
       '成交量變動(%)', '均張變動(%)', '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比',
       '本益比(近四季)', '週轉率(%)', '成交值比重(%)', '漲跌停', 'RTIME'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">20</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">60</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;200MA&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>rolling(<span style="color:#ae81ff">200</span>)<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><h2 id="local-minima-maxima">Local Minima, maxima</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.signal <span style="color:#f92672">import</span> argrelextrema
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema</span>(df, col):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    max_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    max_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_maxima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_maxima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_max <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_max <span style="color:#f92672">&gt;</span> current_max:
</span></span><span style="display:flex;"><span>                max_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                max_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_maxima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_smaller_idx, <span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;max_comparisons_larger&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx, <span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> local_maxima<span style="color:#f92672">.</span>loc[max_comparisons_larger_idx]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">## 反向 股價跌破 local minima 又這個local minima &lt; 上一個 在谷底的感覺</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">groupby_extrema_sup</span>(df, col):
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Identify Local Minima and Maxima</span>
</span></span><span style="display:flex;"><span>    window <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#75715e"># Window size for extrema detection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local_max_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>greater, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    local_min_indices <span style="color:#f92672">=</span> argrelextrema(df[col]<span style="color:#f92672">.</span>values, np<span style="color:#f92672">.</span>less, order<span style="color:#f92672">=</span>window)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span style="display:flex;"><span>    local_maxima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_max_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_max_indices)
</span></span><span style="display:flex;"><span>    local_minima <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df<span style="color:#f92672">.</span>loc[local_min_indices, col]<span style="color:#f92672">.</span>values, index<span style="color:#f92672">=</span>local_min_indices)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># print(local_minima)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Step 2: Compare successive maxima</span>
</span></span><span style="display:flex;"><span>    min_comparisons_larger_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    min_comparisons_smaller_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(local_minima) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(local_minima) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            current_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>            next_min <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>iloc[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> next_min <span style="color:#f92672">&lt;</span> current_min:
</span></span><span style="display:flex;"><span>                min_comparisons_smaller_idx<span style="color:#f92672">.</span>append(local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                min_comparisons_larger_idx<span style="color:#f92672">.</span>append(local_minima<span style="color:#f92672">.</span>index[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    print(min_comparisons_smaller_idx)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx, <span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_larger_idx, <span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx, <span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> local_minima<span style="color:#f92672">.</span>loc[min_comparisons_smaller_idx]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>tolist()
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]<span style="color:#f92672">.</span>ffill(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;local_minima&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]<span style="color:#f92672">.</span>shift(window)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema(df, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2373799201.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema_sup(df, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>))
</span></span></code></pre></div><pre><code>[np.int64(647), np.int64(727), np.int64(916), np.int64(1198), np.int64(1314), np.int64(1388), np.int64(1801), np.int64(2151), np.int64(2358), np.int64(2549), np.int64(2999), np.int64(3101), np.int64(3290), np.int64(4081), np.int64(4249), np.int64(4392), np.int64(4752)]
[np.int64(388), np.int64(960), np.int64(1098), np.int64(1504), np.int64(1633), np.int64(1760), np.int64(2227), np.int64(2331), np.int64(2519), np.int64(2642), np.int64(2956), np.int64(3136), np.int64(3325), np.int64(3444), np.int64(3646), np.int64(3675), np.int64(3740), np.int64(4131), np.int64(4369), np.int64(4417), np.int64(4677), np.int64(4757), np.int64(4858), np.int64(4902), np.int64(5019), np.int64(5178), np.int64(5262), np.int64(5381), np.int64(5749), np.int64(6100), np.int64(6562), np.int64(6835), np.int64(6941), np.int64(7077), np.int64(7161)]
[np.int64(799), np.int64(1099), np.int64(2475), np.int64(2879), np.int64(2999), np.int64(3090), np.int64(3347), np.int64(3469), np.int64(3750), np.int64(4090), np.int64(4196), np.int64(4293), np.int64(4472), np.int64(4599), np.int64(4716), np.int64(4844), np.int64(5076), np.int64(5188), np.int64(5317), np.int64(5535), np.int64(5556), np.int64(5818), np.int64(5899), np.int64(6264), np.int64(6430), np.int64(6451), np.int64(6795), np.int64(6893)]
[np.int64(380), np.int64(624), np.int64(749), np.int64(1254), np.int64(1441), np.int64(1629), np.int64(1859), np.int64(2107), np.int64(2236), np.int64(2638), np.int64(2710), np.int64(2894), np.int64(2993), np.int64(3240), np.int64(3541), np.int64(3848), np.int64(4122), np.int64(4240), np.int64(4639), np.int64(4952), np.int64(5171), np.int64(5380), np.int64(5662), np.int64(5684), np.int64(5735)]
[np.int64(345), np.int64(628), np.int64(1091), np.int64(1513), np.int64(1715), np.int64(1910), np.int64(1946), np.int64(2023), np.int64(2086), np.int64(2190), np.int64(2438), np.int64(2813), np.int64(3199), np.int64(3389), np.int64(3426), np.int64(3459), np.int64(3681), np.int64(3819), np.int64(3965), np.int64(4515), np.int64(4766), np.int64(4890), np.int64(5135), np.int64(5230), np.int64(5349), np.int64(5502)]
[np.int64(374), np.int64(465), np.int64(598), np.int64(624), np.int64(1017), np.int64(1173), np.int64(1588), np.int64(1710), np.int64(1939), np.int64(2157), np.int64(2286), np.int64(2761), np.int64(2816), np.int64(3084), np.int64(3111), np.int64(3293)]
[np.int64(653), np.int64(953), np.int64(1046), np.int64(1150), np.int64(1469), np.int64(1596), np.int64(1628), np.int64(1706), np.int64(1826), np.int64(1922), np.int64(2362), np.int64(2518), np.int64(2731), np.int64(3190), np.int64(3637), np.int64(3741), np.int64(3757), np.int64(3873), np.int64(4145)]
[np.int64(318), np.int64(534), np.int64(796), np.int64(1031), np.int64(1068), np.int64(1110), np.int64(1153), np.int64(1328), np.int64(1394), np.int64(1716), np.int64(1835), np.int64(2269)]
[np.int64(765), np.int64(952), np.int64(1659), np.int64(1962), np.int64(2577), np.int64(3066), np.int64(3310), np.int64(3626), np.int64(3773), np.int64(3796), np.int64(3961), np.int64(4354), np.int64(4559), np.int64(4661), np.int64(4841)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3911248321.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema_sup(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema(df, <span style="color:#e6db74">&#39;收盤價&#39;</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2624941152.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, '收盤價'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w, j <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : groupby_extrema_sup(df, <span style="color:#e6db74">&#39;收盤價&#39;</span>))
</span></span></code></pre></div><pre><code>[np.int64(204), np.int64(287), np.int64(387), np.int64(690), np.int64(886), np.int64(1026), np.int64(1259), np.int64(1299), np.int64(1369), np.int64(1471), np.int64(1508), np.int64(1530), np.int64(1583), np.int64(1742), np.int64(2029), np.int64(2081), np.int64(2308), np.int64(2343), np.int64(2501), np.int64(2543), np.int64(2626), np.int64(2713), np.int64(2737), np.int64(2794), np.int64(3012), np.int64(3029), np.int64(3053), np.int64(3107), np.int64(3157), np.int64(3169), np.int64(3267), np.int64(3314), np.int64(3345), np.int64(3420), np.int64(3452), np.int64(3475), np.int64(3494), np.int64(3681), np.int64(3819), np.int64(4028), np.int64(4159), np.int64(4193), np.int64(4316), np.int64(4338), np.int64(4367), np.int64(4410), np.int64(4563), np.int64(4706), np.int64(4746), np.int64(4790)]
[np.int64(40), np.int64(133), np.int64(185), np.int64(258), np.int64(317), np.int64(343), np.int64(386), np.int64(431), np.int64(615), np.int64(904), np.int64(943), np.int64(1029), np.int64(1069), np.int64(1159), np.int64(1224), np.int64(1537), np.int64(1562), np.int64(1646), np.int64(1704), np.int64(1757), np.int64(1797), np.int64(1823), np.int64(1875), np.int64(1896), np.int64(1942), np.int64(2037), np.int64(2083), np.int64(2110), np.int64(2125), np.int64(2149), np.int64(2193), np.int64(2253), np.int64(2277), np.int64(2491), np.int64(2553), np.int64(2592), np.int64(2616), np.int64(2641), np.int64(2704), np.int64(2912), np.int64(2930), np.int64(2948), np.int64(3039), np.int64(3102), np.int64(3284), np.int64(3333), np.int64(3400), np.int64(3470), np.int64(3508), np.int64(3668), np.int64(3695), np.int64(3713), np.int64(3951), np.int64(4018), np.int64(4088), np.int64(4291), np.int64(4359), np.int64(4375), np.int64(4390), np.int64(4593), np.int64(4802), np.int64(4895), np.int64(4960), np.int64(5006), np.int64(5243), np.int64(5336), np.int64(5389), np.int64(5488), np.int64(5564), np.int64(5962), np.int64(6047), np.int64(6086), np.int64(6169), np.int64(6187), np.int64(6219), np.int64(6310), np.int64(6506), np.int64(6636), np.int64(6754), np.int64(6786), np.int64(6856), np.int64(6991), np.int64(7030), np.int64(7068), np.int64(7145), np.int64(7262), np.int64(7367), np.int64(7573)]
[np.int64(96), np.int64(147), np.int64(203), np.int64(240), np.int64(401), np.int64(468), np.int64(587), np.int64(715), np.int64(789), np.int64(1042), np.int64(1190), np.int64(1235), np.int64(1283), np.int64(1432), np.int64(1463), np.int64(1489), np.int64(1530), np.int64(1632), np.int64(1646), np.int64(1669), np.int64(1894), np.int64(1986), np.int64(2041), np.int64(2101), np.int64(2167), np.int64(2263), np.int64(2449), np.int64(2622), np.int64(2822), np.int64(2847), np.int64(2976), np.int64(3006), np.int64(3078), np.int64(3287), np.int64(3307), np.int64(3349), np.int64(3437), np.int64(3543), np.int64(3629), np.int64(3673), np.int64(3693), np.int64(3710), np.int64(3737), np.int64(3820), np.int64(3890), np.int64(4051), np.int64(4140), np.int64(4164), np.int64(4193), np.int64(4274), np.int64(4496), np.int64(4577), np.int64(4681), np.int64(4806), np.int64(4827), np.int64(5003), np.int64(5026), np.int64(5273), np.int64(5294), np.int64(5333), np.int64(5387), np.int64(5430), np.int64(5477), np.int64(5508), np.int64(5742), np.int64(5760), np.int64(5812), np.int64(5844), np.int64(5999), np.int64(6123), np.int64(6411), np.int64(6484), np.int64(6574), np.int64(6600), np.int64(6702), np.int64(6727), np.int64(6777), np.int64(6840), np.int64(6911)]
[np.int64(215), np.int64(229), np.int64(247), np.int64(390), np.int64(584), np.int64(692), np.int64(789), np.int64(833), np.int64(875), np.int64(1018), np.int64(1058), np.int64(1121), np.int64(1136), np.int64(1196), np.int64(1216), np.int64(1234), np.int64(1317), np.int64(1588), np.int64(1622), np.int64(1729), np.int64(1818), np.int64(1829), np.int64(2054), np.int64(2120), np.int64(2193), np.int64(2220), np.int64(2295), np.int64(2394), np.int64(2421), np.int64(2459), np.int64(2476), np.int64(2493), np.int64(2673), np.int64(2817), np.int64(2850), np.int64(2959), np.int64(3232), np.int64(3282), np.int64(3419), np.int64(3494), np.int64(3594), np.int64(3608), np.int64(3664), np.int64(3754), np.int64(3793), np.int64(3845), np.int64(4071), np.int64(4196), np.int64(4214), np.int64(4229), np.int64(4275), np.int64(4324), np.int64(4611), np.int64(4961), np.int64(4997), np.int64(5096), np.int64(5125), np.int64(5173), np.int64(5233), np.int64(5367), np.int64(5429), np.int64(5549), np.int64(5607)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)


[np.int64(86), np.int64(106), np.int64(213), np.int64(429), np.int64(450), np.int64(573), np.int64(592), np.int64(639), np.int64(718), np.int64(1006), np.int64(1066), np.int64(1146), np.int64(1188), np.int64(1217), np.int64(1241), np.int64(1277), np.int64(1472), np.int64(1580), np.int64(1650), np.int64(1679), np.int64(1775), np.int64(1854), np.int64(1965), np.int64(2041), np.int64(2244), np.int64(2354), np.int64(2387), np.int64(2428), np.int64(2507), np.int64(2524), np.int64(2648), np.int64(2708), np.int64(2769), np.int64(2828), np.int64(2868), np.int64(3122), np.int64(3142), np.int64(3332), np.int64(3355), np.int64(3370), np.int64(3423), np.int64(3438), np.int64(3644), np.int64(3742), np.int64(3858), np.int64(3932), np.int64(3950), np.int64(3985), np.int64(4114), np.int64(4136), np.int64(4154), np.int64(4174), np.int64(4271), np.int64(4461), np.int64(4573), np.int64(4602), np.int64(4671), np.int64(4805), np.int64(4847), np.int64(4963), np.int64(4982), np.int64(5085), np.int64(5457), np.int64(5559), np.int64(5594)]
[np.int64(63), np.int64(113), np.int64(163), np.int64(232), np.int64(292), np.int64(338), np.int64(349), np.int64(424), np.int64(436), np.int64(451), np.int64(520), np.int64(531), np.int64(640), np.int64(671), np.int64(1002), np.int64(1117), np.int64(1129), np.int64(1300), np.int64(1344), np.int64(1529), np.int64(1554), np.int64(1632), np.int64(1645), np.int64(1661), np.int64(1738), np.int64(1798), np.int64(1881), np.int64(1923), np.int64(2102), np.int64(2175), np.int64(2214), np.int64(2246), np.int64(2363), np.int64(2593), np.int64(2704), np.int64(2759), np.int64(2812), np.int64(3083), np.int64(3175), np.int64(3245), np.int64(3313)]
[np.int64(123), np.int64(149), np.int64(219), np.int64(260), np.int64(280), np.int64(608), np.int64(637), np.int64(727), np.int64(813), np.int64(894), np.int64(921), np.int64(997), np.int64(1090), np.int64(1115), np.int64(1235), np.int64(1275), np.int64(1370), np.int64(1384), np.int64(1482), np.int64(1502), np.int64(1654), np.int64(1826), np.int64(1838), np.int64(1865), np.int64(1896), np.int64(2014), np.int64(2086), np.int64(2190), np.int64(2208), np.int64(2302), np.int64(2471), np.int64(2513), np.int64(2569), np.int64(2583), np.int64(2681), np.int64(2821), np.int64(2838), np.int64(3028), np.int64(3096), np.int64(3264), np.int64(3308), np.int64(3377), np.int64(3513), np.int64(3590), np.int64(3668), np.int64(3728), np.int64(3814), np.int64(3853), np.int64(3908), np.int64(4095)]
[np.int64(38), np.int64(114), np.int64(255), np.int64(302), np.int64(314), np.int64(335), np.int64(674), np.int64(778), np.int64(922), np.int64(1079), np.int64(1276), np.int64(1310), np.int64(1342), np.int64(1486), np.int64(1781), np.int64(1968), np.int64(2036), np.int64(2161), np.int64(2174), np.int64(2223), np.int64(2255), np.int64(2276), np.int64(2310), np.int64(2328), np.int64(2444), np.int64(2476), np.int64(2498), np.int64(2520), np.int64(2659), np.int64(2826)]
[np.int64(59), np.int64(146), np.int64(176), np.int64(272), np.int64(395), np.int64(475), np.int64(553), np.int64(571), np.int64(659), np.int64(901), np.int64(960), np.int64(1056), np.int64(1080), np.int64(1112), np.int64(1139), np.int64(1491), np.int64(1530), np.int64(1555), np.int64(1733), np.int64(1809), np.int64(1925), np.int64(1940), np.int64(2024), np.int64(2035), np.int64(2156), np.int64(2201), np.int64(2304), np.int64(2334), np.int64(2395), np.int64(2528), np.int64(2578), np.int64(2629), np.int64(2651), np.int64(2763), np.int64(2811), np.int64(2831), np.int64(2908), np.int64(2930), np.int64(3133), np.int64(3285), np.int64(3345), np.int64(3451), np.int64(3500), np.int64(3582), np.int64(3611), np.int64(3837), np.int64(3914), np.int64(3948), np.int64(4087), np.int64(4230), np.int64(4327), np.int64(4414), np.int64(4433), np.int64(4510), np.int64(4587), np.int64(4607), np.int64(4700), np.int64(4783), np.int64(4799), np.int64(4828), np.int64(4944), np.int64(5083)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/785596803.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema_sup(df, '收盤價'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(price_df[<span style="color:#e6db74">&#39;日期&#39;</span>] )
</span></span></code></pre></div><h2 id="strategy-logic">strategy Logic</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 近一個月 400張大戶 增加2%以上</span>
</span></span><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4079245513.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[mask, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/857034293.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &amp; (price_df[&#39;收盤價&#39;]&gt;price_df[&#39;local_maxima&#39;])) | (price_df[&#39;維持率反推融資平均損益&#39;]&lt;-0.1)</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1700805250.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[((price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>])) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/168196673.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;20MA&#39;</span>] <span style="color:#f92672">&gt;=</span> price_df[<span style="color:#e6db74">&#39;200MA&#39;</span>]) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3380416550.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;min_comparisons_smaller&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/939178834.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4128040719.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/357474516.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<h2 id="組合上下行">組合上下行</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>]) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/950731482.py:5: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4128040719.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3623880085.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;min_comparisons_smaller&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1110539843.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3456730543.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>] <span style="color:#f92672">&gt;=</span> price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>]) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.02</span>) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1528418423.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;收盤價&#39;</span>] <span style="color:#f92672">&lt;</span> price_df[<span style="color:#e6db74">&#39;60MA&#39;</span>]) , <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/538384737.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># price_df[price_df[&#39;signal&#39;]==1]</span>
</span></span></code></pre></div><h2 id="now">NOW</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  (price_df[&#39;週集保diff4week&#39;]&gt;0.5)|  (price_df[&#39;維持率反推融資平均損益&#39;]&lt;-0.1)</span>
</span></span><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>loc[((price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.02</span>) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&gt;</span>price_df[<span style="color:#e6db74">&#39;local_maxima&#39;</span>])) <span style="color:#f92672">|</span> (price_df[<span style="color:#e6db74">&#39;週集保diff4week&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>) <span style="color:#f92672">|</span>  (price_df[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;slope_</span><span style="color:#e6db74">{</span>w<span style="color:#e6db74">}</span><span style="color:#e6db74">_rolling_</span><span style="color:#e6db74">{</span>j<span style="color:#e6db74">}</span><span style="color:#e6db74">_SUM&#39;</span>]<span style="color:#f92672">&lt;</span>price_df[<span style="color:#e6db74">&#39;local_minima&#39;</span>]) <span style="color:#f92672">|</span>  (price_df[<span style="color:#e6db74">&#39;維持率反推融資平均損益&#39;</span>]<span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">0.1</span>), <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3722245375.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<h2 id="簡易pnl模擬">簡易PnL模擬</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> res_list:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;訊號開始日&#39;</span>, <span style="color:#e6db74">&#39;訊號結束日&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>])
</span></span><span style="display:flex;"><span>    res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([res_df, tmp], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;return_fee&#39;</span>] <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.00585</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    GOAL <span style="color:#f92672">=</span> (price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>] <span style="color:#f92672">=</span> GOAL
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>empty:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    strategy_pnl <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>values[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>] <span style="color:#f92672">=</span> strategy_pnl
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>] <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">/</span>len(price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)])
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;strategy_pnl&#39;</span>]<span style="color:#f92672">/</span>show_df[<span style="color:#e6db74">&#39;time_in_markets&#39;</span>]
</span></span><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0.8</span>
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(show_df[show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>]<span style="color:#f92672">&gt;</span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>]]<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><pre><code>Index(['2059', '3008'], dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> Counter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">vector_backtest_ratio</span>(df, buyholddays):
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for backtest PnL ratio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    index_count 算目前在該ticker 上累積bet的數量 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;ratio&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    signal_idx <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>index
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    all_holding_idx <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx <span style="color:#f92672">in</span> signal_idx:
</span></span><span style="display:flex;"><span>        adding_idx <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(idx, idx<span style="color:#f92672">+</span>buyholddays) <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(df)]
</span></span><span style="display:flex;"><span>        all_holding_idx <span style="color:#f92672">+=</span> adding_idx
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>loc[all_holding_idx, <span style="color:#e6db74">&#39;signal&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> df
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, <span style="color:#ae81ff">10</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/517245478.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 10))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, <span style="color:#ae81ff">20</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2754594864.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 20))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> df : vector_backtest_ratio(df, <span style="color:#ae81ff">60</span>))
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3282921495.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 60))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_list <span style="color:#f92672">=</span> price_df[(price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;股票代號&#39;</span>)<span style="color:#f92672">.</span>apply(vector_backtest)
</span></span><span style="display:flex;"><span>res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> res_list:
</span></span><span style="display:flex;"><span>    tmp <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(data, columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;訊號開始日&#39;</span>, <span style="color:#e6db74">&#39;訊號結束日&#39;</span>, <span style="color:#e6db74">&#39;買入價格&#39;</span>, <span style="color:#e6db74">&#39;賣出價格&#39;</span>, <span style="color:#e6db74">&#39;return&#39;</span>, <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>])
</span></span><span style="display:flex;"><span>    res_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([res_df, tmp], ignore_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>res_df[<span style="color:#e6db74">&#39;return_fee&#39;</span>] <span style="color:#f92672">=</span> (res_df[<span style="color:#e6db74">&#39;return&#39;</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.00585</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/317971430.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ticker <span style="color:#f92672">in</span> SUB_TICKERS:
</span></span><span style="display:flex;"><span>    GOAL <span style="color:#f92672">=</span> (price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span>price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>), <span style="color:#e6db74">&#39;收盤價&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>] <span style="color:#f92672">=</span> GOAL
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>empty:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    strategy_pnl <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;return_fee&#39;</span>]<span style="color:#f92672">.</span>cumprod()<span style="color:#f92672">.</span>dropna()<span style="color:#f92672">.</span>values[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;strategy_pnl&#39;</span>] <span style="color:#f92672">=</span> strategy_pnl
</span></span><span style="display:flex;"><span>    show_df<span style="color:#f92672">.</span>loc[ticker, <span style="color:#e6db74">&#39;time_in_markets&#39;</span>] <span style="color:#f92672">=</span> res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker), <span style="color:#e6db74">&#39;訊號持續天數&#39;</span>]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">/</span>len(price_df<span style="color:#f92672">.</span>loc[(price_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span>ticker) <span style="color:#f92672">&amp;</span> (price_df[<span style="color:#e6db74">&#39;日期_dt&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#e6db74">&#39;20150101&#39;</span>)])
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;strategy_pnl&#39;</span>]<span style="color:#f92672">/</span>show_df[<span style="color:#e6db74">&#39;time_in_markets&#39;</span>]
</span></span><span style="display:flex;"><span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>] <span style="color:#f92672">=</span> show_df[<span style="color:#e6db74">&#39;ticker_benchmark_pnl&#39;</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">0.8</span>
</span></span><span style="display:flex;"><span>show_df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(show_df[show_df[<span style="color:#e6db74">&#39;perfect_res&#39;</span>]<span style="color:#f92672">&gt;</span>show_df[<span style="color:#e6db74">&#39;0.8_benchmark&#39;</span>]]<span style="color:#f92672">.</span>index)
</span></span></code></pre></div><pre><code>Index(['2330', '8069', '3008'], dtype='object')
</code></pre>
<h2 id="如果是想要抄底的策略-holding-天數可能要拉長到可以等他漲回去">如果是想要抄底的策略 holding 天數可能要拉長到可以等他漲回去</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># price_df.loc[(price_df[&#39;股票代號&#39;]==&#39;2330&#39;) &amp; (price_df[&#39;signal&#39;]==1)].iloc[-20::]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2330&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;3529&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;5274&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ae81ff">1410</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2410</span>
</span></span></code></pre></div><pre><code>0.5850622406639004
</code></pre>
<h2 id="2454-2383-2059-3008-done">2454, 2383, 2059, 3008 done</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>res_df<span style="color:#f92672">.</span>loc[(res_df[<span style="color:#e6db74">&#39;股票代號&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;2383&#39;</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[[<span style="color:#e6db74">&#39;日期&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>, <span style="color:#e6db74">&#39;signal&#39;</span>]<span style="color:#f92672">+</span>ret_cols<span style="color:#f92672">+</span>winrate_cols]<span style="color:#f92672">.</span>to_feather(<span style="color:#e6db74">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.ftr&#39;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2373799201.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>price_df[<span style="color:#e6db74">&#39;cut&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>qcut(price_df[<span style="color:#e6db74">&#39;slope&#39;</span>], <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_ret&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>) 
</span></span><span style="display:flex;"><span>res[<span style="color:#e6db74">&#39;signal_count&#39;</span>] <span style="color:#f92672">=</span> price_df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;cut&#39;</span>, <span style="color:#e6db74">&#39;股票代號&#39;</span>])[<span style="color:#e6db74">&#39;hold_20Days_winrate&#39;</span>]<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>res
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->

                

                
            </div>
        </div>

    </article>

    <footer>
        <div class="row">
            <div class="col-full">
                <div class="footer-logo">
                    <a class="footer-site-logo" href="#0"><img src="../../hugoSite/images/logo.png" alt="Homepage"></a>
                </div>
                <ul class="footer-social">
                    <li><a href="#0"><i class="im im-facebook" aria-hidden="true"></i> Facebook</a></li>
                    <li><a href="#0"><i class="im im-twitter" aria-hidden="true"></i> Twitter</a></li>
                    <li><a href="#0"><i class="im im-instagram" aria-hidden="true"></i> Instagram</a></li>
                </ul>
            </div>
        </div>

        <div class="row footer-bottom">
            <div class="col-twelve">
                <div class="copyright">
                    <span>© Copyright Hola 2017</span>
                    <span>Design by <a href="https://www.styleshout.com/">styleshout</a></span>
                </div>
                <div class="go-top">
                    <a class="smoothscroll" title="Back to Top" href="#top"><i class="im im-arrow-up" aria-hidden="true"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <div id="preloader"> 
        <div id="loader"></div>
    </div>

    <script src="../../hugoSite/js/jquery-3.2.1.min.js"></script>
    <script src="../../hugoSite/js/plugins.js"></script>
    <script src="../../hugoSite/js/main.js"></script>

</body>
</html>
